<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‚ú® Word Master ‚ú®</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --dark-bg: #0a0e27;
            --dark-card: #151937;
            --dark-hover: #1e2451;
            --dark-text: #e4e4e7;
            --dark-text-secondary: #a1a1aa;
        }

        body {
            font-family: 'Noto Sans KR', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #2d1b69;
            min-height: 100vh;
            color: #333;
            overflow-x: hidden;
            position: relative;
        }


        body.dark-mode {
            background: var(--dark-bg);
            color: #fff;
        }

        /* Îã§ÌÅ¨Î™®Îìú Ïä§ÌÉÄÏùº Í∞úÏÑ† */
        .dark-mode .container {
            background: rgba(10, 14, 39, 0.9);
        }

        .dark-mode .header {
            background: rgba(0, 0, 0, 0.5);
        }

        .dark-mode .header::before {
            opacity: 0.3;
        }

        .dark-mode .stats {
            background: rgba(255, 255, 255, 0.05);
        }

        .dark-mode .stat-value {
            background: linear-gradient(45deg, #fff, #ccc);
            -webkit-background-clip: text;          background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .dark-mode .stat-label {
            color: #ddd;
        }

        .dark-mode .tabs {
            background: var(--dark-card);
        }

        .dark-mode .tab {
            color: #888;
        }

        .dark-mode .tab.active {
            color: #fff;
            background: rgba(255, 255, 255, 0.1);
        }

        .dark-mode .main-content {
            background: var(--dark-card);
        }

        .dark-mode .setting-card {
            background: var(--dark-hover);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Îã§ÌÅ¨Î™®Îìú Ï±ïÌÑ∞ Ïπ¥Îìú Í∞úÏÑ† */
        .dark-mode .chapter-card {
            background: #1a1f3a;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .dark-mode .chapter-card.normal {
            background: linear-gradient(135deg, #1a2f1a 0%, #0f1f0f 100%);
            border-color: #2d5a2d;
        }

        .dark-mode .chapter-card.midterm {
            background: linear-gradient(135deg, #2a2a10 0%, #1f1f0a 100%);
            border-color: #5a5a2d;
        }

        .dark-mode .chapter-card.final {
            background: linear-gradient(135deg, #2a1010 0%, #1f0a0a 100%);
            border-color: #5a2d2d;
        }

        .dark-mode .chapter-card.comprehensive {
            background: linear-gradient(135deg, #1a1a2f 0%, #0f0f1f 100%);
            border-color: #2d2d5a;
        }

        .dark-mode .chapter-card.allwords {
            background: linear-gradient(135deg, #2a2a10 0%, #3a3a10 100%);
            border-color: #5a5a2d;
        }

        .dark-mode .chapter-card:hover {
            background: #252d5a;
            border-color: #666;
        }

        .dark-mode .chapter-title {
            color: var(--dark-text);
        }

        .dark-mode .chapter-info {
            color: var(--dark-text-secondary);
        }

        .dark-mode .progress-info {
            color: var(--dark-text-secondary);
        }

        .dark-mode .progress-bar-container {
            background: rgba(255, 255, 255, 0.1);
        }

        .dark-mode h3 {
            color: var(--dark-text);
        }

        .dark-mode .weak-words-section {
            background: var(--dark-hover);
        }

        .dark-mode .weak-word-item {
            background: #1a1f3a;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .dark-mode .weak-word-title {
            color: var(--dark-text);
        }

        .dark-mode .modal-content {
            background: var(--dark-hover);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .dark-mode .study-mode,
        .dark-mode .test-mode {
            background: var(--dark-bg);
        }

        .dark-mode .word-display {
            background: var(--dark-hover);
            color: #fff;
        }

        .dark-mode .question-card {
            background: var(--dark-hover);
            color: #fff;
        }

        .dark-mode .option-btn {
            background: var(--dark-hover);
            color: #fff;
            border-color: #555;
        }

        .dark-mode .option-btn:hover {
            background: #2a3155;
            border-color: #777;
        }

        
        .container {
            max-width: 500px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.98);
            min-height: 100vh;
            position: relative;
            backdrop-filter: blur(20px);
            box-shadow: 0 0 40px rgba(0,0,0,0.3);
        }

        /* Ìó§Îçî Ïä§ÌÉÄÏùº - ÌòÑÎåÄÏ†ÅÏúºÎ°ú Í∞úÏÑ† */
        .header {
            /* 1. ÏÜîÎ¶¨Îìú Ìè¥Î∞± Î∞∞Í≤Ω Î®ºÏ†Ä */
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            color: white;
            padding: 30px 20px 20px;
            text-align: center;
            position: relative;
            overflow: hidden;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        /* 2. backdrop-filterÎäî @supportsÎ°ú Í∞êÏã∏Í∏∞ */
        @supports (backdrop-filter: blur(20px)) or (-webkit-backdrop-filter: blur(20px)) {
            .header {
                background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%);
                backdrop-filter: blur(20px);
                -webkit-backdrop-filter: blur(20px);
            }
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            opacity: 0.9;
            z-index: -1;
        }

        .header h1 {
            font-size: 32px;
            font-weight: 900;
            margin-bottom: 15px;
            text-shadow: 0 2px 10px rgba(0,0,0,0.3);
            position: relative;
            z-index: 1;
            letter-spacing: -0.5px;
            color: #fff;  /* Ìè¥Î∞± Ï∂îÍ∞Ä */
            animation: shimmer 3s ease-in-out infinite;
        }

        @supports (-webkit-background-clip: text) {
            .header h1 {
                background: linear-gradient(to right, #fff 0%, #f0f0f0 50%, #fff 100%);
                background-size: 200% auto;
                -webkit-background-clip: text;
                background-clip: text;
                -webkit-text-fill-color: transparent;
            }
        }

        @keyframes shimmer {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .header .subtitle {
            font-size: 14px;
            opacity: 0.9;
            font-weight: 300;
            letter-spacing: 2px;
            text-transform: uppercase;
        }

        /* Îã®Ïñ¥Ïû• ÏÑ†ÌÉùÍ∏∞ */
        .vocab-selector {
            margin-top: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .vocab-selector-btn {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 8px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .vocab-selector-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .vocab-name {
            max-width: 150px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        /* Ïò®ÎùºÏù∏ Ïπ¥ÌÖåÍ≥†Î¶¨ ÌÉ≠ Ïä§ÌÉÄÏùº - Ï∂îÍ∞Ä */
        .online-category-tabs {
            display: flex;
            flex-direction: column;
            gap: 12px;
            padding: 0 16px 20px;
        }

        .online-category-tab {
            width: 100%;
            padding: 16px 24px;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 15px;
            position: relative;
            overflow: hidden;
            color: white;
            background: #6b7280;
        }

        /* Í∞Å Ïπ¥ÌÖåÍ≥†Î¶¨Î≥Ñ ÏÉâÏÉÅ */
        .online-category-tab[data-category="all"] {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
        }

        .online-category-tab[data-category="toeic"] {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        }

        .online-category-tab[data-category="daily"] {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }

        .online-category-tab[data-category="school"] {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }

        .online-category-tab:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.2);
        }

        .tab-icon {
            font-size: 20px;
        }

        .tab-text {
            font-weight: 600;
            font-size: 15px;
        }
        /* Ïò®ÎùºÏù∏ Îã®Ïñ¥Ïû• ÏïÑÏù¥ÌÖú Ïä§ÌÉÄÏùº */
        .online-vocab-item {
            background: white;
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid #e8e8e8;
            position: relative;
            overflow: hidden;
        }

        /* Îã§Ïö¥Î°úÎìú ÏÉÅÌÉú ÌëúÏãú */
        .download-status {
            position: absolute;
            top: 12px;
            right: 12px;
            background: #10b981;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .online-vocab-item:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 24px rgba(0,0,0,0.15);
        }

        .online-vocab-header {
            margin-bottom: 16px;
        }

        .online-vocab-info-container {
            flex: 1;
        }

        .online-vocab-title {
            font-size: 18px;
            font-weight: 700;
            color: #1a1a1a;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .online-vocab-meta {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }

        .online-vocab-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            color: white;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .online-vocab-badge.intermediate {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }

        .online-vocab-badge.advanced {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }

        .online-vocab-description {
            font-size: 14px;
            color: #6b7280;
            line-height: 1.6;
            margin-bottom: 12px;
        }

        .online-vocab-stats {
            display: flex;
            gap: 16px;
            margin-bottom: 16px;
        }

        .online-vocab-stat {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            color: #4b5563;
        }

        /* Îã§Ïö¥Î°úÎìú Î≤ÑÌäº Ïä§ÌÉÄÏùº */
        .online-download-btn {
            width: 100%;
            padding: 14px 24px;
            border: none;
            border-radius: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            position: relative;
            overflow: hidden;
        }

        .online-download-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
        }

        .online-download-btn:disabled {
            background: #e5e7eb;
            color: #6b7280;
            cursor: not-allowed;
            transform: none;
        }

        /* Ïπ¥ÌÖåÍ≥†Î¶¨Î≥Ñ ÌÖåÎßà ÏÉâÏÉÅ */
        .online-vocab-item[data-category="toeic"] {
            background: linear-gradient(135deg, #ffffff 0%, #eff6ff 100%);
            border-color: #60a5fa;
        }

        .online-vocab-item[data-category="daily"] {
            background: linear-gradient(135deg, #ffffff 0%, #f0fdf4 100%);
            border-color: #86efac;
        }

        .online-vocab-item[data-category="school"] {
            background: linear-gradient(135deg, #ffffff 0%, #fffbeb 100%);
            border-color: #fbbf24;
        }

        /* Îπà ÏÉÅÌÉú Ïä§ÌÉÄÏùº */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .empty-state-text {
            font-size: 16px;
            color: #6b7280;
        }

        /* Îã§ÌÅ¨Î™®Îìú Ïä§ÌÉÄÏùº */
        .dark-mode .online-vocab-item {
            background: var(--dark-hover);
            border-color: rgba(255, 255, 255, 0.1);
        }

        .dark-mode .online-vocab-title {
            color: var(--dark-text);
        }

        .dark-mode .online-vocab-description {
            color: var(--dark-text-secondary);
        }

        .dark-mode .online-vocab-stat {
            color: var(--dark-text-secondary);
        }

        .dark-mode .online-download-btn:disabled {
            background: rgba(255, 255, 255, 0.1);
            color: var(--dark-text-secondary);
        }

        /* Ïπ¥ÌÖåÍ≥†Î¶¨Î≥Ñ Îã§ÌÅ¨Î™®Îìú */
        .dark-mode .online-vocab-item[data-category="toeic"] {
            background: linear-gradient(135deg, var(--dark-hover) 0%, #1e3a8a 100%);
        }

        .dark-mode .online-vocab-item[data-category="daily"] {
            background: linear-gradient(135deg, var(--dark-hover) 0%, #064e3b 100%);
        }

        .dark-mode .online-vocab-item[data-category="school"] {
            background: linear-gradient(135deg, var(--dark-hover) 0%, #78350f 100%);
        }

        /* Î°úÎî© Ïä§ÌîºÎÑà */
        .spinner {
            width: 40px;
            height: 40px;
            margin: 0 auto 20px;
            border: 4px solid #f3f4f6;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Îã®Ïñ¥Ïû• Î™®Îã¨ */
        .vocab-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 3000;
            backdrop-filter: blur(10px);
        }

        .vocab-modal-content {
            background: white;
            border-radius: 20px;
            max-width: 480px;
            width: 90%;
            max-height: 80vh;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
            animation: modalAppear 0.3s ease forwards;
        }

        .dark-mode .vocab-modal-content {
            background: var(--dark-hover);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .vocab-modal-header {
            padding: 24px;
            border-bottom: 1px solid rgba(0,0,0,0.1);
            text-align: center;
        }

        .dark-mode .vocab-modal-header {
            border-bottom-color: rgba(255,255,255,0.1);
        }

        .vocab-modal-title {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 12px;
            color: #1a1a1a;
        }

        .dark-mode .vocab-modal-title {
            color: var(--dark-text);
        }

        .vocab-search {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e8ecff;
            border-radius: 10px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .dark-mode .vocab-search {
            background: var(--dark-bg);
            border-color: rgba(255,255,255,0.1);
            color: var(--dark-text);
        }

        .vocab-search:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .vocab-list {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }

        .vocab-item {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .vocab-item button {
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .vocab-item:hover button {
            opacity: 1;
        }
        .dark-mode .vocab-item {
            background: rgba(255,255,255,0.05);
        }
        .dark-mode .vocab-item button {
            color: #a1a1aa;
        }

        .dark-mode .vocab-item button:hover {
            color: #e4e4e7;
        }

        .vocab-item:hover {
            background: #e8ecff;
            transform: translateX(4px);
        }

        .dark-mode .vocab-item:hover {
            background: rgba(102, 126, 234, 0.2);
        }

        .vocab-item.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .vocab-item-info {
            flex: 1;
        }

        .vocab-item-name {
            font-weight: 600;
            font-size: 16px;
            margin-bottom: 4px;
        }

        .vocab-item-stats {
            font-size: 13px;
            opacity: 0.8;
        }

        .vocab-item-progress {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .vocab-progress-bar {
            width: 60px;
            height: 6px;
            background: rgba(0,0,0,0.1);
            border-radius: 3px;
            overflow: hidden;
        }

        .dark-mode .vocab-progress-bar {
            background: rgba(255,255,255,0.1);
        }

        .vocab-progress-fill {
            height: 100%;
            background: #10b981;
            transition: width 0.3s ease;
        }

        .vocab-item.active .vocab-progress-bar {
            background: rgba(255,255,255,0.3);
        }

        .vocab-item.active .vocab-progress-fill {
            background: white;
        }

        .vocab-streak {
            font-size: 18px;
        }

        .vocab-modal-actions {
            padding: 16px;
            border-top: 1px solid rgba(0,0,0,0.1);
            display: flex;
            gap: 12px;
        }

        .dark-mode .vocab-modal-actions {
            border-top-color: rgba(255,255,255,0.1);
        }

        .vocab-action-btn {
            flex: 1;
            padding: 12px 20px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .vocab-action-btn.primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .vocab-action-btn.secondary {
            background: #e5e7eb;
            color: #1a1a1a;
        }

        .dark-mode .vocab-action-btn.secondary {
            background: rgba(255,255,255,0.1);
            color: var(--dark-text);
        }

        .vocab-action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        /* ÌÜµÍ≥Ñ Ïπ¥Îìú - Í∏ÄÎûòÏä§Î™®ÌîºÏ¶ò Í∞ïÌôî */
        .stats {
            display: flex;
            justify-content: space-around;
            padding: 15px;
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            margin-top: 20px;
            position: relative;
            z-index: 1;
            border: 1px solid rgba(255,255,255,0.2);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
        }

        .stat-item {
            text-align: center;
            transition: transform 0.3s ease;
        }

        .stat-item:hover {
            transform: translateY(-3px) scale(1.05);
        }

        .stat-value {
            font-size: 28px;
            font-weight: 800;
            display: block;
            background: linear-gradient(45deg, #fff, #f0f0f0);
            -webkit-background-clip: text;          background-clip: text;
            -webkit-text-fill-color: transparent;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
        }

        .stat-label {
            font-size: 11px;
            opacity: 0.9;
            margin-top: 5px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* ÌÉ≠ ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò - Î™®Îçò ÎîîÏûêÏù∏ */
        .tabs {
            display: flex;
            background: linear-gradient(to bottom, #ffffff, #f8f9fa);
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .tab {
            flex: 1;
            padding: 18px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            position: relative;
            background: transparent;
            border: none;
            color: #666;
            font-size: 15px;
            letter-spacing: 0.5px;
        }

        .tab.active {
            color: #667eea;
            background: rgba(102, 126, 234, 0.08);
        }

        .tab.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 20%;
            right: 20%;
            height: 3px;
            background: linear-gradient(90deg, #667eea, #764ba2);
            border-radius: 3px 3px 0 0;
            animation: tabSlideIn 0.3s ease;
        }

        @keyframes tabSlideIn {
            from { transform: scaleX(0); }
            to { transform: scaleX(1); }
        }

        .tab:hover:not(.active) {
            color: #667eea;
            background: rgba(102, 126, 234, 0.04);
        }

        /* ÌÉ≠ Ïª®ÌÖêÏ∏† */
        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Î©îÏù∏ Ïª®ÌÖêÏ∏† */
        .main-content {
            padding: 25px;
            background: #fafbfc;
            min-height: calc(100vh - 200px);
        }

        /* ÏÑ§Ï†ï ÏÑπÏÖò */
        .settings-section {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .setting-card {
            background: #fff;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
            border: 1px solid #e8e8e8;
        }

        .setting-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.12);
            border-color: #667eea;
        }

        .setting-title {
            font-size: 17px;
            font-weight: 700;
            margin-bottom: 16px;
            color: #1a1a1a;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .dark-mode .setting-title {
            color: #fff;
        }

        /* Ïä¨ÎùºÏù¥Îçî Ïä§ÌÉÄÏùº */
        .slider-container {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-top: 10px;
        }

        .slider {
            flex: 1;
            height: 6px;
            background: #e0e8ff;
            border-radius: 3px;
            cursor: pointer;
            position: relative;
            appearance: none;
            -webkit-appearance: none;
        }

        .dark-mode .slider {
            background: #2a3155;
        }

        .slider::-webkit-slider-thumb {
            appearance: none;
            width: 20px;
            height: 20px;
            background: #667eea;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
            transition: all 0.2s ease;
        }

        .slider::-webkit-slider-thumb:hover {
            transform: scale(1.2);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.5);
        }

        .slider-value {
            min-width: 60px;
            text-align: center;
            font-weight: 600;
            color: #667eea;
        }

        /* ÏóÖÎ°úÎìú Î≤ÑÌäº Í∞úÏÑ† */
        .upload-btn {
            width: 100%;
            padding: 20px;
            border: 2px dashed #667eea;
            border-radius: 12px;
            background: linear-gradient(135deg, #f8f9ff 0%, #e8ecff 100%);
            color: #667eea;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            position: relative;
            overflow: hidden;
        }

        .upload-btn:hover {
            background: #667eea;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
            border-color: transparent;
        }

        .dark-mode .upload-btn {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
            border-color: rgba(102, 126, 234, 0.5);
            color: #a5b4fc;
        }

        .dark-mode .upload-btn:hover {
            background: #667eea;
            color: white;
            border-color: transparent;
        }

        /* ÏùåÏÑ± ÏÑ§Ï†ï Í∞úÏÑ† */
        .voice-settings {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .voice-select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e8ecff;
            border-radius: 10px;
            font-size: 14px;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23667eea' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 20px;
            padding-right: 40px;
        }

        .dark-mode .voice-select {
            background-color: var(--dark-bg);
            border-color: #3a3a4e;
            color: #fff;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23fff' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
        }

        .voice-select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .tts-mode-group {
            display: flex;
            gap: 20px;
            padding: 15px;
            background: linear-gradient(135deg, #f8f9ff 0%, #e8ecff 100%);
            border-radius: 10px;
        }

        .dark-mode .tts-mode-group {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 15px;
            background: rgba(102, 126, 234, 0.05);
            border-radius: 8px;
            margin-top: 8px;
        }

        .dark-mode .checkbox-group {
            background: rgba(102, 126, 234, 0.1);
        }

        .checkbox-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: #667eea;
            cursor: pointer;
        }

        .checkbox-group label {
            cursor: pointer;
            font-size: 14px;
        }

        .test-voice-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .test-voice-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
        }

        .visibility-controls {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            padding: 15px;
            background: linear-gradient(135deg, #f8f9ff 0%, #e8ecff 100%);
            border-radius: 10px;
            margin-top: 10px;
        }

        .dark-mode .visibility-controls {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
        }

        /* Ï±ïÌÑ∞ ÏÑπÏÖò */
        .chapters-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .chapter-grid {
            display: grid;
            gap: 16px;
        }

        /* Ï±ïÌÑ∞ Ïπ¥Îìú - ÌòÑÎåÄÏ†Å ÎîîÏûêÏù∏ */
        .chapter-card {
            background: #fff;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            position: relative;
            overflow: hidden;
            border: 1px solid #e8e8e8;
        }

        .chapter-card.normal {
            background: linear-gradient(135deg, #ffffff 0%, #f0fdf4 100%);
            border-color: #86efac;
        }

        .chapter-card.midterm {
            background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
            border-color: #fbbf24;
        }

        .chapter-card.midterm::before {
            content: 'üìù';
            position: absolute;
            top: -20px;
            right: -20px;
            font-size: 80px;
            opacity: 0.1;
            transform: rotate(-15deg);
        }

        .chapter-card.final {
            background: linear-gradient(135deg, #fef2f2 0%, #fecaca 100%);
            border-color: #f87171;
        }

        .chapter-card.final::before {
            content: 'üìã';
            position: absolute;
            top: -20px;
            right: -20px;
            font-size: 80px;
            opacity: 0.1;
            transform: rotate(-15deg);
        }

        .chapter-card.comprehensive {
            background: linear-gradient(135deg, #f3f4ff 0%, #e0e7ff 100%);
            border-color: #a78bfa;
        }

        .chapter-card.comprehensive::before {
            content: 'üéØ';
            position: absolute;
            top: -20px;
            right: -20px;
            font-size: 80px;
            opacity: 0.1;
            transform: rotate(-15deg);
        }

        .chapter-card.allwords {
            background: linear-gradient(135deg, #fef3c7 0%, #f59e0b 100%);
            border-color: #f59e0b;
            animation: goldPulse 3s ease-in-out infinite;
        }

        @keyframes goldPulse {
            0%, 100% { 
                box-shadow: 0 2px 8px rgba(245, 158, 11, 0.3);
            }
            50% { 
                box-shadow: 0 8px 24px rgba(245, 158, 11, 0.5);
            }
        }

        .chapter-card.perfect {
            background: linear-gradient(135deg, #ffd700 0%, #ffed4e 50%, #ffd700 100%);
            animation: goldShine 3s linear infinite;
            border-color: #fbbf24;
        }

        @keyframes goldShine {
            0% { background-position: 0% 50%; }
            100% { background-position: 200% 50%; }
        }

        .chapter-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 24px rgba(0,0,0,0.15);
        }

        .chapter-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .chapter-title {
            font-size: 18px;
            font-weight: 700;
            color: #1a1a1a;
        }

        .chapter-stars {
            font-size: 22px;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
        }

        /* Î¨¥ÏßÄÍ∞ú Î≥Ñ Ïä§ÌÉÄÏùº */
        .rainbow-star {
            display: inline-block;
            font-size: 22px;
            background: linear-gradient(45deg, #ff0000, #ff7300, #fffb00, #48ff00, #00ffd5, #002bff, #7a00ff, #ff00c8, #ff0000);
            -webkit-background-clip: text;          background-clip: text;
            -webkit-text-fill-color: transparent;
            background-size: 200% 100%;
            animation: rainbowMove 2s linear infinite;
            filter: drop-shadow(0 0 8px rgba(255, 215, 0, 0.8));
        }

        @keyframes rainbowMove {
            0% { background-position: 0% 50%; }
            100% { background-position: 200% 50%; }
        }

        .chapter-progress {
            margin-bottom: 16px;
        }

        .progress-info {
            font-size: 13px;
            color: #666;
            margin-bottom: 8px;
        }

        .progress-bar-container {
            width: 100%;
            height: 10px;
            background: #f0f0f0;
            border-radius: 5px;
            overflow: hidden;
            margin-top: 8px;
            position: relative;
        }

        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            border-radius: 5px;
            transition: width 0.3s ease;
            box-shadow: 0 0 10px rgba(102, 126, 234, 0.5);
            position: absolute;
            top: 0;
            left: 0;
        }

        .progress-bar-recent {
            height: 100%;
            background: linear-gradient(90deg, #fbbf24, #f59e0b);
            border-radius: 5px;
            transition: width 0.3s ease;
            position: absolute;
            top: 0;
            left: 0;
            opacity: 0.6;
        }

        .chapter-info {
            color: #666;
            font-size: 13px;
            line-height: 1.6;
        }

        /* Ï±ïÌÑ∞ Î™®Îã¨ */
        .chapter-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            backdrop-filter: blur(10px);
        }

        .chapter-modal-content {
            background: white;
            padding: 32px;
            border-radius: 20px;
            text-align: center;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            transform: scale(0);
            animation: modalAppear 0.3s ease forwards;
        }

        .dark-mode .chapter-modal-content {
            background: var(--dark-hover);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .chapter-modal-title {
            font-size: 24px;
            margin-bottom: 24px;
            color: #1a1a1a;
            font-weight: 700;
        }

        .dark-mode .chapter-modal-title {
            color: #fff;
        }

        .chapter-modal-actions {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .chapter-modal-btn {
            padding: 16px 24px;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 15px;
            position: relative;
            overflow: hidden;
            color: white;
        }

        .chapter-modal-btn.study {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .chapter-modal-btn.test {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }

        .chapter-modal-btn.close {
            background: #6b7280;
            margin-top: 8px;
        }

        .chapter-modal-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.2);
        }

        /* Îπ†Î•∏ Ïï°ÏÖò Î≤ÑÌäºÎì§ */
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        .quick-action-btn {
            padding: 20px;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            color: white;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 14px;
            position: relative;
            overflow: hidden;
            text-align: center;
            min-height: 100px;
        }

        .quick-action-btn .icon {
            font-size: 28px;
            margin-bottom: 4px;
        }

        .quick-action-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 24px rgba(0,0,0,0.2);
        }

        .focus-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            grid-column: 1 / -1;
        }

        .save-btn {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }

        .load-btn {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        }

        /* Î¶¨ÏÖã Î≤ÑÌäº */
        .reset-section {
            margin-top: 30px;
            padding-top: 30px;
            border-top: 1px solid #e5e7eb;
        }

        .dark-mode .reset-section {
            border-top-color: rgba(255,255,255,0.1);
        }

        .reset-btn {
            width: 100%;
            padding: 14px;
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 15px;
        }

        .reset-btn:hover {
            background: #dc2626;
            transform: scale(1.02);
            box-shadow: 0 8px 20px rgba(239, 68, 68, 0.3);
        }

        /* ÏïΩÌïúÎã®Ïñ¥ ÏÑπÏÖò */
        .weak-words-section {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            margin-bottom: 20px;
        }

        .weak-words-list {
            display: none;
            max-height: 400px;
            overflow-y: auto;
            padding: 8px;
        }

        .weak-word-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 8px;
            background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
            transition: all 0.3s ease;
            border: 1px solid #fecaca;
        }

        .weak-word-item:hover {
            transform: translateX(4px);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.1);
            border-color: #f87171;
        }

        .weak-word-info {
            flex: 1;
        }

        .weak-word-title {
            font-weight: 600;
            font-size: 15px;
            margin-bottom: 4px;
            color: #1a1a1a;
        }

        .weak-word-stats {
            font-size: 12px;
            color: #666;
        }

        .weak-word-score {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            min-width: 45px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
        }

        /* ÌïôÏäµ Î™®Îìú */
        .study-mode {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: none;
            flex-direction: column;
            z-index: 1000;
        }

        .study-header {
            padding: 20px;
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(20px);
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .study-controls {
            display: flex;
            gap: 8px;
        }

        .study-control-btn {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 18px;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            font-weight: 500;
        }

        .study-control-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.05);
        }

        .progress-bar {
            height: 4px;
            background: rgba(255,255,255,0.2);
            position: relative;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #fff, rgba(255,255,255,0.8));
            transition: width 0.3s ease;
            box-shadow: 0 0 10px rgba(255,255,255,0.5);
        }

        .study-card {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 40px;
            text-align: center;
        }

        .word-display {
            background: white;
            border-radius: 24px;
            padding: 48px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.2);
            min-width: 80%;
            max-width: 600px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .word-display:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 30px 80px rgba(0,0,0,0.3);
        }

        .word-text {
            font-size: 48px;
            font-weight: 800;
            color: #1a1a1a;
            margin-bottom: 8px;
            letter-spacing: -0.5px;
            transition: opacity 0.3s ease;
        }

        .dark-mode .word-text {
            color: #fff;
        }

        .word-pronunciation {
            font-size: 24px;
            color: #9ca3af;
            margin-bottom: 24px;
            transition: opacity 0.3s ease;
        }

        .dark-mode .word-pronunciation {
            color: #6b7280;
        }

        .word-meaning {
            font-size: 28px;
            color: #4b5563;
            margin-bottom: 20px;
            font-weight: 600;
            transition: opacity 0.3s ease;
        }

        .dark-mode .word-meaning {
            color: #d1d5db;
        }

        .word-example {
            font-size: 20px;
            color: #6b7280;
            font-style: italic;
            line-height: 1.6;
            margin-bottom: 8px;
            transition: opacity 0.3s ease;
        }

        .dark-mode .word-example {
            color: #9ca3af;
        }

        .word-example-meaning {
            font-size: 18px;
            color: #9ca3af;
            line-height: 1.6;
            transition: opacity 0.3s ease;
        }

        .dark-mode .word-example-meaning {
            color: #6b7280;
        }

        .word-element.hidden {
            opacity: 0.1;
        }

        .pause-indicator {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.9);
            color: white;
            padding: 24px 48px;
            border-radius: 16px;
            font-size: 24px;
            font-weight: 600;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            backdrop-filter: blur(10px);
            opacity: 0;
            animation: pauseFadeInOut 1s ease-out;
        }

        @keyframes pauseFadeInOut {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
            50% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            100% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
        }

        /* ÌÖåÏä§Ìä∏ Î™®Îìú */
        .test-mode {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            display: none;
            flex-direction: column;
            z-index: 1000;
        }

        .test-header {
            padding: 20px;
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(20px);
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .test-controls {
            display: flex;
            gap: 8px;
        }

        .test-stats {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .test-stat {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 4px 16px;
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
            backdrop-filter: blur(10px);
        }

        .test-stat-value {
            font-size: 18px;
            font-weight: 700;
        }

        .test-stat-label {
            font-size: 11px;
            opacity: 0.9;
        }

        .timer-bar {
            height: 8px;
            background: rgba(255,255,255,0.2);
            overflow: hidden;
            position: relative;
        }

        .timer-fill {
            height: 100%;
            background: linear-gradient(90deg, #ef4444, #dc2626);
            transition: width 0.1s linear;
            box-shadow: 0 0 10px rgba(239, 68, 68, 0.5);
        }

        .test-card {
            flex: 1;
            padding: 20px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .question-card {
            background: white;
            border-radius: 20px;
            padding: 32px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.2);
            margin-bottom: 20px;
            text-align: center;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            min-height: 280px; /* ÏµúÏÜå ÎÜíÏù¥ ÏÑ§Ï†ï */
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .question-card.correct {
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
        }

        .dark-mode .question-card.correct {
            background: linear-gradient(135deg, #064e3b 0%, #065f46 100%);
        }

        .question-card.incorrect {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
        }

        .dark-mode .question-card.incorrect {
            background: linear-gradient(135deg, #7f1d1d 0%, #991b1b 100%);
        }

        .question-word {
            font-size: 40px;
            font-weight: 800;
            color: #1a1a1a;
            margin-bottom: 24px;
            letter-spacing: -0.5px;
        }

        .dark-mode .question-word {
            color: #fff;
        }

        .question-example {
            font-size: 18px;
            color: #4b5563;
            font-style: italic;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid rgba(0,0,0,0.1);
            line-height: 1.6;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .question-example.show {
            opacity: 1;
        }

        .question-example-meaning {
            font-size: 16px;
            color: #6b7280;
            margin-top: 8px;
            line-height: 1.6;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .question-example-meaning.show {
            opacity: 1;
        }
        .dark-mode .question-example {
            color: #d1d5db;
            border-top-color: rgba(255,255,255,0.1);
        }

        .question-example-meaning {
            font-size: 16px;
            color: #6b7280;
            margin-top: 8px;
            line-height: 1.6;
        }

        .dark-mode .question-example-meaning {
            color: #9ca3af;
        }

        .options-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 16px;
        }

        .option-btn {
            padding: 18px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            background: white;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .option-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
            border-color: #667eea;
        }

        .option-btn.correct {
            background: #10b981;
            color: white;
            border-color: #10b981;
            animation: correctPulse 0.5s ease;
        }

        @keyframes correctPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .option-btn.incorrect {
            background: #ef4444;
            color: white;
            border-color: #ef4444;
            animation: shake 0.5s ease;
        }

        .dont-know-btn {
            width: 100%;
            padding: 18px;
            background: #6b7280;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .dont-know-btn:hover {
            background: #4b5563;
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(107, 114, 128, 0.3);
        }

        /* ÌååÌã∞ÌÅ¥ Ìö®Í≥º */
        .particle {
            position: absolute;
            width: 10px;
            height: 10px;
            background: #ffd700;  /* Í∏àÏÉâ Í∏∞Î≥∏Í∞í */
            border-radius: 50%;
            pointer-events: none;
            animation: particleAnimation 1s ease-out forwards; 
            z-index: 9999;
        }

        @keyframes particleAnimation {
            0% {
                transform: translate(0, 0) scale(1);
                opacity: 1;
            }
            100% {
                transform: translate(var(--tx), var(--ty)) scale(0);
                opacity: 0;
            }
        }

        /* 100Ï†ê Ìö®Í≥º */
        .perfect-star-animation {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 180px;
            z-index: 3000;
            opacity: 0;
            animation: perfectStarBurst 3s ease-out;
            filter: drop-shadow(0 0 40px gold);
            display: flex;
            gap: 10px;
        }

        .perfect-star-animation .rainbow-star {
            font-size: 180px;
            filter: drop-shadow(0 0 20px gold);
        }

        @keyframes perfectStarBurst {
            0% { 
                opacity: 0; 
                transform: translate(-50%, -50%) scale(0) rotate(0deg); 
            }
            50% { 
                opacity: 1; 
                transform: translate(-50%, -50%) scale(1.2) rotate(180deg); 
            }
            100% { 
                opacity: 0; 
                transform: translate(-50%, -50%) scale(1) rotate(360deg); 
            }
        }

        .firework {
            position: absolute;
            width: 4px;
            height: 4px;
            background: gold;
            border-radius: 50%;
            animation: fireworkExplode 2s ease-out forwards;
        }

        @keyframes fireworkExplode {
            0% {
                transform: translate(0, 0) scale(1);
                opacity: 1;
            }
            100% {
                transform: translate(var(--fx), var(--fy)) scale(0);
                opacity: 0;
            }
        }

        /* Î™®Îã¨ */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            backdrop-filter: blur(10px);
        }

        .modal-content {
            background: white;
            padding: 32px;
            border-radius: 20px;
            text-align: center;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            transform: scale(0);
            animation: modalAppear 0.3s ease forwards;
        }

        @keyframes modalAppear {
            to { transform: scale(1); }
        }

        .modal-content h3 {
            font-size: 24px;
            margin-bottom: 16px;
            color: #1a1a1a;
            font-weight: 700;
        }

        .dark-mode .modal-content h3 {
            color: #fff;
        }

        .modal-content p {
            font-size: 16px;
            margin-bottom: 24px;
            color: #4b5563;
            line-height: 1.6;
        }

        .dark-mode .modal-content p {
            color: #d1d5db;
        }

        .modal-buttons {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }

        .modal-btn {
            flex: 1;
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 15px;
        }

        .modal-btn.yes {
            background: #10b981;
            color: white;
        }

        .modal-btn.no {
            background: #ef4444;
            color: white;
        }

        .modal-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
        }

        /* Ï±ïÌÑ∞ ÏÑ§Ï†ï Î™®Îã¨ */
        .chapter-setting-input {
            width: 100%;
            padding: 14px;
            border: 2px solid #667eea;
            border-radius: 10px;
            font-size: 20px;
            text-align: center;
            margin: 20px 0;
            transition: all 0.3s ease;
        }

        .chapter-setting-input:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
            transform: scale(1.02);
        }

        .chapter-setting-hint {
            font-size: 13px;
            color: #6b7280;
            margin-top: 8px;
        }

        /* Îã®Ïñ¥Ïû• Ïù¥Î¶Ñ ÏÑ§Ï†ï Î™®Îã¨ */
        .vocab-name-input {
            width: 100%;
            padding: 14px;
            border: 2px solid #667eea;
            border-radius: 10px;
            font-size: 18px;
            margin: 20px 0;
            transition: all 0.3s ease;
        }

        .dark-mode .vocab-name-input {
            background: var(--dark-bg);
            border-color: rgba(102, 126, 234, 0.5);
            color: var(--dark-text);
        }

        .vocab-name-input:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
        }

        /* ÌîºÎìúÎ∞± */
        .feedback {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            padding: 24px 48px;
            border-radius: 16px;
            font-size: 20px;
            font-weight: 600;
            text-align: center;
            z-index: 3000;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            display: none;
        }

        .feedback.show {
            display: block;
            animation: feedbackShow 0.5s ease forwards;
        }

        @keyframes feedbackShow {
            0% { transform: translate(-50%, -50%) scale(0) rotate(-180deg); }
            50% { transform: translate(-50%, -50%) scale(1.1) rotate(90deg); }
            100% { transform: translate(-50%, -50%) scale(1) rotate(0deg); }
        }

        .feedback.success {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }

        .feedback.error {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
        }

        .feedback.warning {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
            font-size: 18px;
            padding: 20px 40px;
        }


        /* Î≥Ñ ÎÇ†ÏïÑÏò§Îäî Ïï†ÎãàÎ©îÏù¥ÏÖò */
        .flying-star {
            position: fixed;
            font-size: 102px;
            z-index: 3000;
            filter: drop-shadow(0 0 20px gold) drop-shadow(0 0 40px gold);
            pointer-events: none;
        }
        
        /* Î¨¥ÏßÄÍ∞úÎ≥ÑÎèÑ ÎèôÏùºÌïú ÌÅ¨Í∏∞Î°ú */
        .flying-star .rainbow-star {
            font-size: 102px;
        }

        /* 3Í∞ú Î≥Ñ - ÏÇºÍ∞ÅÌòï Î∞∞Ïπò */
        .triangle-top {
            animation: flyFromTop 1.2s cubic-bezier(0.4, 0, 0.2, 1) forwards;
        }

        .triangle-left {
            animation: flyFromLeft 1.2s cubic-bezier(0.4, 0, 0.2, 1) forwards;
        }

        .triangle-right {
            animation: flyFromRight 1.2s cubic-bezier(0.4, 0, 0.2, 1) forwards;
        }

        /* 2Í∞ú Î≥Ñ - ÎÇòÎûÄÌûà Î∞∞Ïπò */
        .line-left {
            animation: flyFromLeftSide 1.2s cubic-bezier(0.4, 0, 0.2, 1) forwards;
        }

        .line-right {
            animation: flyFromRightSide 1.2s cubic-bezier(0.4, 0, 0.2, 1) forwards;
        }

        /* 1Í∞ú Î≥Ñ - Ï§ëÏïô */
        .single-star {
            animation: flyFromRandom 1.2s cubic-bezier(0.4, 0, 0.2, 1) forwards;
        }

        /* ÏÇºÍ∞ÅÌòï Î∞∞Ïπò Ïï†ÎãàÎ©îÏù¥ÏÖò */
        @keyframes flyFromTop {
            0% {
                transform: translate(-50%, -50%) translateY(-1000px) rotate(0deg) scale(0.1);
                opacity: 0;
            }
            50% {
                opacity: 1;
            }
            100% {
                transform: translate(-50%, -50%) translateY(-70px) rotate(720deg) scale(1);
                opacity: 1;
            }
        }

        @keyframes flyFromLeft {
            0% {
                transform: translate(-50%, -50%) translate(-1000px, 1000px) rotate(0deg) scale(0.1);
                opacity: 0;
            }
            50% {
                opacity: 1;
            }
            100% {
                transform: translate(-50%, -50%) translate(-70px, 70px) rotate(720deg) scale(1);
                opacity: 1;
            }
        }

        @keyframes flyFromRight {
            0% {
                transform: translate(-50%, -50%) translate(1000px, 1000px) rotate(0deg) scale(0.1);
                opacity: 0;
            }
            50% {
                opacity: 1;
            }
            100% {
                transform: translate(-50%, -50%) translate(70px, 70px) rotate(720deg) scale(1);
                opacity: 1;
            }
        }

        /* ÎÇòÎûÄÌûà Î∞∞Ïπò Ïï†ÎãàÎ©îÏù¥ÏÖò */
        @keyframes flyFromLeftSide {
            0% {
                transform: translate(-50%, -50%) translateX(-1200px) rotate(0deg) scale(0.1);
                opacity: 0;
            }
            50% {
                opacity: 1;
            }
            100% {
                transform: translate(-50%, -50%) translateX(-60px) rotate(720deg) scale(1);
                opacity: 1;
            }
        }

        @keyframes flyFromRightSide {
            0% {
                transform: translate(-50%, -50%) translateX(1200px) rotate(0deg) scale(0.1);
                opacity: 0;
            }
            50% {
                opacity: 1;
            }
            100% {
                transform: translate(-50%, -50%) translateX(60px) rotate(720deg) scale(1);
                opacity: 1;
            }
        }

        /* Îã®Ïùº Î≥Ñ Ïï†ÎãàÎ©îÏù¥ÏÖò */
        @keyframes flyFromRandom {
            0% {
                transform: translate(-50%, -50%) translate(-800px, -800px) rotate(0deg) scale(0.1);
                opacity: 0;
            }
            50% {
                opacity: 1;
            }
            100% {
                transform: translate(-50%, -50%) translate(0, 0) rotate(1080deg) scale(1);
                opacity: 1;
            }
        }

        /* Ï∂©Í≤©Ìåå Ìö®Í≥º */
        .shockwave {
            position: fixed;
            width: 100px;
            height: 100px;
            border-radius: 50%;
            border: 3px solid rgba(255, 215, 0, 0.8);
            z-index: 2998;
            pointer-events: none;
            animation: shockwaveExpand 0.8s ease-out forwards;
        }

        @keyframes shockwaveExpand {
            0% {
                transform: translate(-50%, -50%) scale(0);
                opacity: 1;
            }
            100% {
                transform: translate(-50%, -50%) scale(4);
                opacity: 0;
            }
        }

        /* ÌôîÎ©¥ ÌùîÎì§Î¶º Ìö®Í≥º */
        @keyframes screenShake {
            0%, 100% { transform: translate(0, 0); }
            10% { transform: translate(-2.5px, -2.5px); }
            20% { transform: translate(2.5px, -2.5px); }
            30% { transform: translate(-2.5px, 2.5px); }
            40% { transform: translate(2.5px, 2.5px); }
            50% { transform: translate(-1.5px, -1.5px); }
            60% { transform: translate(1.5px, -1.5px); }
            70% { transform: translate(-1.5px, 1.5px); }
            80% { transform: translate(1.5px, 1.5px); }
            90% { transform: translate(-0.5px, -0.5px); }
        }


        @keyframes sparkle {
            0% {
                transform: translate(0, 0) scale(1);
                opacity: 1;
            }
            100% {
                transform: translate(var(--x), var(--y)) scale(0);
                opacity: 0;
            }
        }

        /* Îã§ÌÅ¨Î™®Îìú ÌÜ†Í∏Ä */
        .dark-mode-toggle {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: linear-gradient(135deg, rgba(255,255,255,0.9) 0%, rgba(255,255,255,0.8) 100%);
            backdrop-filter: blur(10px);
            color: #1a1a1a;
            border: 1px solid rgba(0,0,0,0.1);
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            font-size: 24px;
            transition: all 0.3s ease;
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .dark-mode .dark-mode-toggle {
            background: linear-gradient(135deg, rgba(30,30,30,0.9) 0%, rgba(20,20,20,0.8) 100%);
            color: #fbbf24;
            border-color: rgba(255,255,255,0.1);
        }

        .dark-mode-toggle:hover {
            transform: scale(1.1) rotate(180deg);
            box-shadow: 0 8px 30px rgba(0,0,0,0.25);
        }

        /* Ïä§ÌÅ¨Î°§Î∞î Ïä§ÌÉÄÏùºÎßÅ */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(0,0,0,0.05);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: #667eea;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #764ba2;
        }

        .dark-mode ::-webkit-scrollbar-track {
            background: rgba(255,255,255,0.05);
        }

        .dark-mode ::-webkit-scrollbar-thumb {
            background: #764ba2;
        }

        /* Ïà®ÍπÄ ÌÅ¥ÎûòÏä§ */
        .hidden {
            display: none !important;
        }

        /* ÌååÏùº ÏûÖÎ†• Ïà®ÍπÄ */
        #fileInput, #backupInput {
            display: none;
        }

        /* Î∞òÏùëÌòï ÎîîÏûêÏù∏ */
        @media (max-width: 768px) {
            .container {
                max-width: 100%;
                box-shadow: none;
            }

            .header h1 {
                font-size: 28px;
            }

            .stat-value {
                font-size: 24px;
            }

            .stat-label {
                font-size: 10px;
            }

            .tab {
                font-size: 13px;
                padding: 12px;
            }

            .main-content {
                padding: 16px;
                min-height: calc(100vh - 180px);
            }

            .setting-title {
                font-size: 15px;
            }

            .upload-btn {
                font-size: 15px;
                padding: 16px;
            }

            .chapter-card {
                padding: 16px;
            }

            .chapter-title {
                font-size: 15px;
            }

            .chapter-stars {
                font-size: 18px;
            }

            .rainbow-star {
                font-size: 18px;
            }

            .chapter-info {
                font-size: 12px;
            }

            .word-display {
                padding: 32px;
                min-width: 85%;
            }

            .word-text {
                font-size: 28px;
            }

            .word-pronunciation {
                font-size: 16px;
            }

            .word-meaning {
                font-size: 20px;
            }

            .word-example {
                font-size: 16px;
            }

            .word-example-meaning {
                font-size: 14px;
            }

            .question-card {
                padding: 24px;
            }

            .question-word {
                font-size: 26px;
            }

            .question-example {
                font-size: 15px;
            }

            .options-grid {
                gap: 8px;
            }

            .option-btn {
                font-size: 13px;
                padding: 14px 6px;
            }

            .dont-know-btn {
                font-size: 15px;
                padding: 16px;
            }

            .modal-content {
                padding: 24px;
            }

            .modal-content h3 {
                font-size: 20px;
            }

            .modal-content p {
                font-size: 14px;
            }

            .perfect-star-animation {
                font-size: 100px;
            }

            .perfect-star-animation .rainbow-star {
                font-size: 100px;
            }

            .dark-mode-toggle {
                width: 48px;
                height: 48px;
                font-size: 20px;
                bottom: 16px;
                right: 16px;
            }

            .vocab-modal-content {
                max-width: 100%;
                border-radius: 20px 20px 0 0;
                max-height: 90vh;
            }
        }

        @media (max-width: 480px) {
            .header h1 {
                font-size: 24px;
            }

            .header .subtitle {
                font-size: 12px;
            }

            .stats {
                padding: 12px;
            }

            .stat-value {
                font-size: 20px;
            }

            .stat-label {
                font-size: 9px;
            }

            .tabs {
                margin-top: 0;
            }

            .tab {
                font-size: 12px;
                padding: 10px;
            }

            .quick-actions {
                grid-template-columns: 1fr;
            }

            .test-stats {
                gap: 12px;
            }

            .test-stat {
                padding: 4px 12px;
            }

            .test-stat-value {
                font-size: 16px;
            }

            .test-stat-label {
                font-size: 10px;
            }

            .vocab-selector-btn {
                font-size: 12px;
                padding: 6px 16px;
            }

            .vocab-name {
                max-width: 100px;
            }
        }
    
    </style>
</head>
<body>

    <div class="container">
        <div class="header">
            <h1>‚ú® Word Master ‚ú®</h1>
            <div class="subtitle">Master Your Vocabulary</div>
            
            <!-- Îã®Ïñ¥Ïû• ÏÑ†ÌÉùÍ∏∞ -->
            <div class="vocab-selector">
                <button class="vocab-selector-btn" onclick="showVocabModal()">
                    <span>üìö</span>
                    <span class="vocab-name" id="currentVocabName">Îã®Ïñ¥Ïû• ÏÑ†ÌÉù</span>
                    <span>‚ñº</span>
                </button>
            </div>
            
            <div class="stats">
                <div class="stat-item">
                    <span class="stat-value" id="totalWords">0</span>
                    <span class="stat-label">Ï¥ù Îã®Ïñ¥</span>
                </div>
                <div class="stat-item">
                    <span class="stat-value" id="weakWords">0</span>
                    <span class="stat-label">ÏïΩÌïú Îã®Ïñ¥</span>
                </div>
                <div class="stat-item">
                    <span class="stat-value" id="accuracy">0%</span>
                    <span class="stat-label">Ï†ÑÏ≤¥ Ï†ïÎãµÎ•†</span>
                </div>
                <div class="stat-item">
                    <span class="stat-value" id="userStars">‚≠ê 1000</span>
                    <span class="stat-label">Î≥¥Ïú† Î≥Ñ</span>
                </div>
            </div>
        </div>

        <!-- ÌÉ≠ ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò -->
        <div class="tabs">
            <button class="tab active" onclick="switchTab('chapters')">üìö Ï±ïÌÑ∞</button>
            <button class="tab" onclick="switchTab('weakwords')">üìã ÏïΩÌïúÎã®Ïñ¥</button>
            <button class="tab" onclick="switchTab('settings')">‚öôÔ∏è ÏÑ§Ï†ï</button>
        </div>

        <div class="main-content">
            <!-- Ï±ïÌÑ∞ ÌÉ≠ -->
            <div class="tab-content active" id="chapters-tab">
                <div class="chapters-container">
                    <h3 style="margin: 20px 0; color: #1a1a1a; font-size: 20px; font-weight: 700;">üìö Ï±ïÌÑ∞ Î™©Î°ù</h3>
                    <div class="chapter-grid" id="chapterList">
                        <div style="text-align: center; color: #6b7280; padding: 60px;">
                            Îã®Ïñ¥Ïû•ÏùÑ ÏÑ†ÌÉùÌïòÍ±∞ÎÇò ÏÉàÎ°ú ÎßåÎì§Ïñ¥Ï£ºÏÑ∏Ïöî
                        </div>
                    </div>
                </div>
            </div>

            <!-- ÏïΩÌïúÎã®Ïñ¥ ÌÉ≠ -->
            <div class="tab-content" id="weakwords-tab">
                <div class="weak-words-section">
                    <!-- Îπ†Î•∏ Ïï°ÏÖò Î≤ÑÌäºÎì§ -->
                    <div class="quick-actions">
                        <button class="quick-action-btn focus-btn" onclick="showFocusModal()">
                            <div class="icon">üéØ</div>
                            <div>ÏßëÏ§ëÌïôÏäµ</div>
                            <div style="font-size: 12px; opacity: 0.8;">ÏïΩÌïúÎã®Ïñ¥ ÌäπÌôî</div>
                        </button>
                    </div>
                    
                    <h3 style="margin: 20px 0; color: #1a1a1a; font-size: 20px; font-weight: 700;">üìã ÏïΩÌïúÎã®Ïñ¥ Î™©Î°ù (ÏÉÅÏúÑ 20Í∞ú)</h3>
                    <div class="weak-words-list" id="weakWordsList" style="display: block; max-height: none;">
                        <div style="text-align: center; color: #6b7280; padding: 40px;">
                            ÏïΩÌïú Îã®Ïñ¥Í∞Ä ÏóÜÏäµÎãàÎã§
                        </div>
                    </div>
                </div>
            </div>

            <!-- ÏÑ§Ï†ï ÌÉ≠ -->
            <div class="tab-content" id="settings-tab">
                <div class="settings-section">
                    <!-- Ïò®ÎùºÏù∏ Îã®Ïñ¥Ïû• Îã§Ïö¥Î°úÎìú -->
                    <div class="setting-card">
                        <div class="setting-title">
                            üåê Ïò®ÎùºÏù∏ Îã®Ïñ¥Ïû• Îã§Ïö¥Î°úÎìú
                        </div>
                        <button class="upload-btn" onclick="showOnlineVocabStore()">
                            <span style="font-size: 24px;">üì•</span>
                            <span>Îã®Ïñ¥Ïû• Ïä§ÌÜ†Ïñ¥ Ïó¥Í∏∞</span>
                        </button>
                        <div style="margin-top: 10px; font-size: 14px; color: #6b7280;">
                            Îã§ÏñëÌïú Îã®Ïñ¥Ïû•ÏùÑ Î¨¥Î£åÎ°ú Îã§Ïö¥Î°úÎìúÌïòÏÑ∏Ïöî
                        </div>
                    </div>

                    <!-- Î°úÏª¨ ÌååÏùº ÏóÖÎ°úÎìú (Í∏∞Ï°¥ Í∏∞Îä• Ïú†ÏßÄ) -->
                    <div class="setting-card">
                        <div class="setting-title">
                            üìÅ Î°úÏª¨ ÌååÏùº ÏóÖÎ°úÎìú
                        </div>
                        <button class="upload-btn" onclick="document.getElementById('fileInput').click()">
                            <span style="font-size: 24px;">üì§</span>
                            <span>ÌååÏùº ÏÑ†ÌÉù</span>
                        </button>
                        <input type="file" id="fileInput" accept=".txt" multiple>
                        <div style="margin-top: 10px; font-size: 14px; color: #6b7280;">
                            ÏßÄÏõê ÌòïÏãù: .txt ÌååÏùº
                        </div>
                    </div>

                    <!-- TTS ÏÑ§Ï†ï -->
                    <div class="setting-card">
                        <div class="setting-title">
                            üîä ÏùåÏÑ± ÏÑ§Ï†ï (TTS)
                        </div>
                        <div class="voice-settings">
                            <select class="voice-select" id="voiceSelect" onchange="changeVoice()">
                                <option value="">ÏùåÏÑ± ÏûêÎèô ÏÑ†ÌÉù</option>
                            </select>
                            <div class="tts-mode-group">
                                <div class="checkbox-group">
                                    <input type="checkbox" id="wordMode" checked>
                                    <label for="wordMode">Îã®Ïñ¥ ÏùΩÍ∏∞</label>
                                </div>
                                <div class="checkbox-group">
                                    <input type="checkbox" id="exampleMode">
                                    <label for="exampleMode">ÏòàÎ¨∏ ÏùΩÍ∏∞</label>
                                </div>
                            </div>
                            <div class="checkbox-group">
                                <input type="checkbox" id="testWordTTS" checked>
                                <label for="testWordTTS">ÌÖåÏä§Ìä∏Î™®ÎìúÏóêÏÑú Îã®Ïñ¥ ÏùΩÍ∏∞</label>
                            </div>
                            <div class="checkbox-group">
                                <input type="checkbox" id="testAnswerTTS">
                                <label for="testAnswerTTS">ÌÖåÏä§Ìä∏Î™®ÎìúÏóêÏÑú ÏòàÎ¨∏ ÏùΩÍ∏∞</label>
                            </div>
                            <button class="test-voice-btn" onclick="testVoice()">üé§ ÏùåÏÑ± ÌÖåÏä§Ìä∏</button>
                        </div>
                    </div>

                    <!-- ÌïôÏäµ ÏÜçÎèÑ ÏÑ§Ï†ï -->
                    <div class="setting-card">
                        <div class="setting-title">
                            ‚è±Ô∏è ÌïôÏäµ ÏÜçÎèÑ ÏÑ§Ï†ï
                        </div>
                        <div class="slider-container">
                            <input type="range" class="slider" id="studySpeedSlider" 
                                min="10" max="100" value="28" step="1"
                                onchange="updateStudySpeed()">
                            <span class="slider-value" id="studySpeedValue">2.8Ï¥à</span>
                        </div>
                        <div style="margin-top: 10px; font-size: 14px; color: #6b7280;">
                            ÌïôÏäµ Î™®ÎìúÏóêÏÑú Îã§Ïùå Ïπ¥ÎìúÎ°ú ÎÑòÏñ¥Í∞ÄÎäî ÏãúÍ∞Ñ
                        </div>
                    </div>

                    <!-- TTS ÌîÑÎ¶¨Î°úÎìú ÏÑ§Ï†ï -->
                    <div class="setting-card">
                        <div class="setting-title">
                            üöÄ TTS ÌîÑÎ¶¨Î°úÎìú ÏÑ§Ï†ï
                        </div>
                        <div class="slider-container">
                            <input type="range" class="slider" id="ttsPreloadSlider" 
                                min="0" max="10" value="0" step="1"
                                onchange="updateTTSPreload()">
                            <span class="slider-value" id="ttsPreloadValue">0.0Ï¥à</span>
                        </div>
                        <div style="margin-top: 10px; font-size: 14px; color: #6b7280;">
                            Îã§Ïùå Ïπ¥Îìú TTSÎ•º ÎØ∏Î¶¨ Ïã§ÌñâÌïòÏó¨ ÎîúÎ†àÏù¥Î•º Ï§ÑÏûÖÎãàÎã§
                        </div>
                    </div>

                    <!-- ÌïôÏäµ Î™®Îìú Í∞ÄÏãúÏÑ± ÏÑ§Ï†ï -->
                    <div class="setting-card">
                        <div class="setting-title">
                            üëÅÔ∏è ÌïôÏäµ Î™®Îìú Í∞ÄÏãúÏÑ± ÏÑ§Ï†ï
                        </div>
                        <div class="visibility-controls">
                            <div class="checkbox-group">
                                <input type="checkbox" id="showWord" checked>
                                <label for="showWord">Îã®Ïñ¥ Î≥¥Ïù¥Í∏∞</label>
                            </div>
                            <div class="checkbox-group">
                                <input type="checkbox" id="showPronunciation" checked>
                                <label for="showPronunciation">Î∞úÏùå Î≥¥Ïù¥Í∏∞</label>
                            </div>
                            <div class="checkbox-group">
                                <input type="checkbox" id="showMeaning" checked>
                                <label for="showMeaning">Îúª Î≥¥Ïù¥Í∏∞</label>
                            </div>
                            <div class="checkbox-group">
                                <input type="checkbox" id="showExample" checked>
                                <label for="showExample">ÏòàÎ¨∏ Î≥¥Ïù¥Í∏∞</label>
                            </div>
                            <div class="checkbox-group">
                                <input type="checkbox" id="showExampleMeaning" checked>
                                <label for="showExampleMeaning">ÏòàÎ¨∏ Îúª Î≥¥Ïù¥Í∏∞</label>
                            </div>
                        </div>
                    </div>

                    <!-- Îç∞Ïù¥ÌÑ∞ Í¥ÄÎ¶¨ -->
                    <div class="setting-card">
                        <div class="setting-title">
                            üíæ Îç∞Ïù¥ÌÑ∞ Í¥ÄÎ¶¨
                        </div>
                        <div class="quick-actions">
                            <button class="quick-action-btn save-btn" onclick="saveData()">
                                <div class="icon">üíæ</div>
                                <div>Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû•</div>
                                <div style="font-size: 12px; opacity: 0.8;">JSON Îã§Ïö¥Î°úÎìú</div>
                            </button>
                            <button class="quick-action-btn load-btn" onclick="loadBackupData()">
                                <div class="icon">üìÇ</div>
                                <div>Î∞±ÏóÖ Î∂àÎü¨Ïò§Í∏∞</div>
                                <div style="font-size: 12px; opacity: 0.8;">JSON ÏóÖÎ°úÎìú</div>
                            </button>
                        </div>
                    </div>
                    <!-- Íµ¨Îß§ Í∏∞Î°ù -->
                    <div class="setting-card">
                        <div class="setting-title">
                            üõí Íµ¨Îß§ Í∏∞Î°ù
                        </div>
                        <div style="font-size: 14px; color: #6b7280;">
                            Ï¥ù Íµ¨Îß§Ìïú Îã®Ïñ¥Ïû•: <span id="purchaseCount">0</span>Í∞ú
                        </div>
                    </div>
                    <!-- Ï¥àÍ∏∞Ìôî -->
                    <div class="reset-section">
                        <button class="reset-btn" onclick="showResetModal()">
                            üóëÔ∏è ÌòÑÏû¨ Îã®Ïñ¥Ïû• Ï¥àÍ∏∞Ìôî
                        </button>
                    </div>
                    <!-- ÏôÑÏ†Ñ Ï¥àÍ∏∞Ìôî (Ï∂îÍ∞Ä) -->
                    <div class="setting-card" style="margin-top: 30px; border: 2px solid #ef4444;">
                        <div class="setting-title" style="color: #ef4444;">
                            ‚ö†Ô∏è ÏôÑÏ†Ñ Ï¥àÍ∏∞Ìôî (ÏúÑÌóò!)
                        </div>
                        <div style="font-size: 14px; color: #ef4444; margin-bottom: 15px;">
                            Î™®Îì† Îã®Ïñ¥Ïû•, ÌïôÏäµ Í∏∞Î°ù, Î≥¥Ïú† Î≥ÑÏù¥ ÏÇ≠Ï†úÎêòÎ©∞ Î≥µÍµ¨Ìï† Ïàò ÏóÜÏäµÎãàÎã§.
                        </div>
                        <button class="reset-btn" style="background: #dc2626;" onclick="showCompleteResetModal()">
                            üíÄ Ïñ¥Ìîå ÏôÑÏ†Ñ Ï¥àÍ∏∞Ìôî
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ÌïôÏäµ Î™®Îìú -->
    <div class="study-mode" id="studyMode">
        <div class="study-header">
            <div class="study-controls">
                <button class="study-control-btn" onclick="toggleFullscreen()">‚õ∂</button>
                <button class="study-control-btn" onclick="exitStudyMode()">‚úï</button>
            </div>
            <div style="color: white; font-weight: 600; font-size: 18px;">üìö ÌïôÏäµ Î™®Îìú</div>
            <div></div>
        </div>
        <div class="progress-bar">
            <div class="progress-fill" id="studyProgress"></div>
        </div>
        <div class="study-card">
            <div class="word-display" id="wordDisplay" onclick="toggleStudyPause()">
                <div class="word-text word-element" id="studyWordText">Îã®Ïñ¥</div>
                <div class="word-pronunciation word-element" id="studyWordPronunciation"></div>
                <div class="word-meaning word-element" id="studyWordMeaning">Îúª</div>
                <div class="word-example word-element" id="studyWordExample">ÏòàÎ¨∏</div>
                <div class="word-example-meaning word-element" id="studyWordExampleMeaning">ÏòàÎ¨∏ Îúª</div>
            </div>
        </div>
        <div class="pause-indicator hidden" id="pauseIndicator">ÏùºÏãúÏ†ïÏßÄ</div>
    </div>

    <!-- ÌÖåÏä§Ìä∏ Î™®Îìú -->
    <div class="test-mode" id="testMode">
        <div class="test-header">
            <div class="test-controls">
                <button class="study-control-btn" onclick="toggleFullscreen()">‚õ∂</button>
                <button class="study-control-btn" onclick="toggleTestPause()">||</button>
                <button class="study-control-btn" onclick="exitTestMode()">‚úï</button>
            </div>
            <div style="font-weight: 600; font-size: 18px;">TEST</div>
            <div class="test-stats">
                <div class="test-stat">
                    <span class="test-stat-value" id="testProgress">0/0</span>
                    <span class="test-stat-label">ÏßÑÌñâÎ•†</span>
                </div>
                <div class="test-stat">
                    <span class="test-stat-value" id="currentAccuracy">0%</span>
                    <span class="test-stat-label">Ï†ïÎãµÎ•†</span>
                </div>
            </div>
        </div>
        <div class="timer-bar">
            <div class="timer-fill" id="timerFill"></div>
        </div>
        <div class="test-card">
            <div class="question-card" id="questionCard">
                <div class="question-word" id="questionWord">Îã®Ïñ¥</div>
                <div class="question-example" id="questionExample">ÏòàÎ¨∏</div>
                <div class="question-example-meaning" id="questionExampleMeaning">ÏòàÎ¨∏ Îúª</div>
            </div>
            <div class="options-grid" id="optionsGrid">
                <!-- ÏÑ†ÌÉùÏßÄÎì§Ïù¥ Ïó¨Í∏∞Ïóê ÏÉùÏÑ±Îê©ÎãàÎã§ -->
            </div>
            <button class="dont-know-btn" onclick="selectDontKnow()">ü§î Î™®Î•¥Í≤†Ïñ¥Ïöî</button>
        </div>
    </div>

    <!-- Îã®Ïñ¥Ïû• ÏÑ†ÌÉù Î™®Îã¨ -->
    <div class="vocab-modal" id="vocabModal">
        <div class="vocab-modal-content">
            <div class="vocab-modal-header">
                <h3 class="vocab-modal-title">üìö Îã®Ïñ¥Ïû• ÏÑ†ÌÉù</h3>
                <input type="text" class="vocab-search" placeholder="üîç Í≤ÄÏÉâ..." onkeyup="filterVocabs(this.value)">
            </div>
            <div class="vocab-list" id="vocabList">
                <!-- Îã®Ïñ¥Ïû• Î™©Î°ùÏù¥ Ïó¨Í∏∞Ïóê ÌëúÏãúÎê©ÎãàÎã§ -->
            </div>
            <div class="vocab-modal-actions">
                <button class="vocab-action-btn primary" onclick="createNewVocab()">
                    <span>‚ûï</span>
                    <span>ÏÉà Îã®Ïñ¥Ïû• ÎßåÎì§Í∏∞</span>
                </button>
                <button class="vocab-action-btn secondary" onclick="closeVocabModal()">
                    Îã´Í∏∞
                </button>
            </div>
        </div>
    </div>

    <!-- Ï±ïÌÑ∞ Î™®Îã¨ -->
    <div class="chapter-modal" id="chapterModal">
        <div class="chapter-modal-content">
            <h3 class="chapter-modal-title" id="chapterModalTitle">Ï±ïÌÑ∞ 1</h3>
            <div class="chapter-modal-actions">
                <button class="chapter-modal-btn study" onclick="startStudyFromModal()">
                    üìö ÌïôÏäµ
                </button>
                <button class="chapter-modal-btn test" onclick="startTestFromModal()">
                    üìù ÌÖåÏä§Ìä∏
                </button>
                <button class="chapter-modal-btn close" onclick="closeChapterModal()">
                    Îã´Í∏∞
                </button>
            </div>
        </div>
    </div>

    <!-- Î™®Îã¨Îì§ -->
    <div class="modal" id="chapterSettingModal">
        <div class="modal-content">
            <h3>üìö Ï±ïÌÑ∞ ÏÑ§Ï†ï</h3>
            <p>Ï±ïÌÑ∞Îãπ ÎàÑÏ†ÅÌï† Îã®Ïñ¥ Í∞úÏàòÎ•º ÏÑ§Ï†ïÌï¥Ï£ºÏÑ∏Ïöî</p>
            <input type="number" class="chapter-setting-input" id="chapterSizeInput" 
                   min="10" max="200" value="10" placeholder="10">
            <div class="chapter-setting-hint">ÏµúÏÜå 10Í∞ú ~ ÏµúÎåÄ 200Í∞ú</div>
            <div class="modal-buttons">
                <button class="modal-btn yes" onclick="confirmChapterSetting()">ÌôïÏù∏</button>
            </div>
        </div>
    </div>

    <div class="modal" id="vocabNameModal">
        <div class="modal-content">
            <h3>üìö ÏÉà Îã®Ïñ¥Ïû• ÎßåÎì§Í∏∞</h3>
            <p>Îã®Ïñ¥Ïû• Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî</p>
            <input type="text" class="vocab-name-input" id="vocabNameInput" 
                   placeholder="Ïòà: TOEIC Í∏∞Ï¥à" maxlength="30">
            <div class="modal-buttons">
                <button class="modal-btn yes" onclick="confirmVocabName()">ÌôïÏù∏</button>
                <button class="modal-btn no" onclick="closeVocabNameModal()">Ï∑®ÏÜå</button>
            </div>
        </div>
    </div>

    <div class="modal" id="focusModal">
        <div class="modal-content">
            <h3>üéØ ÏßëÏ§ëÌïôÏäµ Î™®Îìú</h3>
            <p>ÏïΩÌïú Îã®Ïñ¥Îì§Î°úÎßå Íµ¨ÏÑ±Îêú ÌïôÏäµÏùÑ ÏãúÏûëÌïòÏãúÍ≤†ÏäµÎãàÍπå?</p>
            <div class="modal-buttons">
                <button class="modal-btn yes" onclick="startFocusStudy()">ÌïôÏäµ</button>
                <button class="modal-btn no" onclick="startFocusTest()">ÌÖåÏä§Ìä∏</button>
            </div>
            <button class="modal-btn" onclick="closeFocusModal()" style="margin-top: 10px; background: #6b7280; color: white;">Ï∑®ÏÜå</button>
        </div>
    </div>

    <div class="modal" id="resetModal">
        <div class="modal-content">
            <h3>üóëÔ∏è Îç∞Ïù¥ÌÑ∞ Ï¥àÍ∏∞Ìôî</h3>
            <p>ÌòÑÏû¨ Îã®Ïñ¥Ïû•Ïùò Î™®Îì† ÌïôÏäµ Îç∞Ïù¥ÌÑ∞Î•º Ï¥àÍ∏∞ÌôîÌïòÏãúÍ≤†ÏäµÎãàÍπå?</p>
            <p style="color: #ef4444; font-size: 14px;">Ïù¥ ÏûëÏóÖÏùÄ ÎêòÎèåÎ¶¥ Ïàò ÏóÜÏäµÎãàÎã§</p>
            <p style="color: #ef4444; font-size: 14px;">Îã®, Íµ¨Îß§Ìïú Îã®Ïñ¥Ïû•ÏùÄ Ïû¨Íµ¨Îß§ Î¨¥Î£å</p>
            <div class="modal-buttons">
                <button class="modal-btn yes" onclick="resetData()">Ïòà</button>
                <button class="modal-btn no" onclick="closeResetModal()">ÏïÑÎãàÏò§</button>
            </div>
        </div>
    </div>
    <div class="modal" id="completeResetModal1">
        <div class="modal-content">
            <h3 style="color: #ef4444;">‚ö†Ô∏è Í≤ΩÍ≥†: ÏôÑÏ†Ñ Ï¥àÍ∏∞Ìôî</h3>
            <p style="color: #ef4444; font-weight: 600;">Ï†ïÎßêÎ°ú Î™®Îì† Îç∞Ïù¥ÌÑ∞Î•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?</p>
            <p>Îã§Ïùå Ìï≠Î™©Îì§Ïù¥ <strong>ÏòÅÍµ¨Ï†ÅÏúºÎ°ú</strong> ÏÇ≠Ï†úÎê©ÎãàÎã§:</p>
            <ul style="text-align: left; margin: 20px 0; color: #4b5563;">
                <li>‚úì Î™®Îì† Îã®Ïñ¥Ïû•Í≥º Îã®Ïñ¥Îì§</li>
                <li>‚úì Î™®Îì† ÌïôÏäµ Í∏∞Î°ùÍ≥º ÌÜµÍ≥Ñ</li>
                <li>‚úì Î≥¥Ïú† Ï§ëÏù∏ Î≥Ñ <span id="resetStarCount" style="color: #f59e0b; font-weight: 600;"></span>Í∞ú</li>
                <li>‚úì Íµ¨Îß§Ìïú Îã®Ïñ¥Ïû• Í∏∞Î°ù (Ïû¨Íµ¨Îß§ ÌïÑÏöî)</li>
            </ul>
            <p style="color: #ef4444; font-size: 14px;">Ïù¥ ÏûëÏóÖÏùÄ ÎêòÎèåÎ¶¥ Ïàò ÏóÜÏäµÎãàÎã§!</p>
            <div class="modal-buttons">
                <button class="modal-btn yes" style="background: #ef4444;" onclick="showCompleteResetModal2()">Í≥ÑÏÜç</button>
                <button class="modal-btn no" style="background: #6b7280;" onclick="closeCompleteResetModal1()">Ï∑®ÏÜå</button>
            </div>
        </div>
    </div>

    <div class="modal" id="completeResetModal2">
        <div class="modal-content">
            <h3 style="color: #dc2626;">üíÄ ÏµúÏ¢Ö ÌôïÏù∏</h3>
            <p style="color: #dc2626; font-weight: 700; font-size: 18px;">Ï†ïÎßê ÌôïÏã§ÌïòÏã≠ÎãàÍπå?</p>
            <p>ÏßÄÍ∏à Ï∑®ÏÜåÌïòÏßÄ ÏïäÏúºÎ©¥ <strong style="color: #dc2626;">Î™®Îì† Í≤ÉÏù¥ ÏÇ¨ÎùºÏßëÎãàÎã§.</strong></p>
            <div style="background: #fee2e2; padding: 15px; border-radius: 10px; margin: 20px 0;">
                <p style="color: #991b1b; margin: 0;">
                    ÎßàÏßÄÎßâ Í∏∞ÌöåÏûÖÎãàÎã§. Ï†ïÎßêÎ°ú Ï≤òÏùåÎ∂ÄÌÑ∞ Îã§Ïãú ÏãúÏûëÌïòÏãúÍ≤†ÏäµÎãàÍπå?
                </p>
            </div>
            <div class="modal-buttons">
                <button class="modal-btn yes" style="background: #dc2626;" onclick="completeReset()">
                    ÏôÑÏ†Ñ Ï¥àÍ∏∞Ìôî Ïã§Ìñâ
                </button>
                <button class="modal-btn no" style="background: #10b981;" onclick="closeCompleteResetModal2()">
                    Ï∑®ÏÜå (ÏïàÏ†Ñ)
                </button>
            </div>
        </div>
    </div>

    <div class="modal" id="weakWordsRecommendModal">
        <div class="modal-content">
            <h3>üí° ÏïΩÌïúÎã®Ïñ¥ ÏßëÏ§ëÌïôÏäµ Í∂åÏû•</h3>
            <p>ÏïΩÌïú Îã®Ïñ¥Í∞Ä 10Í∞ú Ïù¥ÏÉÅ ÎàÑÏ†ÅÎêòÏóàÏäµÎãàÎã§.<br>ÏßëÏ§ëÌïôÏäµÏùÑ ÏßÑÌñâÌïòÏãúÍ≤†ÏäµÎãàÍπå?</p>
            <div class="modal-buttons">
                <button class="modal-btn yes" onclick="acceptWeakWordsRecommend()">Ïòà</button>
                <button class="modal-btn no" onclick="rejectWeakWordsRecommend()">ÏïÑÎãàÏò§</button>
            </div>
        </div>
    </div>

    <!-- Ïò®ÎùºÏù∏ Îã®Ïñ¥Ïû• Ïä§ÌÜ†Ïñ¥ Î™®Îã¨ -->
    <div class="vocab-modal" id="onlineVocabStoreModal">
        <div class="vocab-modal-content">
            <div class="vocab-modal-header">
                <h3 class="vocab-modal-title">üåê Ïò®ÎùºÏù∏ Îã®Ïñ¥Ïû• Ïä§ÌÜ†Ïñ¥</h3>
                <input type="text" class="vocab-search" id="onlineVocabSearch" placeholder="üîç Îã®Ïñ¥Ïû• Í≤ÄÏÉâ..." onkeyup="searchOnlineVocabs(this.value)">
            </div>
            
            <!-- Ïπ¥ÌÖåÍ≥†Î¶¨ ÌÉ≠ -->
            <div style="display: flex; gap: 8px; margin: 16px 0; flex-wrap: wrap;">
                <button class="category-tab active" onclick="filterByCategory('all')">Ï†ÑÏ≤¥</button>
                <button class="category-tab" onclick="filterByCategory('toeic')">TOEIC</button>
                <button class="category-tab" onclick="filterByCategory('school')">ÌïôÍµê</button>
                <button class="category-tab" onclick="filterByCategory('hobby')">Ï∑®ÎØ∏</button>
                <button class="category-tab" onclick="filterByCategory('basic')">Í∏∞Ï¥à</button>
            </div>
            
            <!-- Îã®Ïñ¥Ïû• Î™©Î°ù -->
            <div class="vocab-list" id="onlineVocabList">
                <div style="text-align: center; padding: 60px;">
                    <div class="loading-spinner">
                        <div class="spinner-circle"></div>
                    </div>
                    <p style="margin-top: 20px; color: #6b7280;">Îã®Ïñ¥Ïû• Î™©Î°ùÏùÑ Î∂àÎü¨Ïò§Îäî Ï§ë...</p>
                </div>
            </div>
            
            <div class="vocab-modal-actions">
                <button class="vocab-action-btn secondary" onclick="closeOnlineVocabStore()">
                    Îã´Í∏∞
                </button>
            </div>
            <div class="modal" id="vocabMergeModal">
                <div class="modal-content">
                    <h3>üìö Îã®Ïñ¥Ïû• Îã§Ïö¥Î°úÎìú</h3>
                    <p id="vocabMergeMessage">Îã§Ïö¥Î°úÎìúÌïú Îã®Ïñ¥Î•º ÌòÑÏû¨ Îã®Ïñ¥Ïû•Ïóê Ìï©ÏπòÏãúÍ≤†ÏäµÎãàÍπå?</p>
                    <p style="font-size: 14px; color: #6b7280; margin-top: 10px;">
                        'ÏïÑÎãàÏò§'Î•º ÏÑ†ÌÉùÌïòÎ©¥ ÏÉàÎ°úÏö¥ Îã®Ïñ¥Ïû•Ïù¥ ÏÉùÏÑ±Îê©ÎãàÎã§.
                    </p>
                    <div class="modal-buttons">
                        <button class="modal-btn yes" onclick="confirmVocabMerge(true)">Ïòà (Ìï©ÏπòÍ∏∞)</button>
                        <button class="modal-btn no" onclick="confirmVocabMerge(false)">ÏïÑÎãàÏò§ (ÏÉà Îã®Ïñ¥Ïû•)</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ÌîºÎìúÎ∞± ÏöîÏÜå -->
    <div class="feedback" id="feedback"></div>

    <!-- Îã§ÌÅ¨Î™®Îìú ÌÜ†Í∏Ä -->
    <button class="dark-mode-toggle" onclick="toggleDarkMode()">üåô</button>

    <!-- Î∞±ÏóÖ ÌååÏùº ÏûÖÎ†• -->
    <input type="file" id="backupInput" accept=".json">

    <script>
        // Ï†ÑÏó≠ Î≥ÄÏàò
        let appData = {
            vocabularies: {},
            currentVocabId: null,
            userStars: 1000,
            purchasedVocabs: [],
            globalMasteredWords: {},
            masteredWordIds: new Set(),
            globalSettings: {
                selectedVoice: '',
                wordTTS: true,
                exampleTTS: false,
                darkMode: false,
                studySpeed: 2.8,
                testWordTTS: true,
                testAnswerTTS: false,
                ttsPreload: 0,
                visibility: {
                    word: true,
                    pronunciation: true,
                    meaning: true,
                    example: true,
                    exampleMeaning: true
                }
            },
            version: 3
        };

        // Îã®Ïñ¥Ïû• Íµ¨Ï°∞
        class Vocabulary {
            constructor(name) {
                this.id = Date.now().toString();
                this.name = name;
                this.createdAt = new Date().toISOString();
                this.lastStudiedAt = null;
                this.totalStudyTime = 0;
                this.studyStreak = 0;
                this.lastStreakDate = null;
                this.words = [];
                this.chapters = [];
                this.statistics = {
                    totalCorrect: 0,
                    totalAttempts: 0
                };
                this.settings = {
                    chapterSize: 10
                };
                this.weakWordsRecommendCount = 0;
                this.studyProgress = {
                    chapterIndex: -1,
                    cardIndex: 0
                };
                this.testProgress = {
                    chapterIndex: -1,
                    currentIndex: 0,
                    answers: [],
                    questions: []
                };
                this.price = 0;
            }
        }

        let currentVocab = null;
        let currentChapter = 0;
        let currentStudyIndex = 0;
        let currentTestIndex = 0;
        let studyInterval = null;
        let testTimer = null;
        let timerInterval = null;
        let isPaused = false;
        let isTestPaused = false;
        let isStudyMode = false;
        let isTestMode = false;
        let testQuestions = [];
        let testAnswers = [];
        let availableVoices = [];
        let selectedVoice = null;
        let currentUtterance = null;
        let isSpeaking = false;
        let waitingForTTS = false;
        let selectedChapterIndex = 0;
        let isResuming = false; 
        let preloadTimeout = null;
        let studyStartTime = null;
        let pendingFiles = null;
        let cleanupList = [];
        let pendingOnlineVocabData = null; // Ïò®ÎùºÏù∏ Îã®Ïñ¥Ïû• ÏûÑÏãú Ï†ÄÏû•Ïö©
        let shouldMergeVocab = true; // Îã®Ïñ¥Ïû• Ìï©ÏπòÍ∏∞ Ïó¨Î∂Ä

        // Ï¥àÍ∏∞Ìôî
        document.addEventListener('DOMContentLoaded', function() {
            initializeVoices();
            loadSavedData();
            initSyncChannel(); // ÎèôÍ∏∞Ìôî Ï±ÑÎÑê Ï¥àÍ∏∞Ìôî
            
            document.getElementById('fileInput').addEventListener('change', handleFileUpload);
            document.getElementById('backupInput').addEventListener('change', handleBackupUpload);
            
            // Ï≤¥ÌÅ¨Î∞ïÏä§ Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà
            document.getElementById('wordMode').addEventListener('change', (e) => {
                appData.globalSettings.wordTTS = e.target.checked;
                checkBothTTSModes();
            });
            
            document.getElementById('exampleMode').addEventListener('change', (e) => {
                appData.globalSettings.exampleTTS = e.target.checked;
                checkBothTTSModes();
            });
            
            document.getElementById('testWordTTS').addEventListener('change', (e) => {
                appData.globalSettings.testWordTTS = e.target.checked;
            });
            
            document.getElementById('testAnswerTTS').addEventListener('change', (e) => {
                appData.globalSettings.testAnswerTTS = e.target.checked;
            });
            
            // Í∞ÄÏãúÏÑ± ÏÑ§Ï†ï Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà
            document.getElementById('showWord').addEventListener('change', (e) => {
                appData.globalSettings.visibility.word = e.target.checked;
                updateStudyCardVisibility();
            });
            
            document.getElementById('showPronunciation').addEventListener('change', (e) => {
                appData.globalSettings.visibility.pronunciation = e.target.checked;
                updateStudyCardVisibility();
            });
            
            document.getElementById('showMeaning').addEventListener('change', (e) => {
                appData.globalSettings.visibility.meaning = e.target.checked;
                updateStudyCardVisibility();
            });
            
            document.getElementById('showExample').addEventListener('change', (e) => {
                appData.globalSettings.visibility.example = e.target.checked;
                updateStudyCardVisibility();
            });
            
            document.getElementById('showExampleMeaning').addEventListener('change', (e) => {
                appData.globalSettings.visibility.exampleMeaning = e.target.checked;
                updateStudyCardVisibility();
            });
            
            // ÌéòÏù¥ÏßÄ Ïñ∏Î°úÎìú Ïãú Ï†ïÎ¶¨
            window.addEventListener('beforeunload', cleanup);
            
            // ÌÉ≠ Ìè¨Ïª§Ïä§ Ïãú ÎèôÍ∏∞Ìôî ÌôïÏù∏
            document.addEventListener('visibilitychange', () => {
                if (!document.hidden && syncChannel) {
                    // ÌÉ≠Ïù¥ ÌôúÏÑ±ÌôîÎêòÎ©¥ ÏÉÅÌÉú ÏöîÏ≤≠
                    syncChannel.postMessage({
                        type: 'request-state',
                        tabId: tabId,
                        timestamp: Date.now()
                    });
                }
            });
        });

        // Î¶¨ÏÜåÏä§ Ï†ïÎ¶¨
        function cleanup() {
            // Î∞òÏßùÏù¥ Ïù∏ÌÑ∞Î≤å Ï†ïÎ¶¨
            if (sparkleInterval) {
                clearInterval(sparkleInterval);
                sparkleInterval = null;
            }
            
            // Î™®Îì† ÌÉÄÏù¥Î®∏ Ï†ïÎ¶¨
            if (studyInterval) clearInterval(studyInterval);
            if (testTimer) clearTimeout(testTimer);
            if (timerInterval) clearInterval(timerInterval);
            if (preloadTimeout) clearTimeout(preloadTimeout);
            
            // ÏùåÏÑ± Ìï©ÏÑ± Ï§ëÎã®
            speechSynthesis.cancel();
            
            // DOM ÏöîÏÜå Ï†ïÎ¶¨
            cleanupList.forEach(element => {
                if (element && element.parentNode) {
                    element.parentNode.removeChild(element);
                }
            });
            
            // ÎèôÍ∏∞Ìôî Ï±ÑÎÑê Ï†ïÎ¶¨
            if (syncChannel) {
                syncChannel.postMessage({
                    type: 'tab-closing',
                    tabId: tabId,
                    wasLeader: isLeaderTab,
                    timestamp: Date.now()
                });
                syncChannel.close();
            }
            
            // Ï†ÑÏó≠ Î≥ÄÏàò Ï†ïÎ¶¨
            pendingFiles = null;
            currentUtterance = null;
        }

        // Îã®Ïñ¥Ïû• Í¥ÄÎ†® Ìï®ÏàòÎì§
        function showVocabModal() {
            displayVocabList();
            document.getElementById('vocabModal').style.display = 'flex';
        }

        function closeVocabModal() {
            document.getElementById('vocabModal').style.display = 'none';
        }

        function displayVocabList() {
            const vocabList = document.getElementById('vocabList');
            vocabList.innerHTML = '';
            
            Object.values(appData.vocabularies).forEach(vocab => {
                const item = document.createElement('div');
                item.className = 'vocab-item';
                if (vocab.id === appData.currentVocabId) {
                    item.classList.add('active');
                }
                
                const totalWords = vocab.words.length;
                const masteredWords = vocab.words.filter(w => w.weakness === 0 && w.correctCount >= 3).length;
                const progress = totalWords > 0 ? Math.round((masteredWords / totalWords) * 100) : 0;
                
                // Ïä§Ìä∏Î¶≠ Í≥ÑÏÇ∞
                const today = new Date().toDateString();
                const lastStudied = vocab.lastStudiedAt ? new Date(vocab.lastStudiedAt).toDateString() : null;
                let streakIcon = 'üíß';
                if (lastStudied === today) {
                    streakIcon = 'üî•';
                } else if (vocab.studyStreak > 0) {
                    streakIcon = '‚ùÑÔ∏è';
                }
                
item.innerHTML = `
                    <div class="vocab-item-info">
                        <div class="vocab-item-name">${vocab.name}</div>
                        <div class="vocab-item-stats">${totalWords}Í∞ú Îã®Ïñ¥ ‚Ä¢ ${progress}% ÏôÑÎ£å</div>
                    </div>
                    <div class="vocab-item-progress">
                        <div class="vocab-progress-bar">
                            <div class="vocab-progress-fill" style="width: ${progress}%"></div>
                        </div>
                        <div class="vocab-streak">${streakIcon}</div>
                    </div>
                `;
                
                // Ìé∏Ïßë/ÏÇ≠Ï†ú Î≤ÑÌäº Ï∂îÍ∞Ä
                const actionButtons = document.createElement('div');
                actionButtons.style.cssText = 'display: flex; gap: 8px; margin-left: 12px;';
                
                const editBtn = document.createElement('button');
                editBtn.innerHTML = '‚úèÔ∏è';
                editBtn.style.cssText = 'background: transparent; border: none; font-size: 18px; cursor: pointer; padding: 4px;';
                editBtn.onclick = (e) => {
                    e.stopPropagation();
                    editVocabulary(vocab.id);
                };
                
                const deleteBtn = document.createElement('button');
                deleteBtn.innerHTML = 'üóëÔ∏è';
                deleteBtn.style.cssText = 'background: transparent; border: none; font-size: 18px; cursor: pointer; padding: 4px;';
                deleteBtn.onclick = (e) => {
                    e.stopPropagation();
                    deleteVocabulary(vocab.id);
                };
                
                actionButtons.appendChild(editBtn);
                actionButtons.appendChild(deleteBtn);
                item.appendChild(actionButtons);
                
                item.onclick = () => selectVocabulary(vocab.id);
                vocabList.appendChild(item);            });
            
            if (Object.keys(appData.vocabularies).length === 0) {
                vocabList.innerHTML = '<div style="text-align: center; color: #6b7280; padding: 40px;">Îã®Ïñ¥Ïû•Ïù¥ ÏóÜÏäµÎãàÎã§</div>';
            }
        }

        function filterVocabs(searchTerm) {
            const items = document.querySelectorAll('.vocab-item');
            items.forEach(item => {
                const name = item.querySelector('.vocab-item-name').textContent.toLowerCase();
                if (name.includes(searchTerm.toLowerCase())) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        function createNewVocab() {
            closeVocabModal();
            document.getElementById('vocabNameModal').style.display = 'flex';
            document.getElementById('vocabNameInput').value = '';
            document.getElementById('vocabNameInput').focus();
        }

        function closeVocabNameModal() {
            document.getElementById('vocabNameModal').style.display = 'none';
        }

        function confirmVocabName() {
            const name = document.getElementById('vocabNameInput').value.trim();
            if (!name) {
                showFeedback('Îã®Ïñ¥Ïû• Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî', 'error');
                return;
            }
            
            // ÏßÑÌñâ Ï§ëÏù∏ ÏûëÏóÖ Ï§ëÎã®
            if (isStudyMode) exitStudyMode();
            if (isTestMode) exitTestMode();
            
            const newVocab = new Vocabulary(name);
            appData.vocabularies[newVocab.id] = newVocab;
            appData.currentVocabId = newVocab.id;
            currentVocab = newVocab;
            
            closeVocabNameModal();
            updateUI();
            autoSave();
            showFeedback(`üìö '${name}' Îã®Ïñ¥Ïû•Ïù¥ ÏÉùÏÑ±ÎêòÏóàÏäµÎãàÎã§`, 'success');
        }
        // Îã®Ïñ¥Ïû• Ïù¥Î¶Ñ Ìé∏Ïßë
        function editVocabulary(vocabId) {
            const vocab = appData.vocabularies[vocabId];
            if (!vocab) return;
            
            const newName = prompt('ÏÉà Îã®Ïñ¥Ïû• Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî:', vocab.name);
            if (newName && newName.trim() && newName.trim() !== vocab.name) {
                vocab.name = newName.trim();
                
                // ÌòÑÏû¨ ÏÑ†ÌÉùÎêú Îã®Ïñ¥Ïû•Ïù¥Î©¥ UI ÏóÖÎç∞Ïù¥Ìä∏
                if (vocabId === appData.currentVocabId) {
                    document.getElementById('currentVocabName').textContent = vocab.name;
                }
                
                displayVocabList();
                autoSave();
                showFeedback(`Îã®Ïñ¥Ïû• Ïù¥Î¶ÑÏù¥ '${newName}'ÏúºÎ°ú Î≥ÄÍ≤ΩÎêòÏóàÏäµÎãàÎã§`, 'success');
            }
        }
        
        // Îã®Ïñ¥Ïû• ÏÇ≠Ï†ú
        function deleteVocabulary(vocabId) {
            const vocab = appData.vocabularies[vocabId];
            if (!vocab) return;
            // Í∏∞Î≥∏ Îã®Ïñ¥Ïû• ÏÉùÏÑ±
        function createDefaultVocabulary() {
            const defaultVocab = new Vocabulary('Í∏∞Î≥∏ Îã®Ïñ¥Ïû•');
            appData.vocabularies[defaultVocab.id] = defaultVocab;
            appData.currentVocabId = defaultVocab.id;
            currentVocab = defaultVocab;
        }
            // Îã®Ïñ¥Ïû•Ïù¥ 1Í∞úÎøêÏù¥Î©¥ ÏÇ≠Ï†ú Î∂àÍ∞Ä
            if (Object.keys(appData.vocabularies).length === 1) {
                showFeedback('ÎßàÏßÄÎßâ Îã®Ïñ¥Ïû•ÏùÄ ÏÇ≠Ï†úÌï† Ïàò ÏóÜÏäµÎãàÎã§', 'error');
                return;
            }
            
            // Îã®Ïñ¥Í∞Ä ÏûàÏúºÎ©¥ ÌôïÏù∏
            if (vocab.words.length > 0) {
                if (!confirm(`'${vocab.name}'ÏóêÎäî ${vocab.words.length}Í∞úÏùò Îã®Ïñ¥Í∞Ä ÏûàÏäµÎãàÎã§.\nÏ†ïÎßê ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?\n\nÏù¥ ÏûëÏóÖÏùÄ ÎêòÎèåÎ¶¥ Ïàò ÏóÜÏäµÎãàÎã§.`)) {
                    return;
                }
            } else {
                if (!confirm(`'${vocab.name}' Îã®Ïñ¥Ïû•ÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?`)) {
                    return;
                }
            }
            
            // ÏÇ≠Ï†ú Ïã§Ìñâ
            delete appData.vocabularies[vocabId];
            
            // ÌòÑÏû¨ ÏÑ†ÌÉùÎêú Îã®Ïñ¥Ïû•Ïù¥Î©¥ Îã§Î•∏ Îã®Ïñ¥Ïû•ÏúºÎ°ú Ï†ÑÌôò
            if (vocabId === appData.currentVocabId) {
                const remainingVocabs = Object.keys(appData.vocabularies);
                if (remainingVocabs.length > 0) {
                    appData.currentVocabId = remainingVocabs[0];
                    currentVocab = appData.vocabularies[appData.currentVocabId];
                } else {
                    // ÎßåÏïΩ ÏóÜÏúºÎ©¥ Í∏∞Î≥∏ Îã®Ïñ¥Ïû• ÏÉùÏÑ±
                    createDefaultVocabulary();
                }
            }
            
            closeVocabModal();
            updateUI();
            autoSave();
            showFeedback(`'${vocab.name}' Îã®Ïñ¥Ïû•Ïù¥ ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§`, 'success');
        }

        function selectVocabulary(vocabId) {
            if (vocabId === appData.currentVocabId) {
                closeVocabModal();
                return;
            }

            // ÏßÑÌñâ Ï§ëÏù∏ ÏûëÏóÖ Ï§ëÎã®
            if (isStudyMode) exitStudyMode();
            if (isTestMode) exitTestMode();
            
            appData.currentVocabId = vocabId;
            currentVocab = appData.vocabularies[vocabId];
            
            closeVocabModal();
            updateUI();
            autoSave();
            
            // Îã®Ïñ¥Ïû• Ï†ÑÌôò ÏïåÎ¶º
            broadcastDataChange('vocab-switch', { vocabId: vocabId });
            
            showFeedback(`üìö '${currentVocab.name}' Îã®Ïñ¥Ïû•ÏúºÎ°ú Ï†ÑÌôòÌñàÏäµÎãàÎã§`, 'success');
        }

        function updateVocabStreak() {
            if (!currentVocab) return;
            
            const today = new Date().toDateString();
            const lastStudied = currentVocab.lastStudiedAt ? new Date(currentVocab.lastStudiedAt).toDateString() : null;
            const lastStreak = currentVocab.lastStreakDate ? new Date(currentVocab.lastStreakDate).toDateString() : null;
            
            if (lastStudied !== today) {
                // Ïò§Îäò Ï≤òÏùå ÌïôÏäµ
                currentVocab.lastStudiedAt = new Date().toISOString();
                
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);
                const yesterdayStr = yesterday.toDateString();
                
                if (lastStreak === yesterdayStr) {
                    // Ïó∞ÏÜç ÌïôÏäµ
                    currentVocab.studyStreak++;
                } else {
                    // Ïó∞ÏÜç ÌïôÏäµ ÎÅäÍπÄ
                    currentVocab.studyStreak = 1;
                }
                
                currentVocab.lastStreakDate = new Date().toISOString();
            }
        }

        function updateUI() {
                // Î≥µÏõê Ï§ëÏù¥Î©¥ ÏßÑÌñâÏÉÅÌô© Ï≤¥ÌÅ¨ ÏÉùÎûµ
            if (isResuming) {
                if (!currentVocab) {
                    document.getElementById('currentVocabName').textContent = 'Îã®Ïñ¥Ïû• ÏÑ†ÌÉù';
                    // ... ÎÇòÎ®∏ÏßÄ ÏΩîÎìú
                } else {
                    document.getElementById('currentVocabName').textContent = currentVocab.name;
                    updateStats();
                    if (document.getElementById('purchaseCount')) {
                        document.getElementById('purchaseCount').textContent = (appData.purchasedVocabs || []).length;
                    }
                    displayChapters();
                    updateWeakWordsList();
                }
                return;  // checkAndResumeProgress Ìò∏Ï∂úÌïòÏßÄ ÏïäÏùå
            }
    
            if (!currentVocab) {
                document.getElementById('currentVocabName').textContent = 'Îã®Ïñ¥Ïû• ÏÑ†ÌÉù';
                document.getElementById('totalWords').textContent = '0';
                document.getElementById('weakWords').textContent = '0';
                document.getElementById('accuracy').textContent = '0%';
                document.getElementById('chapterList').innerHTML = '<div style="text-align: center; color: #6b7280; padding: 60px;">Îã®Ïñ¥Ïû•ÏùÑ ÏÑ†ÌÉùÌïòÍ±∞ÎÇò ÏÉàÎ°ú ÎßåÎì§Ïñ¥Ï£ºÏÑ∏Ïöî</div>';
                document.getElementById('weakWordsList').innerHTML = '<div style="text-align: center; color: #6b7280; padding: 40px;">ÏïΩÌïú Îã®Ïñ¥Í∞Ä ÏóÜÏäµÎãàÎã§</div>';
                return;
            }
            
            document.getElementById('currentVocabName').textContent = currentVocab.name;
            updateStats();
            displayChapters();
            updateWeakWordsList();
            
            // ÏßÑÌñâ Ï§ëÏù∏ ÌïôÏäµ/ÌÖåÏä§Ìä∏ ÏûêÎèô Î≥µÏõê
            checkAndResumeProgress();
        }

        // ÏßÑÌñâÏÉÅÌô© Ï≤¥ÌÅ¨ Î∞è ÏûêÎèô Î≥µÏõê
        // ÏßÑÌñâÏÉÅÌô© Ï≤¥ÌÅ¨ Î∞è ÏûêÎèô Î≥µÏõê
        function checkAndResumeProgress() {
            if (!currentVocab || isResuming) return;
            
            // ÌòÑÏû¨ ÌïôÏäµ/ÌÖåÏä§Ìä∏ Î™®ÎìúÍ∞Ä ÏïÑÎãê ÎïåÎßå Î≥µÏõê
            if (!isStudyMode && !isTestMode) {
                // ÌïôÏäµ ÏßÑÌñâÏÉÅÌô© ÌôïÏù∏
                if (currentVocab.studyProgress && 
                    currentVocab.studyProgress.chapterIndex >= 0 && 
                    currentVocab.studyProgress.chapterIndex < currentVocab.chapters.length &&
                    currentVocab.studyProgress.cardIndex > 0) {
                    
                    isResuming = true;  // ÌîåÎûòÍ∑∏ ÏÑ§Ï†ï
                    console.log('ÌïôÏäµ ÏßÑÌñâÏÉÅÌô© Î∞úÍ≤¨, ÏûêÎèô Î≥µÏõê Ï§ë...');
                    resumeStudy();
                    
                    // 1Ï¥à ÌõÑ ÌîåÎûòÍ∑∏ Ìï¥Ï†ú
                    setTimeout(() => {
                        isResuming = false;
                    }, 1000);
                    return;
                }
                
                // ÌÖåÏä§Ìä∏ ÏßÑÌñâÏÉÅÌô© ÌôïÏù∏
                if (currentVocab.testProgress && 
                    currentVocab.testProgress.chapterIndex >= 0 && 
                    currentVocab.testProgress.chapterIndex < currentVocab.chapters.length &&
                    currentVocab.testProgress.currentIndex > 0 &&
                    currentVocab.testProgress.questions.length > 0) {
                    
                    isResuming = true;  // ÌîåÎûòÍ∑∏ ÏÑ§Ï†ï
                    console.log('ÌÖåÏä§Ìä∏ ÏßÑÌñâÏÉÅÌô© Î∞úÍ≤¨, ÏûêÎèô Î≥µÏõê Ï§ë...');
                    resumeTest();
                    
                    // 1Ï¥à ÌõÑ ÌîåÎûòÍ∑∏ Ìï¥Ï†ú
                    setTimeout(() => {
                        isResuming = false;
                    }, 1000);
                    return;
                }
            }
        }
        // ÌïôÏäµ ÏßÑÌñâÏÉÅÌô© Î≥µÏõê
        function resumeStudy() {
            const progress = currentVocab.studyProgress;
            const chapter = currentVocab.chapters[progress.chapterIndex];
            
            if (!chapter) {
                console.error('Î≥µÏõêÌï† Ï±ïÌÑ∞Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§');
                // ÏßÑÌñâÏÉÅÌô© Ï¥àÍ∏∞Ìôî
                currentVocab.studyProgress = { chapterIndex: -1, cardIndex: 0 };
                autoSave();
                return;
            }
            
            const chapterWords = getChapterWords(chapter);
            if (progress.cardIndex >= chapterWords.length) {
                console.error('ÏßÑÌñâÏÉÅÌô©Ïù¥ Ïú†Ìö®ÌïòÏßÄ ÏïäÏäµÎãàÎã§');
                // ÏßÑÌñâÏÉÅÌô© Ï¥àÍ∏∞Ìôî
                currentVocab.studyProgress = { chapterIndex: -1, cardIndex: 0 };
                autoSave();
                return;
            }
            
            // ÌïôÏäµ ÏÉÅÌÉú Î≥µÏõê
            currentChapter = progress.chapterIndex;
            currentStudyIndex = progress.cardIndex;
            
            console.log(`ÌïôÏäµ Î≥µÏõê: Ï±ïÌÑ∞ ${currentChapter + 1}, Ïπ¥Îìú ${currentStudyIndex + 1}/${chapterWords.length}`);
            
            // ÌïôÏäµ Î™®Îìú ÏãúÏûë
            isStudyMode = true;
            isPaused = false;
            studyStartTime = Date.now();
            
            updateVocabStreak();
            document.getElementById('studyMode').style.display = 'flex';
            showCurrentStudyCard();
            startStudyTimer();
        }

        // ÌÖåÏä§Ìä∏ ÏßÑÌñâÏÉÅÌô© Î≥µÏõê
        function resumeTest() {
            const progress = currentVocab.testProgress;
            const chapter = currentVocab.chapters[progress.chapterIndex];
            
            if (!chapter) {
                console.error('Î≥µÏõêÌï† ÌÖåÏä§Ìä∏ Ï±ïÌÑ∞Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§');
                // ÏßÑÌñâÏÉÅÌô© Ï¥àÍ∏∞Ìôî
                currentVocab.testProgress = { chapterIndex: -1, currentIndex: 0, answers: [], questions: [] };
                autoSave();
                return;
            }
            
            if (progress.currentIndex >= progress.questions.length) {
                console.error('ÌÖåÏä§Ìä∏ ÏßÑÌñâÏÉÅÌô©Ïù¥ Ïú†Ìö®ÌïòÏßÄ ÏïäÏäµÎãàÎã§');
                // ÏßÑÌñâÏÉÅÌô© Ï¥àÍ∏∞Ìôî
                currentVocab.testProgress = { chapterIndex: -1, currentIndex: 0, answers: [], questions: [] };
                autoSave();
                return;
            }
            
            // ÌÖåÏä§Ìä∏ ÏÉÅÌÉú Î≥µÏõê
            currentChapter = progress.chapterIndex;
            currentTestIndex = progress.currentIndex;
            testAnswers = [...progress.answers];
            testQuestions = [...progress.questions];
            
            console.log(`ÌÖåÏä§Ìä∏ Î≥µÏõê: Ï±ïÌÑ∞ ${currentChapter + 1}, Î¨∏Ï†ú ${currentTestIndex + 1}/${testQuestions.length}`);
            
            // ÌÖåÏä§Ìä∏ Î™®Îìú ÏãúÏûë
            isTestMode = true;
            isTestPaused = false;
            
            document.getElementById('testMode').style.display = 'flex';
            updateTestStats();
            showCurrentTestQuestion();
        }

        // IndexedDB ÏÑ§Ï†ï
        let db = null;
        const DB_NAME = 'WordMasterDB';
        const DB_VERSION = 1;

        // IndexedDB Ï¥àÍ∏∞Ìôî
        async function initIndexedDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                
                request.onerror = () => {
                    console.error('IndexedDB Ïó¥Í∏∞ Ïã§Ìå®');
                    reject(request.error);
                };
                
                request.onsuccess = () => {
                    db = request.result;
                    console.log('IndexedDB Ïó∞Í≤∞ ÏÑ±Í≥µ');
                    resolve(db);
                };
                
                request.onupgradeneeded = (event) => {
                    db = event.target.result;
                    
                    // Í∞ùÏ≤¥ Ï†ÄÏû•ÏÜå ÏÉùÏÑ±
                    if (!db.objectStoreNames.contains('appData')) {
                        db.createObjectStore('appData');
                    }
                };
            });
        }

        // IndexedDBÏóê Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû•
        async function saveToIndexedDB(data) {
            if (!db) return false;
            
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['appData'], 'readwrite');
                const store = transaction.objectStore('appData');
                const request = store.put(data, 'mainData');
                
                request.onsuccess = () => {
                    console.log('IndexedDB Ï†ÄÏû• ÏÑ±Í≥µ');
                    resolve(true);
                };
                
                request.onerror = () => {
                    console.error('IndexedDB Ï†ÄÏû• Ïã§Ìå®:', request.error);
                    reject(request.error);
                };
            });
        }

        // IndexedDBÏóêÏÑú Îç∞Ïù¥ÌÑ∞ Î°úÎìú
        async function loadFromIndexedDB() {
            if (!db) return null;
            
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['appData'], 'readonly');
                const store = transaction.objectStore('appData');
                const request = store.get('mainData');
                
                request.onsuccess = () => {
                    console.log('IndexedDB Î°úÎìú ÏÑ±Í≥µ');
                    resolve(request.result);
                };
                
                request.onerror = () => {
                    console.error('IndexedDB Î°úÎìú Ïã§Ìå®:', request.error);
                    reject(request.error);
                };
            });
        }

        // Ï†ÄÏû•Îêú Îç∞Ïù¥ÌÑ∞ Î°úÎìú
        async function loadSavedData() {
            try {
                // IndexedDB Ï¥àÍ∏∞Ìôî
                await initIndexedDB();
                
                // IndexedDBÏóêÏÑú Î®ºÏ†Ä ÏãúÎèÑ
                let data = await loadFromIndexedDB();
                
                // IndexedDBÏóê ÏóÜÏúºÎ©¥ localStorageÏóêÏÑú ÏãúÎèÑ
                if (!data) {
                    const saved = localStorage.getItem('wordMasterData');
                    if (saved) {
                        data = JSON.parse(saved);
                        // localStorage Îç∞Ïù¥ÌÑ∞Î•º IndexedDBÎ°ú ÎßàÏù¥Í∑∏Î†àÏù¥ÏÖò
                        await saveToIndexedDB(data);
                        console.log('localStorage Îç∞Ïù¥ÌÑ∞Î•º IndexedDBÎ°ú ÎßàÏù¥Í∑∏Î†àÏù¥ÏÖò ÏôÑÎ£å');
                    }
                }
                
                if (data) {
                    if (data.version === 3) {
                        appData = data;
                        // Î≥ÑÍ≥º ÎßàÏä§ÌÑ∞ Îã®Ïñ¥ Ï¥àÍ∏∞Ìôî
                        if (!appData.userStars) appData.userStars = 1000;
                        if (!appData.purchasedVocabs) appData.purchasedVocabs = [];
                        if (!appData.globalMasteredWords) appData.globalMasteredWords = {};
                        if (!appData.masteredWordIds) appData.masteredWordIds = [];
                    } else {
                        
                        // Ïù¥Ï†Ñ Î≤ÑÏ†Ñ ÎßàÏù¥Í∑∏Î†àÏù¥ÏÖò
                        migrateOldData(data);
                    }
                    
                    // ÌòÑÏû¨ Îã®Ïñ¥Ïû• ÏÑ§Ï†ï
                    if (appData.currentVocabId && appData.vocabularies[appData.currentVocabId]) {
                        currentVocab = appData.vocabularies[appData.currentVocabId];
                    }
                    
                    // Í∏ÄÎ°úÎ≤å ÏÑ§Ï†ï Î≥µÏõê
                    restoreGlobalSettings();
                }
                
                // Îã®Ïñ¥Ïû•Ïù¥ ÌïòÎÇòÎèÑ ÏóÜÏúºÎ©¥ Í∏∞Î≥∏ Îã®Ïñ¥Ïû• ÏÉùÏÑ±
                if (Object.keys(appData.vocabularies).length === 0) {
                    const defaultVocab = new Vocabulary('Í∏∞Î≥∏ Îã®Ïñ¥Ïû•');
                    appData.vocabularies[defaultVocab.id] = defaultVocab;
                    appData.currentVocabId = defaultVocab.id;
                    currentVocab = defaultVocab;
                }
                
                updateUI();
            } catch (error) {
                console.error('Failed to load saved data:', error);
                showFeedback('Ï†ÄÏû•Îêú Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§ÎäîÎç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§', 'error');
            }
        }

        // Ïù¥Ï†Ñ Î≤ÑÏ†Ñ Îç∞Ïù¥ÌÑ∞ ÎßàÏù¥Í∑∏Î†àÏù¥ÏÖò
        function migrateOldData(oldData) {
            if (!oldData.words || oldData.words.length === 0) return;
            
            // Í∏∞Î≥∏ Îã®Ïñ¥Ïû• ÏÉùÏÑ±
            const defaultVocab = new Vocabulary('Í∏∞Î≥∏ Îã®Ïñ¥Ïû•');
            defaultVocab.words = oldData.words || [];
            defaultVocab.chapters = oldData.chapters || [];
            defaultVocab.statistics = oldData.statistics || { totalCorrect: 0, totalAttempts: 0 };
            defaultVocab.settings.chapterSize = oldData.settings?.chapterSize || 10;
            defaultVocab.weakWordsRecommendCount = oldData.weakWordsRecommendCount || 0;
            
            appData.vocabularies[defaultVocab.id] = defaultVocab;
            appData.currentVocabId = defaultVocab.id;
            
            // Í∏ÄÎ°úÎ≤å ÏÑ§Ï†ï ÎßàÏù¥Í∑∏Î†àÏù¥ÏÖò
            if (oldData.settings) {
                appData.globalSettings = {
                    selectedVoice: oldData.settings.selectedVoice || '',
                    wordTTS: oldData.settings.wordTTS !== false,
                    exampleTTS: oldData.settings.exampleTTS === true,
                    darkMode: oldData.settings.darkMode === true,
                    studySpeed: oldData.settings.studySpeed || 2.8,
                    testWordTTS: oldData.settings.testWordTTS !== false,
                    testAnswerTTS: oldData.settings.testAnswerTTS === true,
                    ttsPreload: oldData.settings.ttsPreload || 0,
                    visibility: oldData.settings.visibility || {
                        word: true,
                        pronunciation: true,
                        meaning: true,
                        example: true,
                        exampleMeaning: true
                    }
                };
            }
        }

        // Í∏ÄÎ°úÎ≤å ÏÑ§Ï†ï Î≥µÏõê
        function restoreGlobalSettings() {
            const settings = appData.globalSettings;
            
            // ÏùåÏÑ± ÏÑ§Ï†ï
            if (settings.selectedVoice) {
                document.getElementById('voiceSelect').value = settings.selectedVoice;
            }
            
            // Ï≤¥ÌÅ¨Î∞ïÏä§ ÏÑ§Ï†ï
            document.getElementById('wordMode').checked = settings.wordTTS !== false;
            document.getElementById('exampleMode').checked = settings.exampleTTS === true;
            document.getElementById('testWordTTS').checked = settings.testWordTTS !== false;
            document.getElementById('testAnswerTTS').checked = settings.testAnswerTTS === true;
            
            // Ïä¨ÎùºÏù¥Îçî ÏÑ§Ï†ï
            document.getElementById('studySpeedSlider').value = settings.studySpeed * 10;
            updateStudySpeed();
            
            document.getElementById('ttsPreloadSlider').value = (settings.ttsPreload || 0) * 10;
            updateTTSPreload();
            
            // Í∞ÄÏãúÏÑ± ÏÑ§Ï†ï
            if (settings.visibility) {
                document.getElementById('showWord').checked = settings.visibility.word !== false;
                document.getElementById('showPronunciation').checked = settings.visibility.pronunciation !== false;
                document.getElementById('showMeaning').checked = settings.visibility.meaning !== false;
                document.getElementById('showExample').checked = settings.visibility.example !== false;
                document.getElementById('showExampleMeaning').checked = settings.visibility.exampleMeaning !== false;
            }
            
            // Îã§ÌÅ¨Î™®Îìú
            if (settings.darkMode) {
                document.body.classList.add('dark-mode');
                document.querySelector('.dark-mode-toggle').textContent = '‚òÄÔ∏è';
            }
        }

        // BroadcastChannel ÏÑ§Ï†ï
        let syncChannel = null;
        let tabId = Date.now().toString();
        let isLeaderTab = false;
        let lastSyncTime = Date.now();
        
        // BroadcastChannel Ï¥àÍ∏∞Ìôî
        function initSyncChannel() {
            try {
                syncChannel = new BroadcastChannel('word-master-sync');
                
                // Î©îÏãúÏßÄ ÏàòÏã† Ï≤òÎ¶¨
                syncChannel.onmessage = (event) => {
                    handleSyncMessage(event.data);
                };
                
                // ÌÉ≠ ÌôúÏÑ±Ìôî ÏïåÎ¶º
                announceTab();
                
                // Î¶¨Îçî ÏÑ†Ï∂ú
                requestLeaderElection();
                
                console.log('ÎèôÍ∏∞Ìôî Ï±ÑÎÑê Ï¥àÍ∏∞Ìôî ÏôÑÎ£å:', tabId);
            } catch (error) {
                console.warn('BroadcastChannelÏùÑ ÏßÄÏõêÌïòÏßÄ ÏïäÎäî Î∏åÎùºÏö∞Ï†ÄÏûÖÎãàÎã§:', error);
            }
        }
        
        // ÎèôÍ∏∞Ìôî Î©îÏãúÏßÄ Ï≤òÎ¶¨
        function handleSyncMessage(message) {
            switch (message.type) {
                case 'data-update':
                    if (message.tabId !== tabId && message.timestamp > lastSyncTime) {
                        handleRemoteDataUpdate(message);
                    }
                    break;
                    
                case 'tab-announce':
                    if (message.tabId !== tabId) {
                        // Îã§Î•∏ ÌÉ≠Ïù¥ ÏûàÏùåÏùÑ Ïù∏ÏßÄ
                        if (isLeaderTab) {
                            sendCurrentState();
                        }
                    }
                    break;
                    
                case 'request-leader':
                    participateInLeaderElection();
                    break;
                    
                case 'leader-elected':
                    if (message.tabId !== tabId) {
                        isLeaderTab = false;
                    }
                    break;
                    
                case 'request-state':
                    if (isLeaderTab) {
                        sendCurrentState();
                    }
                    break;
                    
                case 'tab-closing':
                    if (message.wasLeader && message.tabId !== tabId) {
                        // Î¶¨ÎçîÍ∞Ä Îã´ÌûàÎ©¥ ÏÉà Î¶¨Îçî ÏÑ†Ï∂ú
                        setTimeout(requestLeaderElection, 100);
                    }
                    break;
            }
        }
        
        // ÏõêÍ≤© Îç∞Ïù¥ÌÑ∞ ÏóÖÎç∞Ïù¥Ìä∏ Ï≤òÎ¶¨ - ÏßÑÌñâÏÉÅÌô© Î≥¥Ìò∏
        async function handleRemoteDataUpdate(message) {
            console.log('Îã§Î•∏ ÌÉ≠ÏóêÏÑú Îç∞Ïù¥ÌÑ∞ Î≥ÄÍ≤Ω Í∞êÏßÄ:', message.changeType);
            
            // Î≥µÏõê Ï§ëÏù¥Î©¥ Î¨¥Ïãú
            if (isResuming) {
                console.log('Î≥µÏõê Ï§ëÏù¥ÎØÄÎ°ú ÎèôÍ∏∞Ìôî Í±¥ÎÑàÎúÄ');
                return;
            }
    
            // ÏßÑÌñâ Ï§ëÏù∏ ÏûëÏóÖ ÌôïÏù∏
            if (isStudyMode || isTestMode) {
                // ÌïôÏäµ/ÌÖåÏä§Ìä∏ Ï§ëÏù¥Î©¥ Í≤ΩÍ≥†Îßå ÌëúÏãúÌïòÍ≥† ÎèôÍ∏∞ÌôîÌïòÏßÄ ÏïäÏùå
                showFeedback('Îã§Î•∏ ÌÉ≠ÏóêÏÑú Îç∞Ïù¥ÌÑ∞Í∞Ä Î≥ÄÍ≤ΩÎêòÏóàÏäµÎãàÎã§. ÌòÑÏû¨ ÏûëÏóÖ ÏôÑÎ£å ÌõÑ ÎèôÍ∏∞ÌôîÎê©ÎãàÎã§.', 'warning');
                return;
            }
            
            // ÌòÑÏû¨ ÏßÑÌñâÏÉÅÌô© Î∞±ÏóÖ
            let studyProgressBackup = null;
            let testProgressBackup = null;
            
            if (currentVocab) {
                studyProgressBackup = { ...currentVocab.studyProgress };
                testProgressBackup = { ...currentVocab.testProgress };
            }
            
            // Îç∞Ïù¥ÌÑ∞ ÎèôÍ∏∞Ìôî
            try {
                lastSyncTime = message.timestamp;
                
                if (message.fullData) {
                    // Ï†ÑÏ≤¥ Îç∞Ïù¥ÌÑ∞ ÎèôÍ∏∞Ìôî
                    appData = message.fullData;
                    if (appData.currentVocabId && appData.vocabularies[appData.currentVocabId]) {
                        currentVocab = appData.vocabularies[appData.currentVocabId];
                        
                        // ÏßÑÌñâÏÉÅÌô© Î≥µÏõê
                        if (studyProgressBackup && studyProgressBackup.chapterIndex >= 0) {
                            currentVocab.studyProgress = studyProgressBackup;
                        }
                        if (testProgressBackup && testProgressBackup.chapterIndex >= 0) {
                            currentVocab.testProgress = testProgressBackup;
                        }
                    }
                } else {
                    // Î∂ÄÎ∂Ñ ÏóÖÎç∞Ïù¥Ìä∏
                    await loadFromIndexedDB();
                }
                
                // UI ÏóÖÎç∞Ïù¥Ìä∏
                updateUI();
                showFeedback('Îç∞Ïù¥ÌÑ∞Í∞Ä ÎèôÍ∏∞ÌôîÎêòÏóàÏäµÎãàÎã§', 'success');
            } catch (error) {
                console.error('ÎèôÍ∏∞Ìôî Ïã§Ìå®:', error);
            }
        }
        
        // ÌÉ≠ ÌôúÏÑ±Ìôî ÏïåÎ¶º
        function announceTab() {
            if (syncChannel) {
                syncChannel.postMessage({
                    type: 'tab-announce',
                    tabId: tabId,
                    timestamp: Date.now()
                });
            }
        }
        
        // Î¶¨Îçî ÏÑ†Ï∂ú ÏöîÏ≤≠
        function requestLeaderElection() {
            if (syncChannel) {
                isLeaderTab = true; // ÏùºÎã® ÏûêÏã†ÏùÑ Î¶¨ÎçîÎ°ú Í∞ÄÏ†ï
                
                syncChannel.postMessage({
                    type: 'request-leader',
                    tabId: tabId,
                    timestamp: Date.now()
                });
                
                // 100ms ÌõÑÏóêÎèÑ Îã§Î•∏ Î¶¨ÎçîÍ∞Ä ÏóÜÏúºÎ©¥ ÏûêÏã†Ïù¥ Î¶¨Îçî
                setTimeout(() => {
                    if (isLeaderTab) {
                        syncChannel.postMessage({
                            type: 'leader-elected',
                            tabId: tabId,
                            timestamp: Date.now()
                        });
                        console.log('Î¶¨Îçî ÌÉ≠ÏúºÎ°ú ÏÑ†Ï∂úÎê®:', tabId);
                    }
                }, 100);
            }
        }
        
        // Î¶¨Îçî ÏÑ†Ï∂ú Ï∞∏Ïó¨
        function participateInLeaderElection() {
            if (syncChannel && isLeaderTab) {
                syncChannel.postMessage({
                    type: 'leader-elected',
                    tabId: tabId,
                    timestamp: Date.now()
                });
            }
        }
        
        // ÌòÑÏû¨ ÏÉÅÌÉú Ï†ÑÏÜ°
        function sendCurrentState() {
            if (syncChannel) {
                syncChannel.postMessage({
                    type: 'data-update',
                    tabId: tabId,
                    timestamp: Date.now(),
                    changeType: 'full-sync',
                    fullData: appData
                });
            }
        }
        
        // Îç∞Ïù¥ÌÑ∞ Î≥ÄÍ≤Ω Ïãú Î∏åÎ°úÎìúÏ∫êÏä§Ìä∏
        function broadcastDataChange(changeType, details = {}) {
            if (syncChannel) {
                lastSyncTime = Date.now();
                
                const message = {
                    type: 'data-update',
                    tabId: tabId,
                    timestamp: lastSyncTime,
                    changeType: changeType,
                    details: details
                };
                
                // Ï§ëÏöîÌïú Î≥ÄÍ≤ΩÏÇ¨Ìï≠ÏùÄ Ï†ÑÏ≤¥ Îç∞Ïù¥ÌÑ∞ Ìè¨Ìï®
                if (['vocab-switch', 'word-upload', 'reset'].includes(changeType)) {
                    message.fullData = appData;
                }
                
                syncChannel.postMessage(message);
            }
        }
        
        // Îç∞Ïù¥ÌÑ∞ ÏûêÎèô Ï†ÄÏû• (ÎèôÍ∏∞Ìôî Ìè¨Ìï®)
        async function autoSave() {
            try {
                const dataStr = JSON.stringify(appData);
                
                // ÌÅ¨Í∏∞ Ï≤¥ÌÅ¨
                const sizeInMB = dataStr.length / (1024 * 1024);
                if (sizeInMB > 5) {
                    console.warn(`Data size: ${sizeInMB.toFixed(2)}MB exceeds recommended limit`);
                    
                    // ÏûêÎèô Î∞±ÏóÖ ÏÉùÏÑ±
                    await createAutoBackup();
                    
                    // Ïò§ÎûòÎêú Îç∞Ïù¥ÌÑ∞ Ï†ïÎ¶¨ Ï†úÏïà
                    const oldestVocab = findOldestUnusedVocabulary();
                    if (oldestVocab) {
                        showFeedback(`Ï†ÄÏû• Í≥µÍ∞ÑÏù¥ Î∂ÄÏ°±Ìï©ÎãàÎã§. Ïò§ÎûòÎêú Îã®Ïñ¥Ïû• '${oldestVocab.name}'ÏùÑ ÏÇ≠Ï†úÌïòÍ±∞ÎÇò Î∞±ÏóÖ ÌõÑ Ï†ïÎ¶¨Ìï¥Ï£ºÏÑ∏Ïöî.`, 'warning');
                    }
                    
                    // Í∑∏ÎûòÎèÑ Ï†ÄÏû•ÏùÄ ÏãúÎèÑ
                }
                
                // IndexedDBÏóê Ï†ÄÏû•
                if (db) {
                    await saveToIndexedDB(appData);
                } else {
                    // IndexedDB ÏÇ¨Ïö© Î∂àÍ∞ÄÏãú localStorage Ìè¥Î∞±
                    localStorage.setItem('wordMasterData', dataStr);
                }
                
                // Îã§Î•∏ ÌÉ≠Ïóê Î≥ÄÍ≤ΩÏÇ¨Ìï≠ ÏïåÎ¶º
                broadcastDataChange('auto-save');
                
            } catch (error) {
                if (error.name === 'QuotaExceededError') {
                    console.error('Storage quota exceeded');
                    
                    // Í∏¥Í∏â Î∞±ÏóÖ ÏãúÎèÑ
                    try {
                        await emergencyBackup();
                        showFeedback('Ï†ÄÏû• Í≥µÍ∞ÑÏù¥ Ï¥àÍ≥ºÎêòÏñ¥ Í∏¥Í∏â Î∞±ÏóÖÏùÑ ÏÉùÏÑ±ÌñàÏäµÎãàÎã§. Îã§Ïö¥Î°úÎìú Ìè¥ÎçîÎ•º ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî.', 'error');
                    } catch (backupError) {
                        console.error('Emergency backup failed:', backupError);
                        showFeedback('Ï†ÄÏû• Í≥µÍ∞ÑÏù¥ Î∂ÄÏ°±ÌïòÍ≥† Î∞±ÏóÖÎèÑ Ïã§Ìå®ÌñàÏäµÎãàÎã§. Ï¶âÏãú ÏàòÎèôÏúºÎ°ú Î∞±ÏóÖÌï¥Ï£ºÏÑ∏Ïöî!', 'error');
                    }
                } else {
                    console.error('Failed to save data:', error);
                    showFeedback('Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû•Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§', 'error');
                }
            }
        }
        
        // ÏûêÎèô Î∞±ÏóÖ ÏÉùÏÑ±
        async function createAutoBackup() {
            try {
                const backupData = {
                    ...appData,
                    backupInfo: {
                        timestamp: new Date().toISOString(),
                        reason: 'auto-backup-size-limit',
                        size: JSON.stringify(appData).length
                    }
                };
                
                // IndexedDBÏùò Î∞±ÏóÖ Ï†ÄÏû•ÏÜåÏóê Ï†ÄÏû•
                if (db) {
                    const transaction = db.transaction(['appData'], 'readwrite');
                    const store = transaction.objectStore('appData');
                    const backupKey = `backup_${Date.now()}`;
                    await store.put(backupData, backupKey);
                    
                    // Ïò§ÎûòÎêú Î∞±ÏóÖ Ï†ïÎ¶¨ (ÏµúÎåÄ 5Í∞ú Ïú†ÏßÄ)
                    await cleanOldBackups();
                }
            } catch (error) {
                console.error('Auto backup failed:', error);
            }
        }
        
        // Í∏¥Í∏â Î∞±ÏóÖ (ÌååÏùºÎ°ú Îã§Ïö¥Î°úÎìú)
        async function emergencyBackup() {
            const backupData = {
                ...appData,
                backupInfo: {
                    timestamp: new Date().toISOString(),
                    reason: 'emergency-quota-exceeded',
                    size: JSON.stringify(appData).length
                }
            };
            
            const jsonString = JSON.stringify(backupData, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `word_master_emergency_backup_${new Date().toISOString().slice(0,19).replace(/:/g,'-')}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }
        
        // Í∞ÄÏû• Ïò§ÎûòÎêòÍ≥† ÏÇ¨Ïö©ÌïòÏßÄ ÏïäÎäî Îã®Ïñ¥Ïû• Ï∞æÍ∏∞
        function findOldestUnusedVocabulary() {
            const vocabs = Object.values(appData.vocabularies);
            if (vocabs.length <= 1) return null;
            
            // ÎßàÏßÄÎßâ ÌïôÏäµÏùº Í∏∞Ï§Ä Ï†ïÎ†¨
            const sortedVocabs = vocabs
                .filter(v => v.id !== appData.currentVocabId) // ÌòÑÏû¨ ÏÇ¨Ïö© Ï§ëÏù∏ Í≤É Ï†úÏô∏
                .sort((a, b) => {
                    const aDate = a.lastStudiedAt ? new Date(a.lastStudiedAt) : new Date(0);
                    const bDate = b.lastStudiedAt ? new Date(b.lastStudiedAt) : new Date(0);
                    return aDate - bDate;
                });
            
            return sortedVocabs[0];
        }
        
        // Ïò§ÎûòÎêú Î∞±ÏóÖ Ï†ïÎ¶¨
        async function cleanOldBackups() {
            if (!db) return;
            
            try {
                const transaction = db.transaction(['appData'], 'readwrite');
                const store = transaction.objectStore('appData');
                const request = store.getAllKeys();
                
                request.onsuccess = async () => {
                    const keys = request.result;
                    const backupKeys = keys.filter(key => key.toString().startsWith('backup_'));
                    
                    // ÏãúÍ∞ÑÏàú Ï†ïÎ†¨
                    backupKeys.sort((a, b) => {
                        const timeA = parseInt(a.toString().split('_')[1]);
                        const timeB = parseInt(b.toString().split('_')[1]);
                        return timeB - timeA; // ÏµúÏã†Ïàú
                    });
                    
                    // 5Í∞ú Ï¥àÍ≥ºÎ∂Ñ ÏÇ≠Ï†ú
                    if (backupKeys.length > 5) {
                        const keysToDelete = backupKeys.slice(5);
                        for (const key of keysToDelete) {
                            await store.delete(key);
                        }
                        console.log(`Deleted ${keysToDelete.length} old backups`);
                    }
                };
            } catch (error) {
                console.error('Failed to clean old backups:', error);
            }
        }

        // ÌïôÏäµ/ÌÖåÏä§Ìä∏ ÏßÑÌñâÏÉÅÌô© Ï†ÄÏû• - Í∞úÏÑ†Îêú Î≤ÑÏ†Ñ
        function saveProgress() {
            if (!currentVocab) return;
            
            if (isStudyMode) {
                currentVocab.studyProgress = {
                    chapterIndex: currentChapter,
                    cardIndex: currentStudyIndex
                };
                console.log(`ÌïôÏäµ ÏßÑÌñâÏÉÅÌô© Ï†ÄÏû•: Ï±ïÌÑ∞ ${currentChapter}, Ïπ¥Îìú ${currentStudyIndex}`);
            } else if (isTestMode) {
                currentVocab.testProgress = {
                    chapterIndex: currentChapter,
                    currentIndex: currentTestIndex,
                    answers: [...testAnswers],
                    questions: [...testQuestions]
                };
                console.log(`ÌÖåÏä§Ìä∏ ÏßÑÌñâÏÉÅÌô© Ï†ÄÏû•: Ï±ïÌÑ∞ ${currentChapter}, Î¨∏Ï†ú ${currentTestIndex}/${testQuestions.length}`);
            }
            autoSave();
        }

        // ÏñëÏ™Ω TTS Î™®Îìú Ï≤¥ÌÅ¨
        function checkBothTTSModes() {
            const wordChecked = document.getElementById('wordMode').checked;
            const exampleChecked = document.getElementById('exampleMode').checked;
            
            if (wordChecked && exampleChecked) {
                showFeedback('Îã®Ïñ¥ÏôÄ ÏòàÎ¨∏ÏùÑ Î™®Îëê ÏùΩÏúºÎ©¥ ÌïôÏäµÏù¥ ÎäêÎ†§Ïßà Ïàò ÏûàÏäµÎãàÎã§', 'warning');
            }
            autoSave();
        }

        // ÌÉ≠ Ï†ÑÌôò
        function switchTab(tabName) {
            // ÏßÑÌñâ Ï§ëÏù∏ ÏûëÏóÖ ÌôïÏù∏
            if (isStudyMode || isTestMode) {
                if (!confirm('ÏßÑÌñâ Ï§ëÏù∏ ÌïôÏäµ/ÌÖåÏä§Ìä∏Í∞Ä ÏûàÏäµÎãàÎã§. Ï§ëÎã®ÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
                    return;
                }
                if (isStudyMode) exitStudyMode();
                if (isTestMode) exitTestMode();
            }
            
            // Î™®Îì† ÌÉ≠Í≥º Ïª®ÌÖêÏ∏† ÎπÑÌôúÏÑ±Ìôî
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // ÏÑ†ÌÉùÎêú ÌÉ≠ ÌôúÏÑ±Ìôî
            const tabs = document.querySelectorAll('.tab');
            const tabContents = document.querySelectorAll('.tab-content');
            
            if (tabName === 'chapters') {
                tabs[0].classList.add('active');
                tabContents[0].classList.add('active');
            } else if (tabName === 'weakwords') {
                tabs[1].classList.add('active');
                tabContents[1].classList.add('active');
            } else if (tabName === 'settings') {
                tabs[2].classList.add('active');
                tabContents[2].classList.add('active');
            }
        }

        // TTS ÏùåÏÑ± Ï¥àÍ∏∞Ìôî
        function initializeVoices() {
            function loadVoices() {
                availableVoices = speechSynthesis.getVoices();
                
                if (availableVoices.length > 0) {
                    updateVoiceSelector();
                    
                    // ÏûêÎèô ÏùåÏÑ± ÏÑ†ÌÉù
                    if (!appData.globalSettings.selectedVoice || appData.globalSettings.selectedVoice === '') {
                        autoSelectVoice();
                    } else {
                        // Ï†ÄÏû•Îêú ÏùåÏÑ± Î≥µÏõê
                        const voice = availableVoices.find(v => v.name === appData.globalSettings.selectedVoice);
                        if (voice) {
                            selectedVoice = voice;
                            document.getElementById('voiceSelect').value = appData.globalSettings.selectedVoice;
                        } else {
                            autoSelectVoice();
                        }
                    }
                }
            }

            // ChromeÏùÄ Ï¶âÏãú ÏùåÏÑ± Î™©Î°ùÏùÑ Ï†úÍ≥µ
            if (speechSynthesis.getVoices().length > 0) {
                loadVoices();
            } else {
                // ÏùåÏÑ± Î™©Î°ùÏù¥ ÎÇòÏ§ëÏóê Î°úÎìúÎêòÎäî Í≤ΩÏö∞
                speechSynthesis.addEventListener('voiceschanged', loadVoices);
            }
        }

        // ÏûêÎèô ÏùåÏÑ± ÏÑ†ÌÉù
        function autoSelectVoice() {
            const userLang = navigator.language || 'ko-KR';
            let voice = availableVoices.find(v => v.lang === userLang);
            
            if (!voice) {
                // Ïñ∏Ïñ¥ ÏΩîÎìúÏùò ÏïûÎ∂ÄÎ∂ÑÎßå Îß§Ïπ≠
                const langPrefix = userLang.split('-')[0];
                voice = availableVoices.find(v => v.lang.startsWith(langPrefix));
            }
            
            if (!voice && availableVoices.length > 0) {
                // Í∏∞Î≥∏Í∞íÏúºÎ°ú Ï≤´ Î≤àÏß∏ ÏùåÏÑ± ÏÑ†ÌÉù
                voice = availableVoices[0];
            }
            
            if (voice) {
                selectedVoice = voice;
                appData.globalSettings.selectedVoice = voice.name;
                document.getElementById('voiceSelect').value = voice.name;
            }
        }

        // ÏùåÏÑ± ÏÑ†ÌÉùÍ∏∞ ÏóÖÎç∞Ïù¥Ìä∏
        function updateVoiceSelector() {
            const select = document.getElementById('voiceSelect');
            // Í∏∞Ï°¥ ÏòµÏÖò Ï†úÍ±∞ (Ï≤´ Î≤àÏß∏ Ï†úÏô∏)
            while (select.options.length > 1) {
                select.remove(1);
            }
            
            availableVoices.forEach((voice) => {
                const option = document.createElement('option');
                option.value = voice.name;
                option.textContent = `${voice.name} (${voice.lang})`;
                
                // Ïñ∏Ïñ¥Î≥Ñ Ïù¥Î™®ÏßÄ Ï∂îÍ∞Ä
                if (voice.lang.includes('ko')) option.textContent = 'üá∞üá∑ ' + option.textContent;
                else if (voice.lang.includes('ja')) option.textContent = 'üáØüáµ ' + option.textContent;
                else if (voice.lang.includes('en')) option.textContent = 'üá∫üá∏ ' + option.textContent;
                else if (voice.lang.includes('zh')) option.textContent = 'üá®üá≥ ' + option.textContent;
                else if (voice.lang.includes('es')) option.textContent = 'üá™üá∏ ' + option.textContent;
                else if (voice.lang.includes('fr')) option.textContent = 'üá´üá∑ ' + option.textContent;
                else if (voice.lang.includes('de')) option.textContent = 'üá©üá™ ' + option.textContent;
                else if (voice.lang.includes('it')) option.textContent = 'üáÆüáπ ' + option.textContent;
                else if (voice.lang.includes('pt')) option.textContent = 'üáµüáπ ' + option.textContent;
                else if (voice.lang.includes('ru')) option.textContent = 'üá∑üá∫ ' + option.textContent;
                
                select.appendChild(option);
            });
        }

        // ÏùåÏÑ± Î≥ÄÍ≤Ω
        function changeVoice() {
            const select = document.getElementById('voiceSelect');
            if (select.value === '') {
                autoSelectVoice();
            } else {
                selectedVoice = availableVoices.find(v => v.name === select.value);
                appData.globalSettings.selectedVoice = select.value;
            }
            autoSave();
        }

        // ÏùåÏÑ± ÌÖåÏä§Ìä∏
        function testVoice() {
            if (selectedVoice === null) {
                showFeedback('ÏùåÏÑ±ÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî', 'error');
                return;
            }
            
            // Ïñ∏Ïñ¥Î≥Ñ ÌÖåÏä§Ìä∏ ÌÖçÏä§Ìä∏
            let testText = 'ÏïàÎÖïÌïòÏÑ∏Ïöî, ÏùåÏÑ± ÌÖåÏä§Ìä∏ÏûÖÎãàÎã§';
            const lang = selectedVoice.lang;
            
            if (lang.includes('en')) {
                testText = 'Hello, this is a voice test';
            } else if (lang.includes('ja')) {
                testText = '„Åì„Çì„Å´„Å°„ÅØ„ÄÅÈü≥Â£∞„ÉÜ„Çπ„Éà„Åß„Åô';
            } else if (lang.includes('zh')) {
                testText = '‰Ω†Â•ΩÔºåËøôÊòØËØ≠Èü≥ÊµãËØï';
            } else if (lang.includes('es')) {
                testText = 'Hola, esta es una prueba de voz';
            } else if (lang.includes('fr')) {
                testText = 'Bonjour, ceci est un test vocal';
            } else if (lang.includes('de')) {
                testText = 'Hallo, das ist ein Sprachtest';
            } else if (lang.includes('it')) {
                testText = 'Ciao, questo √® un test vocale';
            } else if (lang.includes('pt')) {
                testText = 'Ol√°, este √© um teste de voz';
            } else if (lang.includes('ru')) {
                testText = '–ü—Ä–∏–≤–µ—Ç, —ç—Ç–æ –≥–æ–ª–æ—Å–æ–≤–æ–π —Ç–µ—Å—Ç';
            }
            
            speakTextWithCallback(testText, () => {});
        }

        // TTS Ïû¨ÏÉù (ÏΩúÎ∞± Ìè¨Ìï®)
        function speakTextWithCallback(text, callback) {
            if (!selectedVoice || !text) {
                if (callback) callback();
                return;
            }
            
            try {
                // Í∏∞Ï°¥ ÏùåÏÑ± Ï¶âÏãú Ï§ëÎã®
                speechSynthesis.cancel();
                isSpeaking = false;
                waitingForTTS = true;
                
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.voice = selectedVoice;
                utterance.rate = 0.9;
                utterance.pitch = 1.0;
                utterance.volume = 1.0;
                
                currentUtterance = utterance;
                
                utterance.onstart = () => {
                    isSpeaking = true;
                };
                
                utterance.onend = () => {
                    isSpeaking = false;
                    currentUtterance = null;
                    waitingForTTS = false;
                    if (callback) callback();
                };
                
                utterance.onerror = (e) => {
                    console.warn('TTS Ïò§Î•ò:', e);
                    isSpeaking = false;
                    currentUtterance = null;
                    waitingForTTS = false;
                    if (callback) callback();
                };
                
                speechSynthesis.speak(utterance);
            } catch (error) {
                console.error('TTS Ïû¨ÏÉù Ïã§Ìå®:', error);
                isSpeaking = false;
                waitingForTTS = false;
                if (callback) callback();
            }
        }

        // TTS ÌîÑÎ¶¨Î°úÎìú (Í∞úÏÑ†Îêú Î≤ÑÏ†Ñ)
        function preloadTTS(text) {
            if (!selectedVoice || !text || appData.globalSettings.ttsPreload === 0) return;
            
            // Ïù¥Ï†Ñ ÌîÑÎ¶¨Î°úÎìú Ï∑®ÏÜå
            if (preloadTimeout) {
                clearTimeout(preloadTimeout);
                preloadTimeout = null;
            }
            
            // ÌîÑÎ¶¨Î°úÎìú ÌÉÄÏù¥Î∞ç Í≥ÑÏÇ∞
            const preloadTime = Math.max(0, appData.globalSettings.studySpeed * 1000 - appData.globalSettings.ttsPreload * 100);
            
            if (preloadTime > 0) {
                preloadTimeout = setTimeout(() => {
                    try {
                        // ÌîÑÎ¶¨Î°úÎìúÏö© utterance ÏÉùÏÑ±
                        const preloadUtterance = new SpeechSynthesisUtterance(text);
                        preloadUtterance.voice = selectedVoice;
                        preloadUtterance.rate = 0.9;
                        preloadUtterance.pitch = 1.0;
                        preloadUtterance.volume = 0.001; // Í±∞Ïùò Îì§Î¶¨ÏßÄ ÏïäÎäî Î≥ºÎ•®
                        
                        // ÌîÑÎ¶¨Î°úÎìú Ïã§Ìñâ
                        speechSynthesis.speak(preloadUtterance);
                    } catch (error) {
                        console.error('TTS ÌîÑÎ¶¨Î°úÎìú Ïã§Ìå®:', error);
                    }
                }, preloadTime);
            }
        }

        // ÌïôÏäµ ÏÜçÎèÑ ÏóÖÎç∞Ïù¥Ìä∏
        function updateStudySpeed() {
            const slider = document.getElementById('studySpeedSlider');
            const value = slider.value / 10;
            document.getElementById('studySpeedValue').textContent = value.toFixed(1) + 'Ï¥à';
            appData.globalSettings.studySpeed = value;
            autoSave();
        }

        // TTS ÌîÑÎ¶¨Î°úÎìú ÏÑ§Ï†ï ÏóÖÎç∞Ïù¥Ìä∏
        function updateTTSPreload() {
            const slider = document.getElementById('ttsPreloadSlider');
            const value = slider.value / 10;
            document.getElementById('ttsPreloadValue').textContent = value.toFixed(1) + 'Ï¥à';
            appData.globalSettings.ttsPreload = value;
            autoSave();
        }

        // ÌïôÏäµ Ïπ¥Îìú Í∞ÄÏãúÏÑ± ÏóÖÎç∞Ïù¥Ìä∏
        function updateStudyCardVisibility() {
            const elements = {
                word: document.getElementById('studyWordText'),
                pronunciation: document.getElementById('studyWordPronunciation'),
                meaning: document.getElementById('studyWordMeaning'),
                example: document.getElementById('studyWordExample'),
                exampleMeaning: document.getElementById('studyWordExampleMeaning')
            };
            
            Object.keys(elements).forEach(key => {
                if (elements[key]) {
                    if (appData.globalSettings.visibility[key]) {
                        elements[key].classList.remove('hidden');
                    } else {
                        elements[key].classList.add('hidden');
                    }
                }
            });
            
            autoSave();
        }

        // ÌååÏùº ÏóÖÎ°úÎìú Ï≤òÎ¶¨
        function handleFileUpload(event) {
            const files = event.target.files;
            if (files.length === 0) return;
            
            if (!currentVocab) {
                showFeedback('Î®ºÏ†Ä Îã®Ïñ¥Ïû•ÏùÑ ÏÑ†ÌÉùÌïòÍ±∞ÎÇò ÎßåÎì§Ïñ¥Ï£ºÏÑ∏Ïöî', 'error');
                event.target.value = ''; // ÏûÖÎ†• Ï¥àÍ∏∞Ìôî
                return;
            }
            
            console.log('ÌååÏùº ÏóÖÎ°úÎìú ÏãúÏûë:', files.length, 'Í∞ú ÌååÏùº');
            
            // ÌååÏùºÏùÑ Î∞∞Ïó¥Î°ú Î≥ÄÌôòÌïòÏó¨ Ï†ÄÏû•
            pendingFiles = Array.from(files);
            
            // Ï±ïÌÑ∞ ÏÑ§Ï†ï Î™®Îã¨ ÌëúÏãú
            document.getElementById('chapterSettingModal').style.display = 'flex';
            document.getElementById('chapterSizeInput').value = currentVocab.settings.chapterSize;
        }

        // Î∞±ÏóÖ ÌååÏùº ÏóÖÎ°úÎìú Ï≤òÎ¶¨
        function handleBackupUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    // ÏßÑÌñâ Ï§ëÏù∏ ÏûëÏóÖ Ï§ëÎã®
                    if (isStudyMode) exitStudyMode();
                    if (isTestMode) exitTestMode();
                    
                    if (data.version === 3) {
                        // ÏÉà Î≤ÑÏ†Ñ ÏßÅÏ†ë Î°úÎìú
                        appData = data;
                        
                        // ÌòÑÏû¨ Îã®Ïñ¥Ïû• Ïû¨ÏÑ§Ï†ï
                        if (appData.currentVocabId && appData.vocabularies[appData.currentVocabId]) {
                            currentVocab = appData.vocabularies[appData.currentVocabId];
                        } else {
                            currentVocab = null;
                        }
                    } else if (data.version === 2) {
                        // Î≤ÑÏ†Ñ 2 ÎßàÏù¥Í∑∏Î†àÏù¥ÏÖò
                        migrateV2Data(data);
                    } else {
                        // Íµ¨ Î≤ÑÏ†Ñ ÎßàÏù¥Í∑∏Î†àÏù¥ÏÖò
                        migrateOldData(data);
                    }
                    
                    // ÏÑ§Ï†ï Î≥µÏõê
                    restoreGlobalSettings();
                    
                    // UI ÏóÖÎç∞Ïù¥Ìä∏
                    updateUI();
                    
                    // ÌååÏùº ÌÅ¨Í∏∞ ÌëúÏãú
                    const sizeKB = (e.target.result.length / 1024).toFixed(2);
                    showFeedback(`üìÇ Î∞±ÏóÖ Îç∞Ïù¥ÌÑ∞Í∞Ä Î∂àÎü¨ÏôÄÏ°åÏäµÎãàÎã§ (${sizeKB}KB)`, 'success');
                    
                    // Î°úÏª¨ Ïä§ÌÜ†Î¶¨ÏßÄÏóêÎèÑ Ï†ÄÏû•
                    autoSave();
                    
                } catch (error) {
                    showFeedback('ÌååÏùº ÌòïÏãùÏù¥ Ïò¨Î∞îÎ•¥ÏßÄ ÏïäÏäµÎãàÎã§', 'error');
                    console.error('Î∞±ÏóÖ Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïã§Ìå®:', error);
                }
            };
            reader.readAsText(file);
            
            // ÏûÖÎ†• Ï¥àÍ∏∞Ìôî
            event.target.value = '';
        }

        // V2 Îç∞Ïù¥ÌÑ∞ ÎßàÏù¥Í∑∏Î†àÏù¥ÏÖò - Í∞úÏÑ†Îêú Î≤ÑÏ†Ñ
        function migrateV2Data(v2Data) {
            // Í∏∞Î≥∏ Îã®Ïñ¥Ïû• ÏÉùÏÑ±
            const defaultVocab = new Vocabulary('Î∂àÎü¨Ïò® Îã®Ïñ¥Ïû•');
            
            // Îã®Ïñ¥ Î≥µÏõê - ID ÏÉùÏÑ± Î°úÏßÅ Í∞úÏÑ†
            defaultVocab.words = v2Data.words.map((w, index) => {
                // Í∏∞Ï°¥ IDÍ∞Ä ÏûàÏúºÎ©¥ ÏÇ¨Ïö©, ÏóÜÏúºÎ©¥ ÏïàÏ†ïÏ†ÅÏù∏ ID ÏÉùÏÑ±
                const wordId = w.id || `migrated_word_${index}_${w.word?.replace(/[^a-zA-Z0-9]/g, '')}_${Date.now()}`;
                
                return {
                    id: wordId,
                    word: w.w || w.word,
                    meaning: w.m || w.meaning,
                    pronunciation: w.p || w.pronunciation || '',
                    example: w.e || w.example || '',
                    exampleMeaning: w.em || w.exampleMeaning || '',
                    weakness: w.wk || w.weakness || 0,
                    correctCount: w.cc || w.correctCount || 0,
                    totalAttempts: w.ta || w.totalAttempts || 0,
                    consecutiveCorrect: w.cs || w.consecutiveCorrect || 0,
                    lastCorrect: w.lc || w.lastCorrect || false,
                    source: w.src || w.source || 'imported'
                };
            });
            
            // Îã®Ïñ¥ ID Îß§Ìïë ÌÖåÏù¥Î∏î ÏÉùÏÑ±
            const wordIdMap = new Map();
            defaultVocab.words.forEach((word, index) => {
                if (v2Data.words[index]) {
                    const oldWord = v2Data.words[index];
                    const oldId = oldWord.id || oldWord.w || oldWord.word;
                    if (oldId) {
                        wordIdMap.set(oldId, word.id);
                    }
                }
            });
            
            // Ï±ïÌÑ∞ Î≥µÏõê - ID Îß§Ìïë ÏÇ¨Ïö©
            if (v2Data.chapters) {
                defaultVocab.chapters = v2Data.chapters.map(ch => {
                    let wordIds = [];
                    
                    if (ch.wordIds && Array.isArray(ch.wordIds)) {
                        // Í∏∞Ï°¥ wordIdsÍ∞Ä ÏûàÎäî Í≤ΩÏö∞
                        wordIds = ch.wordIds.map(oldId => wordIdMap.get(oldId) || oldId)
                            .filter(id => defaultVocab.words.find(w => w.id === id));
                    } else if (ch.words && Array.isArray(ch.words)) {
                        // words Î∞∞Ïó¥ÏóêÏÑú ID Ï∂îÏ∂ú
                        wordIds = ch.words.map(w => {
                            if (typeof w === 'string') {
                                // Îã®Ïñ¥ ÌÖçÏä§Ìä∏Î°ú ID Ï∞æÍ∏∞
                                const foundWord = defaultVocab.words.find(word => word.word === w);
                                return foundWord ? foundWord.id : null;
                            } else if (w && w.id) {
                                // Í∞ùÏ≤¥ÏóêÏÑú ID Ï∂îÏ∂ú
                                return wordIdMap.get(w.id) || w.id;
                            } else if (w && w.word) {
                                // Îã®Ïñ¥ ÌÖçÏä§Ìä∏Î°ú Ï∞æÍ∏∞
                                const foundWord = defaultVocab.words.find(word => word.word === w.word);
                                return foundWord ? foundWord.id : null;
                            }
                            return null;
                        }).filter(id => id && defaultVocab.words.find(w => w.id === id));
                    }
                    
                    return {
                        id: ch.id || `migrated_chapter_${Date.now()}_${Math.random()}`,
                        title: ch.title || 'ÎßàÏù¥Í∑∏Î†àÏù¥ÏÖòÎêú Ï±ïÌÑ∞',
                        wordIds: wordIds,
                        accuracy: ch.accuracy || 0,
                        stars: ch.stars || 0,
                        completedCount: ch.completedCount || 0,
                        type: ch.type || 'normal',
                        perfectScore: ch.perfectScore || false
                    };
                }).filter(ch => ch.wordIds.length > 0); // Îπà Ï±ïÌÑ∞ Ï†úÍ±∞
            }
            
            // ÌÜµÍ≥Ñ Î≥µÏõê
            defaultVocab.statistics = {
                totalCorrect: v2Data.stats?.tc || v2Data.statistics?.totalCorrect || 0,
                totalAttempts: v2Data.stats?.ta || v2Data.statistics?.totalAttempts || 0
            };
            
            // ÏÑ§Ï†ï Î≥µÏõê
            defaultVocab.settings.chapterSize = v2Data.settings?.cs || v2Data.settings?.chapterSize || 10;
            defaultVocab.weakWordsRecommendCount = v2Data.wrc || v2Data.weakWordsRecommendCount || 0;
            
            // Í∏ÄÎ°úÎ≤å ÏÑ§Ï†ï Î≥µÏõê
            if (v2Data.settings) {
                appData.globalSettings = {
                    selectedVoice: v2Data.settings.sv || v2Data.settings.selectedVoice || '',
                    wordTTS: v2Data.settings.wt !== false && v2Data.settings.wordTTS !== false,
                    exampleTTS: v2Data.settings.et === true || v2Data.settings.exampleTTS === true,
                    darkMode: v2Data.settings.dm === true || v2Data.settings.darkMode === true,
                    studySpeed: v2Data.settings.ss || v2Data.settings.studySpeed || 2.8,
                    testWordTTS: v2Data.settings.twt !== false && v2Data.settings.testWordTTS !== false,
                    testAnswerTTS: v2Data.settings.tat === true || v2Data.settings.testAnswerTTS === true,
                    ttsPreload: v2Data.settings.tp || v2Data.settings.ttsPreload || 0,
                    visibility: v2Data.settings.vs || v2Data.settings.visibility || {
                        word: true,
                        pronunciation: true,
                        meaning: true,
                        example: true,
                        exampleMeaning: true
                    }
                };
            }
            
            appData.vocabularies[defaultVocab.id] = defaultVocab;
            appData.currentVocabId = defaultVocab.id;
            currentVocab = defaultVocab;
            
            console.log(`ÎßàÏù¥Í∑∏Î†àÏù¥ÏÖò ÏôÑÎ£å: ${defaultVocab.words.length}Í∞ú Îã®Ïñ¥, ${defaultVocab.chapters.length}Í∞ú Ï±ïÌÑ∞`);
        }

        // Ï±ïÌÑ∞ ÏÑ§Ï†ï ÌôïÏù∏
        function confirmChapterSetting() {
            const input = document.getElementById('chapterSizeInput');
            const chapterSize = parseInt(input.value);
            
            console.log('Ï±ïÌÑ∞ ÌÅ¨Í∏∞ ÏÑ§Ï†ï:', chapterSize);
            
            if (isNaN(chapterSize) || chapterSize < 10 || chapterSize > 200) {
                showFeedback('10 ~ 200 ÏÇ¨Ïù¥Ïùò Í∞íÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî', 'error');
                return;
            }
            
            currentVocab.settings.chapterSize = chapterSize;
            document.getElementById('chapterSettingModal').style.display = 'none';
            
            // Ïò®ÎùºÏù∏ Îã®Ïñ¥Ïû• Ï≤òÎ¶¨
            if (pendingOnlineVocabData) {
                processOnlineVocab(pendingOnlineVocabData);
                pendingOnlineVocabData = null;
            } 
            // ÌååÏùº Ï≤òÎ¶¨
            else if (pendingFiles && pendingFiles.length > 0) {
                processFiles(pendingFiles);
                pendingFiles = null;
            } else {
                console.error('Ï≤òÎ¶¨Ìï† Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§');
                showFeedback('Îç∞Ïù¥ÌÑ∞Î•º Îã§Ïãú ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî', 'error');
            }
            
            // ÌååÏùº ÏûÖÎ†• Ï¥àÍ∏∞Ìôî (Ïû¨ÏóÖÎ°úÎìú Í∞ÄÎä•ÌïòÎèÑÎ°ù)
            document.getElementById('fileInput').value = '';
        }

        // ÌååÏùº Ï≤òÎ¶¨
        function processFiles(files) {
            if (!files || files.length === 0) {
                console.error('Ï≤òÎ¶¨Ìï† ÌååÏùºÏù¥ ÏóÜÏäµÎãàÎã§');
                return;
            }
            
            let totalLoaded = 0;
            let filesProcessed = 0;
            const fileCount = files.length;
            
            console.log('ÌååÏùº Ï≤òÎ¶¨ ÏãúÏûë:', fileCount, 'Í∞ú');
            
            files.forEach((file, index) => {
                console.log(`ÌååÏùº ${index + 1} Ï≤òÎ¶¨ Ï§ë:`, file.name);
                
                const reader = new FileReader();
                
                reader.onerror = function(e) {
                    console.error('ÌååÏùº ÏùΩÍ∏∞ Ïò§Î•ò:', e);
                    filesProcessed++;
                    checkFileProcessingComplete();
                };
                
                reader.onload = function(e) {
                    try {
                        const content = e.target.result;
                        console.log(`ÌååÏùº ${file.name} ÎÇ¥Ïö© Í∏∏Ïù¥:`, content.length);
                        
                        const words = parseWordFile(content, file.name);
                        console.log(`ÌååÏùº ${file.name}ÏóêÏÑú ${words.length}Í∞ú Îã®Ïñ¥ ÌååÏã±Îê®`);
                        
                        // Ï§ëÎ≥µ Ï†úÍ±∞ÌïòÎ©∞ Ï∂îÍ∞Ä
                        let addedCount = 0;
                        words.forEach(word => {
                            if (!currentVocab.words.find(w => w.word === word.word)) {
                                currentVocab.words.push({
                                    ...word,
                                    weakness: 0,
                                    correctCount: 0,
                                    totalAttempts: 0,
                                    consecutiveCorrect: 0,
                                    lastCorrect: false
                                });
                                addedCount++;
                            }
                        });
                        
                        console.log(`${addedCount}Í∞ú Îã®Ïñ¥Í∞Ä ÏÉàÎ°ú Ï∂îÍ∞ÄÎê®`);
                        totalLoaded += addedCount;
                        
                    } catch (error) {
                        console.error('ÌååÏùº Ï≤òÎ¶¨ Ï§ë Ïò§Î•ò:', error);
                    }
                    
                    filesProcessed++;
                    checkFileProcessingComplete();
                };
                
                // ÌååÏùº Ï≤òÎ¶¨ ÏôÑÎ£å Ï≤¥ÌÅ¨
                function checkFileProcessingComplete() {
                    if (filesProcessed === fileCount) {
                        if (totalLoaded > 0) {
                            showFeedback(`‚ú® Ï¥ù ${totalLoaded}Í∞úÏùò Îã®Ïñ¥Î•º Î°úÎìúÌñàÏäµÎãàÎã§!`, 'success');
                            createChapters();
                            updateStats();
                            autoSave();
                        } else {
                            showFeedback('Î°úÎìúÎêú Îã®Ïñ¥Í∞Ä ÏóÜÏäµÎãàÎã§. ÌååÏùº ÌòïÏãùÏùÑ ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî.', 'error');
                        }
                    }
                }
                
                // UTF-8Î°ú ÌååÏùº ÏùΩÍ∏∞
                reader.readAsText(file, 'UTF-8');
            });
        }

        // Îã®Ïñ¥ ÌååÏùº ÌååÏã±
        function parseWordFile(content, filename) {
            console.log('ÌååÏùº ÌååÏã± ÏãúÏûë:', filename);
            
            const lines = content.split('\n')
                .map(line => line.trim())
                .filter(line => line.length > 0);
            
            console.log('Ï¥ù ÎùºÏù∏ Ïàò:', lines.length);
            
            const words = [];
            const timestamp = Date.now();
            
            lines.forEach((line, index) => {
                // ÏòÅÏñ¥ Ìå®ÌÑ¥: word[pronunciation]: meaning + example @ example_meaning
                let match = line.match(/^(.+?)\[([^\]]+)\]\s*:\s*(.+?)\s*\+\s*(.+?)\s*@\s*(.+)$/);
                
                if (match) {
                    // ÏòÅÏñ¥ ÌòïÏãù
                    const word = match[1].trim();
                    const pronunciation = match[2].trim();
                    const meaning = match[3].trim();
                    const example = match[4].trim();
                    const exampleMeaning = match[5].trim();
                    
                    words.push({
                        id: `${word.trim().replace(/[^a-zA-Z0-9Í∞Ä-Ìû£]/g, '_')}_${index}_${timestamp}`,
                        word: word,
                        pronunciation: pronunciation,
                        meaning: meaning,
                        example: example,
                        exampleMeaning: exampleMeaning,
                        source: filename
                    });
                } else {
                    // Í∏∞Ï°¥ ÌòïÏãù ÏãúÎèÑ: word: meaning + example
                    match = line.match(/^(.+?)\s*:\s*(.+?)\s*\+\s*(.+)$/) ||
                           line.match(/^(.+?):(.+?)\+(.+)$/);
                    
                    if (match) {
                        const word = match[1].trim();
                        const meaning = match[2].trim();
                        const example = match[3].trim();
                        
                        words.push({
                            id: `${filename}_${timestamp}_${index}`,
                            word: word,
                            pronunciation: '',
                            meaning: meaning,
                            example: example,
                            exampleMeaning: '',
                            source: filename
                        });
                    } else {
                        // Îçî Í∞ÑÎã®Ìïú ÌòïÏãù ÏãúÎèÑ: word: meaning
                        match = line.match(/^(.+?)\s*:\s*(.+)$/);
                        if (match) {
                            const word = match[1].trim();
                            const meaning = match[2].trim();
                            
                            words.push({
                                id: `${filename}_${timestamp}_${index}`,
                                word: word,
                                pronunciation: '',
                                meaning: meaning,
                                example: '',
                                exampleMeaning: '',
                                source: filename
                            });
                        } else {
                            console.warn(`ÎùºÏù∏ ${index + 1} ÌååÏã± Ïã§Ìå®:`, line);
                        }
                    }
                }
            });
            
            console.log('ÌååÏã± ÏôÑÎ£å. Îã®Ïñ¥ Ïàò:', words.length);
            return words;
        }

        // Ï±ïÌÑ∞ ÏÉùÏÑ± (Í≥ÑÏ∏µÏ†Å ÏãúÌóò Íµ¨Ï°∞) - ID Í∏∞Î∞òÏúºÎ°ú Í∞úÏÑ†
        async function createChapters() {
            if (!currentVocab) return;
            
            // ÏßÑÌñâÎ•† ÌëúÏãú
            showProgress('Ï±ïÌÑ∞ ÏÉùÏÑ± Ï§ë...', 0);
            
            // Í∏∞Ï°¥ Ï±ïÌÑ∞Ïùò ÏßÑÌñâÏÉÅÌô© Î∞±ÏóÖ
            const progressBackup = backupChapterProgress();
            
            currentVocab.chapters = [];
            const chapterSize = currentVocab.settings.chapterSize;
            const totalWords = currentVocab.words.length;
            
            // ÎåÄÏö©Îüâ Ï≤òÎ¶¨Î•º ÏúÑÌïú Ï≤≠ÌÅ¨ ÏÑ§Ï†ï
            const CHUNK_SIZE = 1000; // Ìïú Î≤àÏóê Ï≤òÎ¶¨Ìï† Îã®Ïñ¥ Ïàò
            let processedWords = 0;
            
            let chapterNumber = 1;
            let currentIndex = 0;
            let midtermCount = 0;
            let finalCount = 0;
            let comprehensiveCount = 0;
            
            // Ï≤≠ÌÅ¨ Îã®ÏúÑÎ°ú Ï≤òÎ¶¨
            while (currentIndex < totalWords) {
                const chunkEnd = Math.min(currentIndex + CHUNK_SIZE, totalWords);
                
                // Ïù¥ Ï≤≠ÌÅ¨ÏóêÏÑú Ï≤òÎ¶¨Ìï† Ï±ïÌÑ∞Îì§ ÏÉùÏÑ±
                while (currentIndex < chunkEnd && currentIndex < totalWords) {
                    const sectionNumber = Math.floor((chapterNumber - 1) / 5);
                    const positionInSection = (chapterNumber - 1) % 5 + 1;
                    
                    // Í∞Å ÏÑπÏÖòÏùò ÏãúÏûë Ïù∏Îç±Ïä§
                    const sectionStartIndex = sectionNumber * 5 * chapterSize;
                    
                    // ÌòÑÏû¨ Ï±ïÌÑ∞Í∞Ä Ìè¨Ìï®Ìï† Îã®Ïñ¥Îì§
                    const endIndex = Math.min(sectionStartIndex + positionInSection * chapterSize, totalWords);
                    
                    if (endIndex > currentIndex) {
                        const chapterWordIds = currentVocab.words
                            .slice(sectionStartIndex, endIndex)
                            .map(word => word.id);
                        
                        if (chapterWordIds.length > 0) {
                            const chapterId = `chapter_${chapterNumber}`;
                            currentVocab.chapters.push({
                                id: chapterId,
                                title: `Ï±ïÌÑ∞ ${chapterNumber}`,
                                wordIds: chapterWordIds,
                                accuracy: progressBackup[chapterId]?.accuracy || 0,
                                stars: progressBackup[chapterId]?.stars || 0,
                                completedCount: progressBackup[chapterId]?.completedCount || 0,
                                type: 'normal',
                                perfectScore: progressBackup[chapterId]?.perfectScore || false
                            });
                            currentIndex = endIndex;
                            processedWords = endIndex;
                        }
                        
                        // 10Ïùò Î∞∞ÏàòÎßàÎã§ ÏãúÌóò Ï∂îÍ∞Ä
                        if (chapterNumber % 10 === 0) {
                            await createExamChapters(chapterNumber, chapterSize, totalWords, 
                                                   progressBackup, midtermCount, finalCount, 
                                                   comprehensiveCount);
                        }
                        
                        chapterNumber++;
                    } else {
                        break;
                    }
                }
                
                // ÏßÑÌñâÎ•† ÏóÖÎç∞Ïù¥Ìä∏
                const progress = Math.round((processedWords / totalWords) * 90); // 90%ÍπåÏßÄÎäî Ï±ïÌÑ∞ ÏÉùÏÑ±
                showProgress('Ï±ïÌÑ∞ ÏÉùÏÑ± Ï§ë...', progress);
                
                // Î∏åÎùºÏö∞Ï†ÄÍ∞Ä Î©àÏ∂îÏßÄ ÏïäÎèÑÎ°ù Ïû†Ïãú Ï†úÏñ¥Í∂å ÏñëÎ≥¥
                await new Promise(resolve => requestAnimationFrame(resolve));
            }
            
            // Î™®Îì†Îã®Ïñ¥Í≥†ÏÇ¨ (Îß® ÎßàÏßÄÎßâ) - ÎåÄÏö©ÎüâÏù∏ Í≤ΩÏö∞ Ï†úÏô∏
            if (currentVocab.words.length > 0 && currentVocab.words.length <= 5000) {
                const allWordsId = 'all_words_exam';
                currentVocab.chapters.push({
                    id: allWordsId,
                    title: '‚ú® Î™®Îì†Îã®Ïñ¥Í≥†ÏÇ¨ ‚ú®',
                    wordIds: currentVocab.words.map(w => w.id),
                    accuracy: progressBackup[allWordsId]?.accuracy || 0,
                    stars: progressBackup[allWordsId]?.stars || 0,
                    completedCount: progressBackup[allWordsId]?.completedCount || 0,
                    type: 'allwords',
                    perfectScore: progressBackup[allWordsId]?.perfectScore || false
                });
            } else if (currentVocab.words.length > 5000) {
                // 5000Í∞ú Ï¥àÍ≥º Ïãú ÏïàÎÇ¥ Î©îÏãúÏßÄÎßå
                console.log('Îã®Ïñ¥Í∞Ä 5000Í∞úÎ•º Ï¥àÍ≥ºÌïòÏó¨ Î™®Îì†Îã®Ïñ¥Í≥†ÏÇ¨Îäî ÏÉùÏÑ±ÌïòÏßÄ ÏïäÏäµÎãàÎã§.');
            }
            
            showProgress('Ï±ïÌÑ∞ ÌëúÏãú Ï§ë...', 95);
            
            // Ï±ïÌÑ∞ ÌëúÏãúÎèÑ ÎπÑÎèôÍ∏∞Î°ú
            await new Promise(resolve => {
                requestAnimationFrame(() => {
                    displayChapters();
                    resolve();
                });
            });
            
            hideProgress();
        }
        
        // ÏãúÌóò Ï±ïÌÑ∞ ÏÉùÏÑ± (Î≥ÑÎèÑ Ìï®ÏàòÎ°ú Î∂ÑÎ¶¨) - Ïπ¥Ïö¥ÌÑ∞ Î¨∏Ï†ú Ìï¥Í≤∞
        async function createExamChapters(chapterNumber, chapterSize, totalWords, 
                                        progressBackup, midtermCount, finalCount, 
                                        comprehensiveCount) {
            const cycleNumber = Math.floor((chapterNumber - 1) / 60);
            const positionInCycle = chapterNumber % 60;
            
            if (positionInCycle === 10 || positionInCycle === 20) {
                // Ï§ëÍ∞ÑÍ≥†ÏÇ¨
                const currentMidtermCount = Math.floor((chapterNumber - 1) / 10);
                const examEndIndex = Math.min(chapterNumber * chapterSize, totalWords);
                const examWordIds = currentVocab.words
                    .slice(cycleNumber * 60 * chapterSize, examEndIndex)
                    .map(word => word.id);
                
                if (examWordIds.length > 0) {
                    const examId = `midterm_${currentMidtermCount + 1}`;
                    currentVocab.chapters.push({
                        id: examId,
                        title: `Ï§ëÍ∞ÑÍ≥†ÏÇ¨ ${currentMidtermCount + 1}`,
                        wordIds: examWordIds,
                        accuracy: progressBackup[examId]?.accuracy || 0,
                        stars: progressBackup[examId]?.stars || 0,
                        completedCount: progressBackup[examId]?.completedCount || 0,
                        type: 'midterm',
                        perfectScore: progressBackup[examId]?.perfectScore || false
                    });
                }
            } else if (positionInCycle === 30 || positionInCycle === 50) {
                // Í∏∞ÎßêÍ≥†ÏÇ¨
                const currentFinalCount = Math.floor((chapterNumber - 1) / 20);
                const examEndIndex = Math.min(chapterNumber * chapterSize, totalWords);
                const examWordIds = currentVocab.words
                    .slice(cycleNumber * 60 * chapterSize, examEndIndex)
                    .map(word => word.id);
                
                if (examWordIds.length > 0) {
                    const examId = `final_${currentFinalCount + 1}`;
                    currentVocab.chapters.push({
                        id: examId,
                        title: `Í∏∞ÎßêÍ≥†ÏÇ¨ ${currentFinalCount + 1}`,
                        wordIds: examWordIds,
                        accuracy: progressBackup[examId]?.accuracy || 0,
                        stars: progressBackup[examId]?.stars || 0,
                        completedCount: progressBackup[examId]?.completedCount || 0,
                        type: 'final',
                        perfectScore: progressBackup[examId]?.perfectScore || false
                    });
                }
            } else if (positionInCycle === 0 && chapterNumber > 0) {
                // Ï¢ÖÌï©Í≥†ÏÇ¨ (60Í∞ú Ï±ïÌÑ∞ÎßàÎã§)
                const currentComprehensiveCount = Math.floor(chapterNumber / 60);
                const examEndIndex = Math.min(chapterNumber * chapterSize, totalWords);
                const examWordIds = currentVocab.words
                    .slice(0, examEndIndex)
                    .map(word => word.id);
                
                if (examWordIds.length > 0) {
                    const examId = `comprehensive_${currentComprehensiveCount}`;
                    currentVocab.chapters.push({
                        id: examId,
                        title: `Ï¢ÖÌï©Í≥†ÏÇ¨ ${currentComprehensiveCount}`,
                        wordIds: examWordIds,
                        accuracy: progressBackup[examId]?.accuracy || 0,
                        stars: progressBackup[examId]?.stars || 0,
                        completedCount: progressBackup[examId]?.completedCount || 0,
                        type: 'comprehensive',
                        perfectScore: progressBackup[examId]?.perfectScore || false
                    });
                }
            }
        }
        
        // ÏßÑÌñâÎ•† ÌëúÏãú Ìï®Ïàò
        function showProgress(message, percent) {
            let progressElement = document.getElementById('progress-overlay');
            if (!progressElement) {
                progressElement = document.createElement('div');
                progressElement.id = 'progress-overlay';
                progressElement.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.8);
                    display: flex;
                    flex-direction: column;
                    justify-content: center;
                    align-items: center;
                    z-index: 9999;
                `;
                
                progressElement.innerHTML = `
                    <div style="background: white; padding: 30px; border-radius: 15px; text-align: center;">
                        <h3 style="margin-bottom: 20px; color: #333;" id="progress-message">${message}</h3>
                        <div style="width: 300px; height: 20px; background: #e0e0e0; border-radius: 10px; overflow: hidden;">
                            <div id="progress-bar" style="width: ${percent}%; height: 100%; background: linear-gradient(90deg, #667eea, #764ba2); transition: width 0.3s ease;"></div>
                        </div>
                        <div style="margin-top: 10px; color: #666;" id="progress-percent">${percent}%</div>
                    </div>
                `;
                
                document.body.appendChild(progressElement);
            } else {
                document.getElementById('progress-message').textContent = message;
                document.getElementById('progress-bar').style.width = percent + '%';
                document.getElementById('progress-percent').textContent = percent + '%';
            }
        }
        
        // ÏßÑÌñâÎ•† Ïà®Í∏∞Í∏∞
        function hideProgress() {
            const progressElement = document.getElementById('progress-overlay');
            if (progressElement) {
                progressElement.remove();
            }
        }
        
        // Ï±ïÌÑ∞ ÏßÑÌñâÏÉÅÌô© Î∞±ÏóÖ
        function backupChapterProgress() {
            const backup = {};
            if (currentVocab && currentVocab.chapters) {
                currentVocab.chapters.forEach(chapter => {
                    backup[chapter.id] = {
                        accuracy: chapter.accuracy,
                        stars: chapter.stars,
                        completedCount: chapter.completedCount,
                        perfectScore: chapter.perfectScore
                    };
                });
            }
            return backup;
        }
        
        // Ï±ïÌÑ∞Ïùò Îã®Ïñ¥Îì§ Í∞ÄÏ†∏Ïò§Í∏∞ (IDÎ°ú Ï°∞Ìöå) - Í∞úÏÑ†Îêú Î≤ÑÏ†Ñ
        function getChapterWords(chapter) {
            if (!chapter) {
                console.warn('Chapter is null or undefined');
                return [];
            }
            
            if (!chapter.wordIds || !Array.isArray(chapter.wordIds)) {
                console.warn('Chapter has no wordIds or wordIds is not an array:', chapter);
                return [];
            }
            
            if (!currentVocab || !currentVocab.words) {
                console.warn('Current vocab or vocab words is not available');
                return [];
            }
            
            const words = [];
            const invalidIds = [];
            
            chapter.wordIds.forEach(wordId => {
                const word = currentVocab.words.find(w => w.id === wordId);
                if (word) {
                    words.push(word);
                } else {
                    invalidIds.push(wordId);
                }
            });
            
            // Ïú†Ìö®ÌïòÏßÄ ÏïäÏùÄ IDÍ∞Ä ÏûàÏúºÎ©¥ Í≤ΩÍ≥†ÌïòÍ≥† Ï†ïÎ¶¨
            if (invalidIds.length > 0) {
                console.warn(`Invalid word IDs found in chapter ${chapter.title}:`, invalidIds);
                console.warn(`Total wordIds: ${chapter.wordIds.length}, Valid: ${words.length}, Invalid: ${invalidIds.length}`);
                
                // Ïú†Ìö®ÌïòÏßÄ ÏïäÏùÄ ID Ï†úÍ±∞
                chapter.wordIds = chapter.wordIds.filter(id => !invalidIds.includes(id));
                
                // ÎßåÏïΩ Î™®Îì† IDÍ∞Ä Ïú†Ìö®ÌïòÏßÄ ÏïäÎã§Î©¥ ÏóêÎü¨ Î°úÍ∑∏
                if (words.length === 0 && chapter.wordIds.length > 0) {
                    console.error(`All word IDs in chapter ${chapter.title} are invalid!`);
                }
            }
            
            return words;
        }
        
        // Ï±ïÌÑ∞ Î¨¥Í≤∞ÏÑ± Í≤ÄÏ¶ù
        function validateChapters() {
            if (!currentVocab || !currentVocab.chapters) return;
            
            let hasInvalidIds = false;
            
            currentVocab.chapters.forEach(chapter => {
                if (chapter.wordIds) {
                    const validIds = [];
                    chapter.wordIds.forEach(wordId => {
                        if (currentVocab.words.find(w => w.id === wordId)) {
                            validIds.push(wordId);
                        } else {
                            hasInvalidIds = true;
                        }
                    });
                    chapter.wordIds = validIds;
                }
            });
            
            if (hasInvalidIds) {
                console.log('Ï±ïÌÑ∞ Î¨¥Í≤∞ÏÑ± Í≤ÄÏ¶ù ÏôÑÎ£å - Ïú†Ìö®ÌïòÏßÄ ÏïäÏùÄ Îã®Ïñ¥ ID Ï†úÍ±∞Îê®');
                autoSave();
            }
        }

        // Ï±ïÌÑ∞ ÌëúÏãú - Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà Ï§ëÎ≥µ Î∞©ÏßÄ
        function displayChapters() {
            const chapterList = document.getElementById('chapterList');
            
            if (!currentVocab || currentVocab.chapters.length === 0) {
                chapterList.innerHTML = '<div style="text-align: center; color: #6b7280; padding: 60px;">Îã®Ïñ¥Î•º ÏóÖÎ°úÎìúÌï¥Ï£ºÏÑ∏Ïöî</div>';
                return;
            }
            
            // Î¨¥Í≤∞ÏÑ± Í≤ÄÏ¶ù
            validateChapters();
            
            // Í∏∞Ï°¥ ÎÇ¥Ïö© Î∞è Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà Ï†úÍ±∞
            chapterList.innerHTML = '';
            chapterList.onscroll = null; // Í∏∞Ï°¥ Ïä§ÌÅ¨Î°§ Ïù¥Î≤§Ìä∏ Ï†úÍ±∞
            
            // Ìïú Î≤àÏóê ÌëúÏãúÌï† Ï±ïÌÑ∞ Ïàò
            const VISIBLE_CHAPTERS = 20;
            const totalChapters = currentVocab.chapters.length;
            let visibleStart = 0;
            let visibleEnd = Math.min(VISIBLE_CHAPTERS, totalChapters);
            
            // Ï±ïÌÑ∞ Ïª®ÌÖåÏù¥ÎÑà ÏÉùÏÑ±
            const chaptersContainer = document.createElement('div');
            chaptersContainer.style.cssText = 'position: relative;';
            
            // Í∞ÄÏÉÅ ÎÜíÏù¥Î•º ÏúÑÌïú Ïä§ÌéòÏù¥ÏÑú
            const spacerTop = document.createElement('div');
            const spacerBottom = document.createElement('div');
            
            // Ï±ïÌÑ∞ ÎÜíÏù¥ Ï∂îÏ†ï (Î™®Î∞îÏùº/Îç∞Ïä§ÌÅ¨ÌÜ± Íµ¨Î∂Ñ)
            const isMobile = window.innerWidth <= 768;
            const CHAPTER_HEIGHT = isMobile ? 150 : 180;
            
            // Ïä§ÌÅ¨Î°§ Ïù¥Î≤§Ìä∏ Ìï∏Îì§Îü¨
            let scrollTimeout;
            const handleScroll = () => {
                clearTimeout(scrollTimeout);
                scrollTimeout = setTimeout(() => {
                    const scrollTop = chapterList.scrollTop;
                    const newStart = Math.floor(scrollTop / CHAPTER_HEIGHT);
                    const newEnd = Math.min(newStart + VISIBLE_CHAPTERS, totalChapters);
                    
                    if (newStart !== visibleStart || newEnd !== visibleEnd) {
                        visibleStart = Math.max(0, newStart - 5); // Î≤ÑÌçº Ï∂îÍ∞Ä
                        visibleEnd = Math.min(newEnd + 5, totalChapters);
                        renderVisibleChapters();
                    }
                }, 50);
            };
            
            // Î≥¥Ïù¥Îäî Ï±ïÌÑ∞Îßå Î†åÎçîÎßÅ
            const renderVisibleChapters = () => {
                // Í∏∞Ï°¥ Ï±ïÌÑ∞ Ïπ¥Îìú Ï†úÍ±∞
                chaptersContainer.innerHTML = '';
                
                // ÏÉÅÎã® Ïä§ÌéòÏù¥ÏÑú ÎÜíÏù¥ ÏÑ§Ï†ï
                spacerTop.style.height = `${visibleStart * CHAPTER_HEIGHT}px`;
                
                // Î≥¥Ïù¥Îäî Ï±ïÌÑ∞Îßå ÏÉùÏÑ±
                for (let index = visibleStart; index < visibleEnd; index++) {
                    const chapter = currentVocab.chapters[index];
                    const chapterCard = createChapterCard(chapter, index);
                    chaptersContainer.appendChild(chapterCard);
                }
                
                // ÌïòÎã® Ïä§ÌéòÏù¥ÏÑú ÎÜíÏù¥ ÏÑ§Ï†ï
                const remainingChapters = totalChapters - visibleEnd;
                spacerBottom.style.height = `${remainingChapters * CHAPTER_HEIGHT}px`;
            };
            
            // Ï±ïÌÑ∞ Ïπ¥Îìú ÏÉùÏÑ± Ìï®Ïàò
            const createChapterCard = (chapter, index) => {
                const chapterCard = document.createElement('div');
                chapterCard.className = `chapter-card ${chapter.type}`;
                if (chapter.perfectScore) {
                    chapterCard.className += ' perfect';
                }
                chapterCard.onclick = () => showChapterModal(index);
                
                let starsDisplay = '';
                if (chapter.perfectScore) {
                    starsDisplay = '<span class="rainbow-star">‚≠ê</span><span class="rainbow-star">‚≠ê</span><span class="rainbow-star">‚≠ê</span>';
                } else {
                    const stars = '‚≠ê'.repeat(chapter.stars);
                    starsDisplay = stars || '‚òÜ‚òÜ‚òÜ';
                }
                
                // Ï±ïÌÑ∞Ïùò Îã®Ïñ¥Îì§ Í∞ÄÏ†∏Ïò§Í∏∞
                const chapterWords = getChapterWords(chapter);
                
                // ÏßÑÌñâÎ•† Í≥ÑÏÇ∞
                let masteredWords = 0;
                let recentCorrectWords = 0;
                
                for (const word of chapterWords) {
                    if (word.weakness === 0 && word.correctCount >= 3) masteredWords++;
                    if (word.lastCorrect) recentCorrectWords++;
                }
                
                const progressPercent = chapterWords.length > 0 ? (masteredWords / chapterWords.length) * 100 : 0;
                const recentProgressPercent = chapterWords.length > 0 ? (recentCorrectWords / chapterWords.length) * 100 : 0;
                
                chapterCard.innerHTML = `
                    <div class="chapter-header">
                        <div class="chapter-title">${chapter.title}</div>
                        <div class="chapter-stars">${starsDisplay}</div>
                    </div>
                    <div class="chapter-progress">
                        <div class="progress-info">
                            ÎßàÏä§ÌÑ∞ Îã®Ïñ¥: ${masteredWords}/${chapterWords.length} ‚Ä¢ ÏµúÍ∑º ÎßûÏ∂ò Îã®Ïñ¥: ${recentCorrectWords}/${chapterWords.length}
                        </div>
                        <div class="progress-bar-container">
                            <div class="progress-bar-recent" style="width: ${recentProgressPercent}%"></div>
                            <div class="progress-bar-fill" style="width: ${progressPercent}%"></div>
                        </div>
                    </div>
                    <div class="chapter-info">
                        Ï¥ù ${chapterWords.length}Í∞ú Îã®Ïñ¥ ‚Ä¢ Ï†ïÌôïÎèÑ ${chapter.accuracy}%<br>
                        ÏôÑÎ£å ${chapter.completedCount}Ìöå
                    </div>
                `;
                
                return chapterCard;
            };
            
            // ÎåÄÏö©Îüâ Ï±ïÌÑ∞ Ï≤òÎ¶¨
            if (totalChapters > 100) {
                // Í∞ÄÏÉÅ Ïä§ÌÅ¨Î°§ÎßÅ ÏÇ¨Ïö©
                chapterList.style.cssText = 'overflow-y: auto; max-height: calc(100vh - 300px);';
                chapterList.appendChild(spacerTop);
                chapterList.appendChild(chaptersContainer);
                chapterList.appendChild(spacerBottom);
                
                // Ïä§ÌÅ¨Î°§ Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà Ï∂îÍ∞Ä (Ï§ëÎ≥µ Î∞©ÏßÄ)
                chapterList.addEventListener('scroll', handleScroll, { passive: true });
                
                // Ï¥àÍ∏∞ Î†åÎçîÎßÅ
                renderVisibleChapters();
                
                // Ï†ÑÏ≤¥ ÎÜíÏù¥ ÏÑ§Ï†ï
                const totalHeight = totalChapters * CHAPTER_HEIGHT;
                chapterList.style.height = `${Math.min(totalHeight, window.innerHeight - 300)}px`;
            } else {
                // 100Í∞ú Ïù¥ÌïòÎäî Í∏∞Ï°¥ Î∞©Ïãù
                currentVocab.chapters.forEach((chapter, index) => {
                    const chapterCard = createChapterCard(chapter, index);
                    chapterList.appendChild(chapterCard);
                });
            }
        }

        // Ï±ïÌÑ∞ Î™®Îã¨ ÌëúÏãú
        function showChapterModal(index) {
            if (index < 0 || index >= currentVocab.chapters.length) return;
            
            selectedChapterIndex = index;
            const chapter = currentVocab.chapters[index];
            document.getElementById('chapterModalTitle').textContent = chapter.title;
            document.getElementById('chapterModal').style.display = 'flex';
        }

        // Ï±ïÌÑ∞ Î™®Îã¨ Îã´Í∏∞
        function closeChapterModal() {
            document.getElementById('chapterModal').style.display = 'none';
        }

        // Î™®Îã¨ÏóêÏÑú ÌïôÏäµ ÏãúÏûë - ÏûêÎèô Î≥µÏõê Ï†úÍ±∞
        function startStudyFromModal() {
            closeChapterModal();
            startStudy(selectedChapterIndex);
        }

        // Î™®Îã¨ÏóêÏÑú ÌÖåÏä§Ìä∏ ÏãúÏûë - ÏûêÎèô Î≥µÏõê Ï†úÍ±∞
        function startTestFromModal() {
            closeChapterModal();
            startTest(selectedChapterIndex);
        }

        // ÌïôÏäµ Î™®Îìú ÏãúÏûë - Í∞úÏÑ†Îêú Î≤ÑÏ†Ñ
        function startStudy(chapterIndex) {
            if (chapterIndex < 0 || chapterIndex >= currentVocab.chapters.length) return;
            
            // Í∏∞Ï°¥ ÏßÑÌñâÏÉÅÌô©Ïù¥ Îã§Î•∏ Ï±ïÌÑ∞Î©¥ Ï¥àÍ∏∞Ìôî
            if (currentVocab.studyProgress.chapterIndex !== chapterIndex) {
                currentVocab.studyProgress = { chapterIndex: chapterIndex, cardIndex: 0 };
                currentStudyIndex = 0;
            } else {
                // Í∞ôÏùÄ Ï±ïÌÑ∞Î©¥ Ïù¥Ïñ¥ÏÑú ÏßÑÌñâ
                currentStudyIndex = currentVocab.studyProgress.cardIndex || 0;
            }
            
            currentChapter = chapterIndex;
            isStudyMode = true;
            isPaused = false;
            studyStartTime = Date.now();
            
            // Ïä§Ìä∏Î¶≠ ÏóÖÎç∞Ïù¥Ìä∏
            updateVocabStreak();
            
            document.getElementById('studyMode').style.display = 'flex';
            
            showCurrentStudyCard();
            startStudyTimer();
        }

        // ÌïôÏäµ Ïπ¥Îìú ÌëúÏãú
        function showCurrentStudyCard() {
            const chapter = currentVocab.chapters[currentChapter];
            if (!chapter) return;
            
            const chapterWords = getChapterWords(chapter);
            if (currentStudyIndex >= chapterWords.length) return;
            
            const word = chapterWords[currentStudyIndex];
            
            document.getElementById('studyWordText').textContent = word.word;
            document.getElementById('studyWordPronunciation').textContent = word.pronunciation ? `[${word.pronunciation}]` : '';
            document.getElementById('studyWordMeaning').textContent = word.meaning;
            
            // ÏòàÎ¨∏ Ï≤òÎ¶¨
            if (word.example) {
                document.getElementById('studyWordExample').textContent = word.example;
                document.getElementById('studyWordExample').style.display = 'block';
            } else {
                document.getElementById('studyWordExample').style.display = 'none';
            }
            
            // ÏòàÎ¨∏ Îúª Ï≤òÎ¶¨
            if (word.exampleMeaning) {
                document.getElementById('studyWordExampleMeaning').textContent = word.exampleMeaning;
                document.getElementById('studyWordExampleMeaning').style.display = 'block';
            } else {
                document.getElementById('studyWordExampleMeaning').style.display = 'none';
            }
            
            // Í∞ÄÏãúÏÑ± ÏóÖÎç∞Ïù¥Ìä∏
            updateStudyCardVisibility();
            
            // ÏßÑÌñâÎ•† ÏóÖÎç∞Ïù¥Ìä∏
            const progress = ((currentStudyIndex + 1) / chapterWords.length) * 100;
            document.getElementById('studyProgress').style.width = progress + '%';
            
            // TTS Ïû¨ÏÉù
            if (selectedVoice) {
                let textToSpeak = '';
                
                if (appData.globalSettings.wordTTS) {
                    textToSpeak = word.word;
                }
                
                if (appData.globalSettings.exampleTTS && word.example) {
                    if (textToSpeak) textToSpeak += '. ';
                    textToSpeak += word.example;
                }
                
                if (textToSpeak) {
                    speakTextWithCallback(textToSpeak, () => {});
                }
            }
            
            // Îã§Ïùå Ïπ¥Îìú ÌîÑÎ¶¨Î°úÎìú
            if (appData.globalSettings.ttsPreload > 0) {
                const nextIndex = (currentStudyIndex + 1) % chapterWords.length;
                const nextWord = chapterWords[nextIndex];
                if (nextWord && selectedVoice) {
                    let nextText = '';
                    
                    if (appData.globalSettings.wordTTS) {
                        nextText = nextWord.word;
                    }
                    
                    if (appData.globalSettings.exampleTTS && nextWord.example) {
                        if (nextText) nextText += '. ';
                        nextText += nextWord.example;
                    }
                    
                    if (nextText) {
                        preloadTTS(nextText);
                    }
                }
            }
            
            saveProgress();
        }

        // ÌïôÏäµ ÌÉÄÏù¥Î®∏ ÏãúÏûë
        function startStudyTimer() {
            if (studyInterval) clearInterval(studyInterval);
            
            const intervalTime = appData.globalSettings.studySpeed * 1000;
            
            studyInterval = setInterval(() => {
                if (!isPaused && !isSpeaking) {
                    nextStudyCard();
                }
            }, intervalTime);
        }

        // Îã§Ïùå ÌïôÏäµ Ïπ¥Îìú
        function nextStudyCard() {
            const chapter = currentVocab.chapters[currentChapter];
            if (!chapter) return;
            
            const chapterWords = getChapterWords(chapter);
            currentStudyIndex = (currentStudyIndex + 1) % chapterWords.length;
            
            // Ìïú Î∞îÌÄ¥ ÎèåÏïòÏùÑ Îïå
            if (currentStudyIndex === 0) {
                currentVocab.chapters[currentChapter].completedCount++;
                autoSave();
            }
            
            showCurrentStudyCard();
        }

        // ÌïôÏäµ ÏùºÏãúÏ†ïÏßÄ/Ïû¨Í∞ú
        function toggleStudyPause() {
            isPaused = !isPaused;
            const pauseIndicator = document.getElementById('pauseIndicator');
            
            if (isPaused) {
                pauseIndicator.classList.remove('hidden');
                pauseIndicator.style.animation = 'pauseFadeInOut 1s ease-out';
                speechSynthesis.cancel();
                if (preloadTimeout) {
                    clearTimeout(preloadTimeout);
                    preloadTimeout = null;
                }
                
                setTimeout(() => {
                    pauseIndicator.classList.add('hidden');
                }, 1000);
            }
        }

        // ÌïôÏäµ Î™®Îìú Ï¢ÖÎ£å - ÏßÑÌñâÏÉÅÌô© Ïú†ÏßÄ
        function exitStudyMode() {
            if (studyInterval) {
                clearInterval(studyInterval);
                studyInterval = null;
            }
            if (preloadTimeout) {
                clearTimeout(preloadTimeout);
                preloadTimeout = null;
            }
            speechSynthesis.cancel();
            document.getElementById('studyMode').style.display = 'none';
            isStudyMode = false;
            isPaused = false;
            document.getElementById('pauseIndicator').classList.add('hidden');
            
            // ÌïôÏäµ ÏãúÍ∞Ñ ÏóÖÎç∞Ïù¥Ìä∏
            if (studyStartTime) {
                const studyTime = Math.floor((Date.now() - studyStartTime) / 1000);
                currentVocab.totalStudyTime += studyTime;
                studyStartTime = null;
            }
            
            // ÏßÑÌñâÏÉÅÌô© Ï†ÄÏû• (ÏßÑÌñâÏÉÅÌô©ÏùÑ Ïú†ÏßÄÌïòÍ∏∞ ÏúÑÌï¥ Ï¥àÍ∏∞ÌôîÌïòÏßÄ ÏïäÏùå)
            saveProgress();
            displayChapters();
            autoSave();
        }

        // ÌÖåÏä§Ìä∏ Î™®Îìú ÏãúÏûë - Í∞úÏÑ†Îêú Î≤ÑÏ†Ñ
        function startTest(chapterIndex, resume = false) {
            if (chapterIndex < 0 || chapterIndex >= currentVocab.chapters.length) return;
            
            currentChapter = chapterIndex;
            isTestMode = true;
            isTestPaused = false;
            
            if (!resume) {
                // Í∏∞Ï°¥ ÏßÑÌñâÏÉÅÌô©Ïù¥ Í∞ôÏùÄ Ï±ïÌÑ∞Î©¥ Ïù¥Ïñ¥ÏÑú ÏßÑÌñâ
                if (currentVocab.testProgress.chapterIndex === chapterIndex && 
                    currentVocab.testProgress.currentIndex > 0 &&
                    currentVocab.testProgress.questions.length > 0) {
                    
                    currentTestIndex = currentVocab.testProgress.currentIndex;
                    testAnswers = [...currentVocab.testProgress.answers];
                    testQuestions = [...currentVocab.testProgress.questions];
                    
                    console.log(`ÌÖåÏä§Ìä∏ Ïù¥Ïñ¥ÏÑú ÏßÑÌñâ: ${currentTestIndex + 1}/${testQuestions.length}`);
                } else {
                    // ÏÉàÎ°ú ÏãúÏûë
                    currentTestIndex = 0;
                    testAnswers = [];
                    const chapter = currentVocab.chapters[currentChapter];
                    
                    // Ï±ïÌÑ∞Ïùò Îã®Ïñ¥ ID Î∞∞Ïó¥ Í∞ÄÏ†∏Ïò§Í∏∞
                    const chapterData = chapter.wordIds;
                    
                    // Ïö∞ÏÑ†ÏàúÏúÑ Í∏∞Î∞ò Î¨∏Ï†ú ÏÉùÏÑ±
                    testQuestions = generatePrioritizedQuestions(chapterData);
                    
                    // ÏßÑÌñâÏÉÅÌô© Ï¥àÍ∏∞Ìôî
                    currentVocab.testProgress = {
                        chapterIndex: chapterIndex,
                        currentIndex: 0,
                        answers: [],
                        questions: [...testQuestions]
                    };
                }
            }
            
            document.getElementById('testMode').style.display = 'flex';
            updateTestStats();
            showCurrentTestQuestion();
        }
        
        // Ïö∞ÏÑ†ÏàúÏúÑ Í∏∞Î∞ò Î¨∏Ï†ú ÏÉùÏÑ±
        function generatePrioritizedQuestions(chapterData) {
            // Ï±ïÌÑ∞ ÌÉÄÏûÖÏóê Îî∞Î•∏ ÏµúÎåÄ Î¨∏Ï†ú Ïàò ÏÑ§Ï†ï
            const chapter = currentVocab.chapters[currentChapter];
            let maxQuestions = 50; // Í∏∞Î≥∏Í∞í
            
            if (chapter) {
                if (chapter.type === 'midterm' || chapter.type === 'final') {
                    maxQuestions = 100; // Ï§ëÍ∞ÑÍ≥†ÏÇ¨, Í∏∞ÎßêÍ≥†ÏÇ¨
                } else if (chapter.type === 'comprehensive') {
                    maxQuestions = 200; // Ï¢ÖÌï©Í≥†ÏÇ¨
                } else if (chapter.type === 'allwords') {
                    maxQuestions = 300; // Î™®Îì†Îã®Ïñ¥Í≥†ÏÇ¨
                }
            }
            
            // ID Î∞∞Ïó¥Î°ú Îã®Ïñ¥ Ï°∞Ìöå
            const words = [];
            if (Array.isArray(chapterData) && chapterData.length > 0 && typeof chapterData[0] === 'string') {
                // ID Î∞∞Ïó¥Ïù∏ Í≤ΩÏö∞
                chapterData.forEach(id => {
                    const word = currentVocab.words.find(w => w.id === id);
                    if (word) words.push(word);
                });
            } else {
        // Í∏∞Î≥∏Ï†ÅÏúºÎ°ú Îã®Ïñ¥ ID Î∞∞Ïó¥Ïù¥ÎùºÍ≥† Í∞ÄÏ†ï
        console.warn('Unexpected chapter data format, assuming word IDs');
        return [];
    }
            
            // Îã®Ïñ¥Î•º Ïö∞ÏÑ†ÏàúÏúÑÎ≥ÑÎ°ú Î∂ÑÎ•ò
            const neverCorrect = [];      // ÌïúÎ≤àÎèÑ ÎßûÏ∂îÏßÄ ÏïäÏùÄ Îã®Ïñ¥
            const notMastered = [];       // ÎßàÏä§ÌÑ∞ ÎØ∏ÏôÑÎ£å (correctCount < 3)
            const recentlyWrong = [];     // ÏµúÍ∑º ÌãÄÎ¶∞ Îã®Ïñ¥
            const mastered = [];          // ÎßàÏä§ÌÑ∞ ÏôÑÎ£å Îã®Ïñ¥
            
            for (const word of words) {
                if (word.totalAttempts === 0 || word.correctCount === 0) {
                    neverCorrect.push(word);
                } else if (word.correctCount < 3 || word.weakness > 0) {
                    notMastered.push(word);
                } else if (!word.lastCorrect) {
                    recentlyWrong.push(word);
                } else {
                    mastered.push(word);
                }
            }
            
            // Í∞Å Í∑∏Î£π ÎÇ¥ÏóêÏÑú ÏÖîÌîå
            shuffleArray(neverCorrect);
            shuffleArray(notMastered);
            shuffleArray(recentlyWrong);
            shuffleArray(mastered);
            
            // Ïö∞ÏÑ†ÏàúÏúÑÏóê Îî∞Îùº Î¨∏Ï†ú Íµ¨ÏÑ±
            let questions = [];
            
            // 1. ÎØ∏ÎßàÏä§ÌÑ∞ Îã®Ïñ¥Îì§ Î®ºÏ†Ä Ï∂îÍ∞Ä
            questions = questions.concat(neverCorrect);
            questions = questions.concat(notMastered);
            questions = questions.concat(recentlyWrong);
            
            // 2. 50Í∞úÍ∞Ä Ïïà ÎêòÎ©¥ ÎßàÏä§ÌÑ∞ Îã®Ïñ¥Î°ú Ï±ÑÏõÄ
            if (questions.length < maxQuestions) {
                const needed = maxQuestions - questions.length;
                questions = questions.concat(mastered.slice(0, needed));
            }
            
            // 3. 50Í∞ú Ï¥àÍ≥ºÎ©¥ ÏûêÎ•¥Í∏∞
            if (questions.length > maxQuestions) {
                questions = questions.slice(0, maxQuestions);
            }
            
            // 4. ÏµúÏ¢Ö ÏÖîÌîå (Î¨∏Ï†ú ÏàúÏÑú ÎûúÎç§Ìôî)
            shuffleArray(questions);
            
            console.log(`Î¨∏Ï†ú Íµ¨ÏÑ±: Ï¥ù ${questions.length}Í∞ú (ÎØ∏ÌïôÏäµ: ${neverCorrect.length}, ÎØ∏ÎßàÏä§ÌÑ∞: ${notMastered.length}, ÏµúÍ∑ºÌãÄÎ¶º: ${recentlyWrong.length}, ÎßàÏä§ÌÑ∞: ${Math.min(mastered.length, questions.length - neverCorrect.length - notMastered.length - recentlyWrong.length)})`);
            
            return questions;
        }
        
        // Fisher-Yates ÏÖîÌîå ÏïåÍ≥†Î¶¨Ï¶ò
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // ÌÖåÏä§Ìä∏ ÏùºÏãúÏ†ïÏßÄ
        function toggleTestPause() {
            isTestPaused = !isTestPaused;
            
            if (isTestPaused) {
                if (testTimer) {
                    clearTimeout(testTimer);
                    testTimer = null;
                }
                if (timerInterval) {
                    clearInterval(timerInterval);
                    timerInterval = null;
                }
                speechSynthesis.cancel();
                showFeedback('ÌÖåÏä§Ìä∏Í∞Ä ÏùºÏãúÏ†ïÏßÄÎêòÏóàÏäµÎãàÎã§', 'warning');
            } else {
                showFeedback('ÌÖåÏä§Ìä∏Î•º Ïû¨Í∞úÌï©ÎãàÎã§', 'success');
                startTestTimer();
            }
        }

        // ÌÖåÏä§Ìä∏ ÌÜµÍ≥Ñ ÏóÖÎç∞Ïù¥Ìä∏
        function updateTestStats() {
            document.getElementById('testProgress').textContent = 
                `${currentTestIndex + 1}/${testQuestions.length}`;
            
            const correctCount = testAnswers.filter(a => a.correct).length;
            const accuracy = testAnswers.length > 0 ? 
                Math.round((correctCount / testAnswers.length) * 100) : 0;
            document.getElementById('currentAccuracy').textContent = accuracy + '%';
        }

        // ÌÖåÏä§Ìä∏ Î¨∏Ï†ú ÌëúÏãú
        function showCurrentTestQuestion() {
            if (isTestPaused || currentTestIndex >= testQuestions.length) return;
            
            const question = testQuestions[currentTestIndex];
            const allWords = currentVocab.words;
            
            // Ïπ¥Îìú Ï¥àÍ∏∞Ìôî
            document.getElementById('questionCard').className = 'question-card';
            
            // Î¨∏Ï†ú ÌëúÏãú
            document.getElementById('questionWord').textContent = question.word;
            document.getElementById('questionExample').textContent = question.example;
            document.getElementById('questionExample').style.display = 'none';
            document.getElementById('questionExampleMeaning').textContent = question.exampleMeaning || '';
            document.getElementById('questionExampleMeaning').style.display = 'none';
            
            // ÏòàÎ¨∏ Ï¥àÍ∏∞Ìôî (show ÌÅ¥ÎûòÏä§ Ï†úÍ±∞)
            document.getElementById('questionExample').classList.remove('show');
            document.getElementById('questionExampleMeaning').classList.remove('show');

            // ÏßÑÌñâÎ•† ÌëúÏãú
            updateTestStats();
            
            // ÏÑ†ÌÉùÏßÄ ÏÉùÏÑ±
            const options = generateOptions(question, allWords);
            displayOptions(options, question.meaning);
            
            // ÌÉÄÏù¥Î®∏ Ï¶âÏãú ÏãúÏûë (TTSÏôÄ Í¥ÄÍ≥ÑÏóÜÏù¥)
            if (!isTestPaused) {
                startTestTimer();
            }
            
            // TTSÎäî ÎπÑÎèôÍ∏∞Î°ú Ïã§Ìñâ (Í∏∞Îã§Î¶¨ÏßÄ ÏïäÏùå)
            if (appData.globalSettings.testWordTTS && selectedVoice) {
                // waitingForTTS Ï†úÍ±∞ - Îçî Ïù¥ÏÉÅ Í∏∞Îã§Î¶¨ÏßÄ ÏïäÏùå
                speakTextAsync(question.word);
            }
            
            saveProgress();
        }
        
        // TTS ÎπÑÎèôÍ∏∞ Ïû¨ÏÉù (ÏΩúÎ∞± ÏóÜÏù¥)
        function speakTextAsync(text) {
            if (!selectedVoice || !text) return;
            
            try {
                // Í∏∞Ï°¥ ÏùåÏÑ± Ï§ëÎã®
                speechSynthesis.cancel();
                isSpeaking = false;
                
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.voice = selectedVoice;
                utterance.rate = 0.9;
                utterance.pitch = 1.0;
                utterance.volume = 1.0;
                
                currentUtterance = utterance;
                
                utterance.onstart = () => {
                    isSpeaking = true;
                };
                
                utterance.onend = () => {
                    isSpeaking = false;
                    currentUtterance = null;
                };
                
                utterance.onerror = (e) => {
                    console.warn('TTS Ïò§Î•ò:', e);
                    isSpeaking = false;
                    currentUtterance = null;
                };
                
                speechSynthesis.speak(utterance);
            } catch (error) {
                console.error('TTS Ïû¨ÏÉù Ïã§Ìå®:', error);
                isSpeaking = false;
            }
        }

        // ÏÑ†ÌÉùÏßÄ ÏÉùÏÑ± - Î¨¥ÌïúÎ£®ÌîÑ Î∞©ÏßÄ Í∞úÏÑ†
        function generateOptions(correctAnswer, allWords) {
            const options = [correctAnswer.meaning];
            
            // Ï†ÑÏ≤¥ Îã®Ïñ¥Í∞Ä ÎßéÏùÑ Îïå ÏÉòÌîåÎßÅÏúºÎ°ú Î©îÎ™®Î¶¨ Ï†àÏïΩ
            let candidateWords;
            if (allWords.length > 100) {
                // 100Í∞ú Ïù¥ÏÉÅÏù¥Î©¥ ÎûúÎç§ÌïòÍ≤å 50Í∞úÎßå ÏÉòÌîåÎßÅ
                const shuffled = [];
                const sampleSize = Math.min(50, allWords.length);
                const usedIndices = new Set();
                
                while (shuffled.length < sampleSize) {
                    const idx = Math.floor(Math.random() * allWords.length);
                    if (!usedIndices.has(idx) && allWords[idx].meaning !== correctAnswer.meaning) {
                        usedIndices.add(idx);
                        shuffled.push(allWords[idx]);
                    }
                }
                candidateWords = shuffled;
            } else {
                candidateWords = allWords.filter(w => w.meaning !== correctAnswer.meaning);
            }
            
            // ÏµúÎåÄ 6Í∞úÏùò ÏÑ†ÌÉùÏßÄ
            const maxOptions = Math.min(6, candidateWords.length + 1);
            let attempts = 0;
            const maxAttempts = candidateWords.length * 2; // Î¨¥ÌïúÎ£®ÌîÑ Î∞©ÏßÄ
            
            while (options.length < maxOptions && candidateWords.length > 0 && attempts < maxAttempts) {
                attempts++;
                const randomIndex = Math.floor(Math.random() * candidateWords.length);
                const randomWord = candidateWords.splice(randomIndex, 1)[0];
                
                if (!options.includes(randomWord.meaning)) {
                    options.push(randomWord.meaning);
                }
                
                // Îçî Ïù¥ÏÉÅ ÌõÑÎ≥¥Í∞Ä ÏóÜÏúºÎ©¥ Ï¢ÖÎ£å
                if (candidateWords.length === 0) {
                    break;
                }
            }
            
            // ÏµúÏÜå 2Í∞úÏùò ÏÑ†ÌÉùÏßÄÎäî Î≥¥Ïû•
            if (options.length < 2) {
                console.warn('ÏÑ†ÌÉùÏßÄÍ∞Ä Î∂ÄÏ°±Ìï©ÎãàÎã§. ÏµúÏÜå 2Í∞úÎ•º Î≥¥Ïû•ÌïòÏßÄ Î™ªÌñàÏäµÎãàÎã§.');
                if (options.length === 1) {
                    options.push('Í∏∞ÌÉÄ');
                }
            }
            
            return options.sort(() => Math.random() - 0.5);
        }

        // ÏÑ†ÌÉùÏßÄ ÌëúÏãú
        function displayOptions(options, correctAnswer) {
            const optionsGrid = document.getElementById('optionsGrid');
            optionsGrid.innerHTML = '';
            
            options.forEach(option => {
                const button = document.createElement('button');
                button.className = 'option-btn';
                button.textContent = option;
                button.onclick = () => selectOption(button, option, correctAnswer);
                optionsGrid.appendChild(button);
            });
        }

        // ÏÑ†ÌÉùÏßÄ ÏÑ†ÌÉù
        function selectOption(button, selected, correct) {
            if (!isTestMode || isTestPaused) return;
            
            // ÌòÑÏû¨ Ïû¨ÏÉù Ï§ëÏù∏ ÏùåÏÑ± Ï¶âÏãú Ï§ëÎã®
            speechSynthesis.cancel();
            isSpeaking = false;
            
            // ÌÉÄÏù¥Î®∏ Ï†ïÎ¶¨
            if (testTimer) {
                clearTimeout(testTimer);
                testTimer = null;
            }
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            
            const isCorrect = selected === correct;
            const currentWord = testQuestions[currentTestIndex];
            
            // Î™®Îì† Î≤ÑÌäº ÎπÑÌôúÏÑ±Ìôî
            document.querySelectorAll('.option-btn').forEach(btn => {
                btn.style.pointerEvents = 'none';
                if (btn.textContent === correct) {
                    btn.classList.add('correct');
                    // Ï†ïÎãµ Î≤ÑÌäºÏóê ÌååÌã∞ÌÅ¥ Ìö®Í≥º Ï∂îÍ∞Ä
                    createParticles(btn);
                } else if (btn === button && !isCorrect) {
                    btn.classList.add('incorrect');
                }
            });
            
            // Ïπ¥Îìú Î∞∞Í≤ΩÏÉâ Î≥ÄÍ≤Ω
            const questionCard = document.getElementById('questionCard');
            if (isCorrect) {
                questionCard.classList.add('correct');
            } else {
                questionCard.classList.add('incorrect');
            }
            
            // ÏòàÎ¨∏ ÌëúÏãú
            const exampleElement = document.getElementById('questionExample');
            const exampleMeaningElement = document.getElementById('questionExampleMeaning');
            
            if (exampleElement) {
                exampleElement.style.display = 'block';
                setTimeout(() => {
                    exampleElement.classList.add('show');
                }, 10);
            }
            
            if (currentWord.exampleMeaning && exampleMeaningElement) {
                exampleMeaningElement.style.display = 'block';
                setTimeout(() => {
                    exampleMeaningElement.classList.add('show');
                }, 10);
            }
            
            // ÎãµÏïà Í∏∞Î°ù
            testAnswers.push({
                word: currentWord,
                correct: isCorrect,
                selected: selected
            });
            
            // Îã®Ïñ¥ ÌÜµÍ≥Ñ ÏóÖÎç∞Ïù¥Ìä∏
            updateWordStats(currentWord, isCorrect);
            
            // ÌÖåÏä§Ìä∏ ÌÜµÍ≥Ñ Ï¶âÏãú ÏóÖÎç∞Ïù¥Ìä∏
            updateTestStats();
            
            // ÌîºÎìúÎ∞± (ÏãúÍ∞ÅÏ†Å Ìö®Í≥ºÎßå)
            if (isCorrect) {
                createSuccessSparkles();
                vibrate([100, 50, 100]);
            } else {
                document.getElementById('questionCard').classList.add('shake');
                setTimeout(() => {
                    document.getElementById('questionCard').classList.remove('shake');
                }, 500);
                vibrate([200]);
            }
            
            // Îãµ ÏÑ†ÌÉù ÌõÑ ÏòàÎ¨∏ ÏùΩÍ∏∞ (ÎπÑÎèôÍ∏∞)
            if (appData.globalSettings.testAnswerTTS && selectedVoice && currentWord.example) {
                speakTextAsync(currentWord.example);
            }
            
            // Îã§Ïùå Î¨∏Ï†úÎ°ú Ïù¥Îèô (ÏùåÏÑ±Í≥º Í¥ÄÍ≥ÑÏóÜÏù¥)
            setTimeout(() => {
                if (isTestMode && !isTestPaused) {
                    nextTestQuestion();
                }
            }, isCorrect ? 1500 : 3000);
        }

        // ÌååÌã∞ÌÅ¥ Ìö®Í≥º ÏÉùÏÑ±
        function createParticles(element) {
            const rect = element.getBoundingClientRect();
            const centerX = rect.left + rect.width / 2;
            const centerY = rect.top + rect.height / 2;
            
            // Î™®Îì† ÌååÌã∞ÌÅ¥ÏùÑ Ï†ÄÏû•Ìï† Î∞∞Ïó¥
            const particles = [];
            
            // ÌååÌã∞ÌÅ¥ 50Í∞úÎ°ú Ï§ÑÏûÑ
            for (let i = 0; i < 50; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                
                const angle = (i / 50) * Math.PI * 2;
                const distance = 50 + Math.random() * 300;
                const tx = Math.cos(angle) * distance;
                const ty = Math.sin(angle) * distance;
                
                particle.style.left = centerX + 'px';
                particle.style.top = centerY + 'px';
                particle.style.setProperty('--tx', tx + 'px');
                particle.style.setProperty('--ty', ty + 'px');
                
                // Î≥ÑÎπõ ÏÉâÏÉÅ (Ìù∞ÏÉâ, Ïó∞ÎÖ∏Îûë, Ïó∞ÌååÎûë Í≥ÑÏó¥)
                const colors = ['#ffffff', '#fffacd', '#f0f8ff', '#fafad2', '#e6e6fa', '#fff8dc'];
                const color = colors[Math.floor(Math.random() * colors.length)];
                particle.style.background = color;
                
                // Î≥ÑÎπõÏ≤òÎüº ÎπõÎÇòÎäî Ìö®Í≥º Ï∂îÍ∞Ä
                particle.style.boxShadow = `
                    0 0 ${4 + Math.random() * 4}px ${color},
                    0 0 ${8 + Math.random() * 8}px ${color},
                    0 0 ${12 + Math.random() * 12}px ${color},
                    0 0 ${16 + Math.random() * 16}px rgba(255, 255, 255, 0.8)
                `;
                
                // ÌÅ¨Í∏∞Î•º Îçî ÏûëÍ≤å (Î≥ÑÏ≤òÎüº)
                const size = 2 + Math.random() * 4;
                particle.style.width = size + 'px';
                particle.style.height = size + 'px';
                
                // Ìà¨Î™ÖÎèÑ ÎûúÎç§
                particle.style.opacity = 0.6 + Math.random() * 0.4;
                
                // Î∞∞Ïó¥Ïóê Ï†ÄÏû•
                particles.push(particle);
            }
            
            // Î™®Îì† ÌååÌã∞ÌÅ¥ÏùÑ ÎèôÏãúÏóê DOMÏóê Ï∂îÍ∞ÄÌïòÍ≥† Ïï†ÎãàÎ©îÏù¥ÏÖò ÏãúÏûë
            particles.forEach((particle) => {
                document.body.appendChild(particle);
                cleanupList.push(particle);
                
                // cleanupList ÌÅ¨Í∏∞ Ï†úÌïú (ÏµúÎåÄ 100Í∞ú)
                if (cleanupList.length > 100) {
                    const oldElement = cleanupList.shift();
                    if (oldElement && oldElement.parentNode) {
                        oldElement.parentNode.removeChild(oldElement);
                    }
                }
                
                // Ïï†ÎãàÎ©îÏù¥ÏÖò ÏãúÏûë
                requestAnimationFrame(() => {
                    particle.style.animation = 'particleAnimation 1s ease-out forwards';
                });
                
                // 1Ï¥à ÌõÑ Ï†úÍ±∞
                setTimeout(() => {
                    if (particle.parentNode) {
                        document.body.removeChild(particle);
                    }
                    const index = cleanupList.indexOf(particle);
                    if (index > -1) {
                        cleanupList.splice(index, 1);
                    }
                }, 1000);
            });
        }
        // ÌÖåÏä§Ìä∏ ÌÉÄÏù¥Î®∏ ÏãúÏûë - Í∞úÏÑ†Îêú Î≤ÑÏ†Ñ
        function startTestTimer() {
            if (testTimer) {
                clearTimeout(testTimer);
                testTimer = null;
            }
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            
            let timeLeft = 10;
            const timerFill = document.getElementById('timerFill');
            timerFill.style.width = '100%';
            
            timerInterval = setInterval(() => {
                if (isTestPaused) return;
                
                timeLeft--;
                const percentage = (timeLeft / 10) * 100;
                timerFill.style.width = percentage + '%';
                
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    timerInterval = null;
                    if (isTestMode && !isTestPaused) {  // waitingForTTS Ï†úÍ±∞
                        selectDontKnow();
                    }
                }
            }, 1000);
            
            testTimer = setTimeout(() => {
                if (timerInterval) {
                    clearInterval(timerInterval);
                    timerInterval = null;
                }
            }, 10000);
        }

        // Î™®Î•¥Í≤†Ïñ¥Ïöî ÏÑ†ÌÉù
        function selectDontKnow() {
            if (!isTestMode || isTestPaused) return;
            
            // ÌòÑÏû¨ Ïû¨ÏÉù Ï§ëÏù∏ ÏùåÏÑ± Ï¶âÏãú Ï§ëÎã®
            speechSynthesis.cancel();
            isSpeaking = false;
            
            // ÌÉÄÏù¥Î®∏ Ï†ïÎ¶¨
            if (testTimer) {
                clearTimeout(testTimer);
                testTimer = null;
            }
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            
            const currentWord = testQuestions[currentTestIndex];
            const correct = currentWord.meaning;
            
            // Ï†ïÎãµ ÌëúÏãú
            document.querySelectorAll('.option-btn').forEach(btn => {
                btn.style.pointerEvents = 'none';
                if (btn.textContent === correct) {
                    btn.classList.add('correct');
                    createParticles(btn);
                }
            });
            
            // Ïπ¥Îìú Î∞∞Í≤ΩÏÉâ Î≥ÄÍ≤Ω
            document.getElementById('questionCard').classList.add('incorrect');
            
            // ÏòàÎ¨∏ ÌëúÏãú
            const exampleElement = document.getElementById('questionExample');
            const exampleMeaningElement = document.getElementById('questionExampleMeaning');
            
            if (exampleElement) {
                exampleElement.style.display = 'block';
                setTimeout(() => {
                    exampleElement.classList.add('show');
                }, 10);
            }
            
            if (currentWord.exampleMeaning && exampleMeaningElement) {
                exampleMeaningElement.style.display = 'block';
                setTimeout(() => {
                    exampleMeaningElement.classList.add('show');
                }, 10);
            }
            
            // ÎãµÏïà Í∏∞Î°ù
            testAnswers.push({
                word: currentWord,
                correct: false,
                selected: 'Î™®Î•¥Í≤†Ïùå'
            });
            
            // Îã®Ïñ¥ ÌÜµÍ≥Ñ ÏóÖÎç∞Ïù¥Ìä∏
            updateWordStats(currentWord, false);
            
            // ÌÖåÏä§Ìä∏ ÌÜµÍ≥Ñ Ï¶âÏãú ÏóÖÎç∞Ïù¥Ìä∏
            updateTestStats();
            
            // Îãµ ÏÑ†ÌÉù ÌõÑ ÏòàÎ¨∏ ÏùΩÍ∏∞ (ÎπÑÎèôÍ∏∞)
            if (appData.globalSettings.testAnswerTTS && selectedVoice && currentWord.example) {
                speakTextAsync(currentWord.example);
            }
            
            // Îã§Ïùå Î¨∏Ï†úÎ°ú Ïù¥Îèô (ÏùåÏÑ±Í≥º Í¥ÄÍ≥ÑÏóÜÏù¥)
            setTimeout(() => {
                if (isTestMode && !isTestPaused) {
                    nextTestQuestion();
                }
            }, 3000);
        }

        // Îã§Ïùå ÌÖåÏä§Ìä∏ Î¨∏Ï†ú
        function nextTestQuestion() {
            currentTestIndex++;
            
            if (currentTestIndex >= testQuestions.length) {
                finishTest();
                return;
            }
            
            showCurrentTestQuestion();
        }

        // ÌÖåÏä§Ìä∏ ÏôÑÎ£å
        // ÌÖåÏä§Ìä∏ ÏôÑÎ£å
        function finishTest() {
            const correctCount = testAnswers.filter(a => a.correct).length;
            const accuracy = Math.round((correctCount / testAnswers.length) * 100);
            
            // Ï±ïÌÑ∞ Ï†ïÌôïÎèÑ ÏóÖÎç∞Ïù¥Ìä∏
            currentVocab.chapters[currentChapter].accuracy = accuracy;
            currentVocab.chapters[currentChapter].completedCount++;
            
            // Î≥Ñ Í≥ÑÏÇ∞
            let stars = 1;
            if (accuracy >= 70) stars = 2;
            if (accuracy >= 90) stars = 3;
            
            // ÌòÑÏû¨ Î≥ÑÎ≥¥Îã§ ÎÜíÏúºÎ©¥ ÏóÖÎç∞Ïù¥Ìä∏
            if (stars > currentVocab.chapters[currentChapter].stars) {
                currentVocab.chapters[currentChapter].stars = stars;
            }
            
            // 100Ï†ê Ï≤òÎ¶¨
            if (accuracy === 100) {
                currentVocab.chapters[currentChapter].perfectScore = true;
            }
            
            updateStats();
            displayChapters();
            autoSave();
            
            // ÌÖåÏä§Ìä∏ ÏßÑÌñâÏÉÅÌô© Ï¥àÍ∏∞Ìôî
            currentVocab.testProgress = {
                chapterIndex: -1,
                currentIndex: 0,
                answers: [],
                questions: []
            };
            
            // ÏÉàÎ°úÏö¥ Î≥Ñ Ìö®Í≥º ÌëúÏãú
            showStarEffect(accuracy);
            
            setTimeout(() => {
                exitTestMode();
                showFeedback(`ÌÖåÏä§Ìä∏ ÏôÑÎ£å! Ï†ïÌôïÎèÑ: ${accuracy}% (${stars}‚≠ê)`, 'success');
                
                // ÌÖåÏä§Ìä∏ Î™®ÎìúÍ∞Ä ÏÇ¨ÎùºÏßà Îïå Î≥ÑÎèÑ Ìï®Íªò Ï†úÍ±∞
                document.querySelectorAll('.flying-star, .shockwave').forEach(el => el.remove());
                
                // ÏïΩÌïúÎã®Ïñ¥ Í∂åÏû• ÌôïÏù∏
                checkWeakWordsRecommendation();
            }, 3000); // Î≥Ñ Ìö®Í≥ºÎ•º Î≥¥Í∏∞ ÏúÑÌï¥ 3Ï¥àÎ°ú Ï¶ùÍ∞Ä
        }
        // ÏÉàÎ°úÏö¥ Î≥Ñ Ìö®Í≥º Ìï®Ïàò
        // ÏÉàÎ°úÏö¥ Î≥Ñ Ìö®Í≥º Ìï®Ïàò
        function showStarEffect(accuracy) {
            const centerX = window.innerWidth / 2;
            const centerY = window.innerHeight / 2;
            
            // Í∏∞Ï°¥ Î≥ÑÎì§ Ï†úÍ±∞
            document.querySelectorAll('.flying-star, .shockwave').forEach(el => el.remove());
            
            let count = 1;
            let isRainbow = false;
            
            if (accuracy === 100) {
                count = 3;
                isRainbow = true;
            } else if (accuracy >= 90) {
                count = 3;
            } else if (accuracy >= 70) {
                count = 2;
            }
            
            let starsCreated = 0;
            
            for (let i = 0; i < count; i++) {
                setTimeout(() => {
                    // Î≥Ñ ÏÉùÏÑ±
                    const star = document.createElement('div');
                    star.className = 'flying-star';
                    
                    if (isRainbow) {
                        star.innerHTML = '<span class="rainbow-star">‚≠ê</span>';
                    } else {
                        star.textContent = '‚≠ê';
                    }
                    
                    // ÏúÑÏπò ÏÑ§Ï†ï
                    star.style.left = centerX + 'px';
                    star.style.top = centerY + 'px';
                    
                    // Ïï†ÎãàÎ©îÏù¥ÏÖò ÌÅ¥ÎûòÏä§ Ï∂îÍ∞Ä
                    if (count === 3) {
                        // ÏÇºÍ∞ÅÌòï Î∞∞Ïπò
                        if (i === 0) star.classList.add('triangle-top');
                        else if (i === 1) star.classList.add('triangle-left');
                        else star.classList.add('triangle-right');
                    } else if (count === 2) {
                        // ÎÇòÎûÄÌûà Î∞∞Ïπò
                        if (i === 0) star.classList.add('line-left');
                        else star.classList.add('line-right');
                    } else {
                        // Ï§ëÏïô Î∞∞Ïπò
                        star.classList.add('single-star');
                    }
                    
                    document.body.appendChild(star);
                    cleanupList.push(star);
                    
                    starsCreated++;
                    
                    // ÎßàÏßÄÎßâ Î≥ÑÏù¥ ÎèÑÏ∞©Ìïú ÌõÑÏóêÎßå Ï∂©Í≤© Ìö®Í≥º Ïã§Ìñâ
                    if (starsCreated === count) {
                        setTimeout(() => {
                            // Î™®Îì† Î≥ÑÏóê ÎåÄÌïú Ï∂©Í≤©Ìåå ÏÉùÏÑ±
                            for (let j = 0; j < count; j++) {
                                // Î≥ÑÏùò ÏµúÏ¢Ö ÏúÑÏπò Í≥ÑÏÇ∞
                                let finalX = centerX;
                                let finalY = centerY;
                                
                                if (count === 3) {
                                    if (j === 0) finalY -= 70;
                                    else if (j === 1) { finalX -= 70; finalY += 70; }
                                    else { finalX += 70; finalY += 70; }
                                } else if (count === 2) {
                                    if (j === 0) finalX -= 60;
                                    else finalX += 60;
                                }
                                
                                // Ï∂©Í≤©Ìåå
                                const shockwave = document.createElement('div');
                                shockwave.className = 'shockwave';
                                shockwave.style.left = finalX + 'px';
                                shockwave.style.top = finalY + 'px';
                                document.body.appendChild(shockwave);
                                
                                // Ìö®Í≥º Ï†úÍ±∞
                                setTimeout(() => {
                                    shockwave.remove();
                                }, 800);
                            }
                            
                            // ÌôîÎ©¥ ÌùîÎì§Î¶º Ìö®Í≥º - ÌòÑÏû¨ Î≥¥Ïù¥Îäî question-cardÏóê Ï†ÅÏö©
                            const questionCard = document.querySelector('#questionCard');
                            if (questionCard) {
                                questionCard.style.animation = 'screenShake 0.5s ease-in-out';
                                setTimeout(() => {
                                    questionCard.style.animation = '';
                                }, 500);
                            }
                        }, 1200); // Î≥Ñ Ïï†ÎãàÎ©îÏù¥ÏÖòÏù¥ ÎÅùÎÇòÎäî ÏãúÍ∞Ñ
                    }
                    
                }, i * 300);
            }
        }
        // 100Ï†ê Ìö®Í≥º
        function showPerfectScore() {
            const starElement = document.createElement('div');
            starElement.className = 'perfect-star-animation';
            starElement.innerHTML = '<span class="rainbow-star">‚≠ê</span><span class="rainbow-star">‚≠ê</span><span class="rainbow-star">‚≠ê</span>';
            document.body.appendChild(starElement);
            cleanupList.push(starElement);

            // cleanupList ÌÅ¨Í∏∞ Ï†úÌïú (ÏµúÎåÄ 100Í∞ú)
            if (cleanupList.length > 100) {
                const oldElement = cleanupList.shift();
                if (oldElement && oldElement.parentNode) {
                    oldElement.parentNode.removeChild(oldElement);
                }
            }
            
            // Ìè≠Ï£Ω Ìö®Í≥º
            for (let i = 0; i < 100; i++) {
                // setTimeout ÏûêÏ≤¥Î•º Ï†úÍ±∞ÌïòÍ≥† Î∞îÎ°ú ÏÉùÏÑ±
                const particle = document.createElement('div');
                particle.className = 'particle';

                const angle = (i / 20) * Math.PI * 2;
                const distance = 50 + Math.random() * 100;
                const tx = Math.cos(angle) * distance;
                const ty = Math.sin(angle) * distance;

                particle.style.left = centerX + 'px';
                particle.style.top = centerY + 'px';
                particle.style.setProperty('--tx', tx + 'px');
                particle.style.setProperty('--ty', ty + 'px');

                // Î∞ùÏùÄ ÏÉâÏÉÅ
                const colors = ['#ffd700', '#ff69b4', '#87ceeb', '#98fb98', '#ffa500', '#ff6347', '#40e0d0', '#ee82ee'];
                particle.style.background = colors[Math.floor(Math.random() * colors.length)];

                document.body.appendChild(particle);
                cleanupList.push(particle);

                // cleanupList ÌÅ¨Í∏∞ Ï†úÌïú
                if (cleanupList.length > 100) {
                    const oldElement = cleanupList.shift();
                    if (oldElement && oldElement.parentNode) {
                        oldElement.parentNode.removeChild(oldElement);
                    }
                }

                // 1Ï¥à ÌõÑ Ï†úÍ±∞
                setTimeout(() => {
                    if (particle.parentNode) {
                        document.body.removeChild(particle);
                    }
                    const index = cleanupList.indexOf(particle);
                    if (index > -1) {
                        cleanupList.splice(index, 1);
                    }
                }, 1000);
            }
        }    
        // Î≥Ñ Ïï†ÎãàÎ©îÏù¥ÏÖò
        function showStarAnimation(starCount) {
            const starElement = document.createElement('div');
            starElement.className = 'star-animation';
            starElement.textContent = '‚≠ê'.repeat(starCount);
            document.body.appendChild(starElement);
            cleanupList.push(starElement);

            // cleanupList ÌÅ¨Í∏∞ Ï†úÌïú (ÏµúÎåÄ 100Í∞ú)
            if (cleanupList.length > 100) {
                const oldElement = cleanupList.shift();
                if (oldElement && oldElement.parentNode) {
                    oldElement.parentNode.removeChild(oldElement);
                }
            }
            
            setTimeout(() => {
                if (starElement.parentNode) {
                    document.body.removeChild(starElement);
                }
                const index = cleanupList.indexOf(starElement);
                if (index > -1) {
                    cleanupList.splice(index, 1);
                }
            }, 2000);
        }

        // ÌÖåÏä§Ìä∏ Î™®Îìú Ï¢ÖÎ£å - ÏßÑÌñâÏÉÅÌô© Ïú†ÏßÄ (ÏôÑÎ£åÎêú Í≤ΩÏö∞Îßå Ï¥àÍ∏∞Ìôî)
        function exitTestMode() {
            // ÌÉÄÏù¥Î®∏ Ï†ïÎ¶¨
            if (testTimer) {
                clearTimeout(testTimer);
                testTimer = null;
            }
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            
            speechSynthesis.cancel();
            isTestMode = false;
            isTestPaused = false;
            
            document.getElementById('testMode').style.display = 'none';
            document.getElementById('timerFill').style.width = '100%';
            
            // ÌÖåÏä§Ìä∏Í∞Ä ÏôÑÎ£åÎêòÏßÄ ÏïäÏùÄ Í≤ΩÏö∞ ÏßÑÌñâÏÉÅÌô© Ïú†ÏßÄ
            if (currentTestIndex < testQuestions.length) {
                saveProgress();
            }
            
            // Ï†ÑÏó≠ Î≥ÄÏàòÎßå Ï¥àÍ∏∞Ìôî (ÏßÑÌñâÏÉÅÌô©ÏùÄ Ïú†ÏßÄ)
            currentTestIndex = 0;
            testAnswers = [];
            testQuestions = [];
        }

        // Îã®Ïñ¥ ÌÜµÍ≥Ñ ÏóÖÎç∞Ïù¥Ìä∏
        function updateWordStats(word, isCorrect) {
            const wordIndex = currentVocab.words.findIndex(w => w.word === word.word);
            if (wordIndex === -1) return;
            
            const wordStats = currentVocab.words[wordIndex];
            wordStats.totalAttempts++;
            currentVocab.statistics.totalAttempts++;
            
            // ÏµúÍ∑º ÎßûÏ∂ò Îã®Ïñ¥ ÏóÖÎç∞Ïù¥Ìä∏
            wordStats.lastCorrect = isCorrect;
            
            if (isCorrect) {
                wordStats.correctCount++;
                wordStats.consecutiveCorrect++;
                currentVocab.statistics.totalCorrect++;
                
                // ÏïΩÌï®ÎèÑ Í∞êÏÜå
                if (wordStats.weakness > 0) {
                    let reduction = 15;
                    if (wordStats.consecutiveCorrect >= 3) {
                        reduction += (wordStats.consecutiveCorrect - 2) * 5;
                    }
                    wordStats.weakness = Math.max(0, wordStats.weakness - reduction);
                }
            } else {
                wordStats.consecutiveCorrect = 0;
                
                // ÏïΩÌï®ÎèÑ Ï¶ùÍ∞Ä
                if (wordStats.weakness === 0) {
                    wordStats.weakness = 45; // Ï≤´ Î≤àÏß∏ Ïã§Ïàò
                } else {
                    // Ïó∞ÏÜç Ïò§Îãµ ÌéòÎÑêÌã∞
                    const consecutiveWrong = wordStats.totalAttempts - wordStats.correctCount;
                    let penalty = 15;
                    if (consecutiveWrong >= 2) penalty = 30;
                    if (consecutiveWrong >= 3) penalty = 45;
                    
                    wordStats.weakness = Math.min(100, wordStats.weakness + penalty);
                }
            }
            
            updateWeakWordsList();
            updateStats();
            updateStarsForMastery();
            autoSave();
        }

        // ÏïΩÌïúÎã®Ïñ¥ Í∂åÏû• ÌôïÏù∏
        function checkWeakWordsRecommendation() {
            if (!currentVocab) return;
            
            const weakWords = currentVocab.words.filter(w => w.weakness >= 40);
            
            if (weakWords.length >= 10 + currentVocab.weakWordsRecommendCount) {
                document.getElementById('weakWordsRecommendModal').style.display = 'flex';
            }
        }

        // ÏïΩÌïúÎã®Ïñ¥ Í∂åÏû• ÏàòÎùΩ
        function acceptWeakWordsRecommend() {
            document.getElementById('weakWordsRecommendModal').style.display = 'none';
            currentVocab.weakWordsRecommendCount = currentVocab.words.filter(w => w.weakness >= 40).length;
            showFocusModal();
        }

        // ÏïΩÌïúÎã®Ïñ¥ Í∂åÏû• Í±∞Ï†à
        function rejectWeakWordsRecommend() {
            document.getElementById('weakWordsRecommendModal').style.display = 'none';
            currentVocab.weakWordsRecommendCount = currentVocab.words.filter(w => w.weakness >= 40).length - 1;
        }
        // Î≥Ñ ÏóÖÎç∞Ïù¥Ìä∏ Î∞è ÎßàÏä§ÌÑ∞ Îã®Ïñ¥ Ï≤¥ÌÅ¨
        function updateStarsForMastery() {
            if (!currentVocab) return;
            
            currentVocab.words.forEach(word => {
                // ÎßàÏä§ÌÑ∞ Ï°∞Í±¥: weaknessÍ∞Ä 0Ïù¥Í≥† correctCountÍ∞Ä 3 Ïù¥ÏÉÅ
                if (word.weakness === 0 && word.correctCount >= 3) {
                    // Ï†ÑÏó≠ ÎßàÏä§ÌÑ∞ Îã®Ïñ¥ Ï≤¥ÌÅ¨ (Îã®Ïñ¥ ÌÖçÏä§Ìä∏Î°ú Ï≤¥ÌÅ¨)
                    if (!appData.globalMasteredWords) {
                        appData.globalMasteredWords = {};
                    }
                    
                    const wordText = word.word.toLowerCase();
                    
                    if (!appData.globalMasteredWords[wordText]) {
                        // Ï≤òÏùå ÎßàÏä§ÌÑ∞ÌïòÎäî Îã®Ïñ¥
                        appData.globalMasteredWords[wordText] = {
                            firstMasteredDate: new Date().toISOString(),
                            vocabId: currentVocab.id
                        };
                        appData.userStars += 2;
                        
                        showFeedback(`üåü ÏÉà Îã®Ïñ¥ ÎßàÏä§ÌÑ∞! +2 Î≥Ñ ÌöçÎìù!`, 'success');
                    }
                }
            });
            
            // Î≥Ñ ÌëúÏãú ÏóÖÎç∞Ïù¥Ìä∏
            document.getElementById('userStars').textContent = `‚≠ê ${appData.userStars}`;
            autoSave();
        }
        // ÌÜµÍ≥Ñ ÏóÖÎç∞Ïù¥Ìä∏
        function updateStats() {
            if (!currentVocab) {
                document.getElementById('totalWords').textContent = '0';
                document.getElementById('weakWords').textContent = '0';
                document.getElementById('accuracy').textContent = '0%';
                return;
            }
            
            document.getElementById('totalWords').textContent = currentVocab.words.length;
            document.getElementById('weakWords').textContent = currentVocab.words.filter(w => w.weakness >= 40).length;
            
            const accuracy = currentVocab.statistics.totalAttempts > 0 ? 
                Math.round((currentVocab.statistics.totalCorrect / currentVocab.statistics.totalAttempts) * 100) : 0;
            document.getElementById('accuracy').textContent = accuracy + '%';
            document.getElementById('userStars').textContent = `‚≠ê ${appData.userStars || 1000}`;
            document.getElementById('purchaseCount').textContent = (appData.purchasedVocabs || []).length;
        }

        // ÏïΩÌïúÎã®Ïñ¥ Î™©Î°ù ÏóÖÎç∞Ïù¥Ìä∏
        function updateWeakWordsList() {
            if (!currentVocab) return;
            
            const weakWords = currentVocab.words
                .filter(w => w.weakness >= 40)
                .sort((a, b) => b.weakness - a.weakness)
                .slice(0, 20);
            
            const listElement = document.getElementById('weakWordsList');
            
            if (weakWords.length === 0) {
                listElement.innerHTML = '<div style="text-align: center; color: #6b7280; padding: 40px;">ÏïΩÌïú Îã®Ïñ¥Í∞Ä ÏóÜÏäµÎãàÎã§</div>';
                return;
            }
            
            listElement.innerHTML = '';
            
            weakWords.forEach(word => {
                const item = document.createElement('div');
                item.className = 'weak-word-item';
                
                let dangerLevel = 'üìù';
                if (word.weakness >= 80) dangerLevel = 'üî•';
                else if (word.weakness >= 60) dangerLevel = '‚ö†Ô∏è';
                
                const accuracy = word.totalAttempts > 0 ? 
                    Math.round((word.correctCount / word.totalAttempts) * 100) : 0;
                
                item.innerHTML = `
                    <div class="weak-word-info">
                        <div class="weak-word-title">${word.word} - ${word.meaning}</div>
                        <div class="weak-word-stats">
                            ${dangerLevel} Ï†ïÎãµÎ•†: ${accuracy}% (${word.totalAttempts}Ìöå ÏãúÎèÑ)
                        </div>
                    </div>
                    <div class="weak-word-score">${word.weakness}</div>
                `;
                
                listElement.appendChild(item);
            });
        }

        // ÏßëÏ§ëÌïôÏäµ Î™®Îã¨ ÌëúÏãú
        function showFocusModal() {
            if (!currentVocab) return;
            
            const weakWords = currentVocab.words.filter(w => w.weakness >= 40);
            if (weakWords.length === 0) {
                showFeedback('ÏïΩÌïú Îã®Ïñ¥Í∞Ä ÏóÜÏäµÎãàÎã§', 'error');
                return;
            }
            document.getElementById('focusModal').style.display = 'flex';
        }

        // ÏßëÏ§ëÌïôÏäµ Î™®Îã¨ Îã´Í∏∞
        function closeFocusModal() {
            document.getElementById('focusModal').style.display = 'none';
        }

        // ÏßëÏ§ëÌïôÏäµ ÏãúÏûë - Í∞úÏÑ†Îêú Î≤ÑÏ†Ñ
        function startFocusStudy() {
            closeFocusModal();
            
            const weakWords = getWeightedWeakWords();
            if (weakWords.length === 0) {
                showFeedback('ÏïΩÌïú Îã®Ïñ¥Í∞Ä ÏóÜÏäµÎãàÎã§', 'error');
                return;
            }
            
            console.log(`ÏßëÏ§ëÌïôÏäµ ÏãúÏûë: ${weakWords.length}Í∞úÏùò ÏïΩÌïú Îã®Ïñ¥`);
            
            // ÏûÑÏãú Ï±ïÌÑ∞ ÏÉùÏÑ± - ID Ïú†Ìö®ÏÑ± ÌôïÏù∏
            const validWordIds = weakWords
                .map(w => w.id)
                .filter(id => currentVocab.words.find(word => word.id === id));
            
            if (validWordIds.length === 0) {
                console.error('ÏßëÏ§ëÌïôÏäµ: Ïú†Ìö®Ìïú Îã®Ïñ¥ IDÍ∞Ä ÏóÜÏäµÎãàÎã§');
                showFeedback('ÏßëÏ§ëÌïôÏäµÌï† Îã®Ïñ¥Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§', 'error');
                return;
            }
            
            const focusChapter = {
                id: 'focus_study',
                title: 'ÏßëÏ§ëÌïôÏäµ',
                wordIds: validWordIds,
                accuracy: 0,
                stars: 0,
                completedCount: 0,
                type: 'focus',
                perfectScore: false
            };
            
            // Í∏∞Ï°¥ ÏßëÏ§ë Ï±ïÌÑ∞ Ï†úÍ±∞ ÌõÑ Ï∂îÍ∞Ä
            currentVocab.chapters = currentVocab.chapters.filter(c => c.id !== 'focus_study' && c.id !== 'focus_test');
            currentVocab.chapters.push(focusChapter);
            
            // ÏßëÏ§ëÌïôÏäµ Ï±ïÌÑ∞Í∞Ä Ï†úÎåÄÎ°ú ÏÉùÏÑ±ÎêòÏóàÎäîÏßÄ ÌôïÏù∏
            const addedChapter = currentVocab.chapters[currentVocab.chapters.length - 1];
            const chapterWords = getChapterWords(addedChapter);
            
            if (chapterWords.length === 0) {
                console.error('ÏßëÏ§ëÌïôÏäµ Ï±ïÌÑ∞Ïóê Ïú†Ìö®Ìïú Îã®Ïñ¥Í∞Ä ÏóÜÏäµÎãàÎã§');
                showFeedback('ÏßëÏ§ëÌïôÏäµÌï† Îã®Ïñ¥Î•º Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§', 'error');
                return;
            }
            
            console.log(`ÏßëÏ§ëÌïôÏäµ Ï±ïÌÑ∞ ÏÉùÏÑ± ÏôÑÎ£å: ${chapterWords.length}Í∞ú Îã®Ïñ¥`);
            
            currentStudyIndex = 0;
            startStudy(currentVocab.chapters.length - 1);
        }

        // ÏßëÏ§ëÌÖåÏä§Ìä∏ ÏãúÏûë - Í∞úÏÑ†Îêú Î≤ÑÏ†Ñ
        function startFocusTest() {
            closeFocusModal();
            
            const weakWords = getWeightedWeakWords();
            if (weakWords.length === 0) {
                showFeedback('ÏïΩÌïú Îã®Ïñ¥Í∞Ä ÏóÜÏäµÎãàÎã§', 'error');
                return;
            }
            
            console.log(`ÏßëÏ§ëÌÖåÏä§Ìä∏ ÏãúÏûë: ${weakWords.length}Í∞úÏùò ÏïΩÌïú Îã®Ïñ¥`);
            
            // ÏûÑÏãú Ï±ïÌÑ∞ ÏÉùÏÑ± - ID Ïú†Ìö®ÏÑ± ÌôïÏù∏
            const validWordIds = weakWords
                .map(w => w.id)
                .filter(id => currentVocab.words.find(word => word.id === id));
            
            if (validWordIds.length === 0) {
                console.error('ÏßëÏ§ëÌÖåÏä§Ìä∏: Ïú†Ìö®Ìïú Îã®Ïñ¥ IDÍ∞Ä ÏóÜÏäµÎãàÎã§');
                showFeedback('ÏßëÏ§ëÌÖåÏä§Ìä∏Ìï† Îã®Ïñ¥Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§', 'error');
                return;
            }
            
            const focusChapter = {
                id: 'focus_test',
                title: 'ÏßëÏ§ëÌÖåÏä§Ìä∏',
                wordIds: validWordIds,
                accuracy: 0,
                stars: 0,
                completedCount: 0,
                type: 'focus',
                perfectScore: false
            };
            
            // Í∏∞Ï°¥ ÏßëÏ§ë Ï±ïÌÑ∞ Ï†úÍ±∞ ÌõÑ Ï∂îÍ∞Ä
            currentVocab.chapters = currentVocab.chapters.filter(c => c.id !== 'focus_study' && c.id !== 'focus_test');
            currentVocab.chapters.push(focusChapter);
            
            // ÏßëÏ§ëÌÖåÏä§Ìä∏ Ï±ïÌÑ∞Í∞Ä Ï†úÎåÄÎ°ú ÏÉùÏÑ±ÎêòÏóàÎäîÏßÄ ÌôïÏù∏
            const addedChapter = currentVocab.chapters[currentVocab.chapters.length - 1];
            const chapterWords = getChapterWords(addedChapter);
            
            if (chapterWords.length === 0) {
                console.error('ÏßëÏ§ëÌÖåÏä§Ìä∏ Ï±ïÌÑ∞Ïóê Ïú†Ìö®Ìïú Îã®Ïñ¥Í∞Ä ÏóÜÏäµÎãàÎã§');
                showFeedback('ÏßëÏ§ëÌÖåÏä§Ìä∏Ìï† Îã®Ïñ¥Î•º Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§', 'error');
                return;
            }
            
            console.log(`ÏßëÏ§ëÌÖåÏä§Ìä∏ Ï±ïÌÑ∞ ÏÉùÏÑ± ÏôÑÎ£å: ${chapterWords.length}Í∞ú Îã®Ïñ¥`);
            
            startTest(currentVocab.chapters.length - 1);
        }

        // Í∞ÄÏ§ëÏπò Ï†ÅÏö©Îêú ÏïΩÌïúÎã®Ïñ¥ ÏÉùÏÑ±
        function getWeightedWeakWords() {
            const weakWords = currentVocab.words.filter(w => w.weakness >= 40);
            const weightedWords = [];
            
            weakWords.forEach(word => {
                let weight = 2; // Í∏∞Î≥∏ Ï£ºÏùò Îã®Í≥Ñ
                if (word.weakness >= 80) weight = 6; // Îß§Ïö∞ÏúÑÌóò
                else if (word.weakness >= 60) weight = 4; // ÏúÑÌóò
                
                for (let i = 0; i < weight; i++) {
                    weightedWords.push(word);
                }
            });
            
            return weightedWords.sort(() => Math.random() - 0.5);
        }

        // Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû•
        function saveData() {
            const data = {
                ...appData,
                timestamp: new Date().toISOString()
            };
            
            // JSON Î¨∏ÏûêÏó¥Î°ú Î≥ÄÌôò
            const jsonString = JSON.stringify(data, null, 2);
            
            // ÌååÏùº ÌÅ¨Í∏∞ Í≥ÑÏÇ∞
            const sizeKB = (jsonString.length / 1024).toFixed(2);
            
            // JSON ÌååÏùºÎ°ú Îã§Ïö¥Î°úÎìú
            const blob = new Blob([jsonString], {
                type: 'application/json'
            });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `word_master_backup_${new Date().toISOString().slice(0,10)}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            showFeedback(`üíæ Îç∞Ïù¥ÌÑ∞Í∞Ä Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§ (${sizeKB}KB)`, 'success');
        }

        // Î∞±ÏóÖ ÌååÏùº Î∂àÎü¨Ïò§Í∏∞
        function loadBackupData() {
            document.getElementById('backupInput').click();
        }

        // Ï¥àÍ∏∞Ìôî Î™®Îã¨ ÌëúÏãú
        function showResetModal() {
            if (!currentVocab) {
                showFeedback('Ï¥àÍ∏∞ÌôîÌï† Îã®Ïñ¥Ïû•Ïù¥ ÏóÜÏäµÎãàÎã§', 'error');
                return;
            }
            document.getElementById('resetModal').style.display = 'flex';
        }

        // Ï¥àÍ∏∞Ìôî Î™®Îã¨ Îã´Í∏∞
        function closeResetModal() {
            document.getElementById('resetModal').style.display = 'none';
        }

        // Îç∞Ïù¥ÌÑ∞ Ï¥àÍ∏∞Ìôî
        function resetData() {
            if (!currentVocab) return;
            
            // ÏßÑÌñâ Ï§ëÏù∏ ÏûëÏóÖ Ï§ëÎã®
            if (isStudyMode) exitStudyMode();
            if (isTestMode) exitTestMode();
            
            const vocabId = currentVocab.id;
            const vocabName = currentVocab.name;
            
            // ÌòÑÏû¨ Îã®Ïñ¥Ïû•Îßå Ï¥àÍ∏∞Ìôî
            currentVocab = new Vocabulary(vocabName);
            currentVocab.id = vocabId;
            appData.vocabularies[vocabId] = currentVocab;
            
            // UI Ï¥àÍ∏∞Ìôî
            updateUI();
            closeResetModal();
            autoSave();
            
            // Ï¥àÍ∏∞Ìôî ÏïåÎ¶º
            broadcastDataChange('reset', { vocabId: vocabId });
            
            showFeedback(`üóëÔ∏è '${vocabName}' Îã®Ïñ¥Ïû•Ïù¥ Ï¥àÍ∏∞ÌôîÎêòÏóàÏäµÎãàÎã§`, 'success');
        }

        // ÌîºÎìúÎ∞± ÌëúÏãú
                // GitHub Ï†ÄÏû•ÏÜå URL (Ïó¨Í∏∞Ïóê Î≥∏Ïù∏Ïùò GitHub Ï£ºÏÜåÎ•º ÎÑ£ÏúºÏÑ∏Ïöî)
        const GITHUB_VOCAB_STORE_URL = 'https://juhyeon-maker.github.io/my-vocabulary-store';

        // Ïò®ÎùºÏù∏ Îã®Ïñ¥Ïû• Ïä§ÌÜ†Ïñ¥ Îç∞Ïù¥ÌÑ∞
        let onlineVocabs = [];
        let currentCategory = 'all';

        // Ïò®ÎùºÏù∏ Îã®Ïñ¥Ïû• Ïä§ÌÜ†Ïñ¥ ÌëúÏãú
        async function showOnlineVocabStore() {
            document.getElementById('onlineVocabStoreModal').style.display = 'flex';
            
            // Î°úÎî© ÌëúÏãú
            document.getElementById('onlineVocabList').innerHTML = `
                <div style="text-align: center; color: #6b7280; padding: 40px;">
                    <div class="spinner"></div>
                    <p>Îã®Ïñ¥Ïû• Î™©Î°ùÏùÑ Î∂àÎü¨Ïò§Îäî Ï§ë...</p>
                </div>
            `;
            
            try {
                // GitHubÏóêÏÑú index.json Í∞ÄÏ†∏Ïò§Í∏∞
                const response = await fetch(`${GITHUB_VOCAB_STORE_URL}/index.json`);
                if (!response.ok) throw new Error('Failed to fetch vocabulary list');
                
                const data = await response.json();
                onlineVocabs = data.categories;
                
                // Ï†ÑÏ≤¥ Ïπ¥ÌÖåÍ≥†Î¶¨ ÌëúÏãú
                displayOnlineVocabs('all');
            } catch (error) {
                console.error('Error loading online vocabs:', error);
                document.getElementById('onlineVocabList').innerHTML = `
                    <div style="text-align: center; color: #ef4444; padding: 40px;">
                        <p>Îã®Ïñ¥Ïû• Î™©Î°ùÏùÑ Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§</p>
                        <p style="font-size: 14px; margin-top: 8px;">Ïù∏ÌÑ∞ÎÑ∑ Ïó∞Í≤∞ÏùÑ ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî</p>
                    </div>
                `;
            }
        }
        // ÏôÑÏ†Ñ Ï¥àÍ∏∞Ìôî Î™®Îã¨ 1 ÌëúÏãú
        function showCompleteResetModal() {
            document.getElementById('resetStarCount').textContent = appData.userStars;
            document.getElementById('completeResetModal1').style.display = 'flex';
        }

        // ÏôÑÏ†Ñ Ï¥àÍ∏∞Ìôî Î™®Îã¨ 1 Îã´Í∏∞
        function closeCompleteResetModal1() {
            document.getElementById('completeResetModal1').style.display = 'none';
        }

        // ÏôÑÏ†Ñ Ï¥àÍ∏∞Ìôî Î™®Îã¨ 2 ÌëúÏãú
        function showCompleteResetModal2() {
            document.getElementById('completeResetModal1').style.display = 'none';
            document.getElementById('completeResetModal2').style.display = 'flex';
        }

        // ÏôÑÏ†Ñ Ï¥àÍ∏∞Ìôî Î™®Îã¨ 2 Îã´Í∏∞
        function closeCompleteResetModal2() {
            document.getElementById('completeResetModal2').style.display = 'none';
        }

        // ÏôÑÏ†Ñ Ï¥àÍ∏∞Ìôî Ïã§Ìñâ
        async function completeReset() {
            // ÏßÑÌñâ Ï§ëÏù∏ ÏûëÏóÖ Ï§ëÎã®
            if (isStudyMode) exitStudyMode();
            if (isTestMode) exitTestMode();
            
            // Î™®Îì† Îç∞Ïù¥ÌÑ∞ Ï¥àÍ∏∞Ìôî
            appData = {
                vocabularies: {},
                currentVocabId: null,
                userStars: 1000,  // Í∏∞Î≥∏ Î≥ÑÎ°ú Ï¥àÍ∏∞Ìôî
                purchasedVocabs: [],
                globalMasteredWords: {},
                masteredWordIds: new Set(),
                globalSettings: {
                    selectedVoice: '',
                    wordTTS: true,
                    exampleTTS: false,
                    darkMode: false,
                    studySpeed: 2.8,
                    testWordTTS: true,
                    testAnswerTTS: false,
                    ttsPreload: 0,
                    visibility: {
                        word: true,
                        pronunciation: true,
                        meaning: true,
                        example: true,
                        exampleMeaning: true
                    }
                },
                version: 3
            };
            
            // Í∏∞Î≥∏ Îã®Ïñ¥Ïû• ÏÉùÏÑ±
            const defaultVocab = new Vocabulary('Í∏∞Î≥∏ Îã®Ïñ¥Ïû•');
            appData.vocabularies[defaultVocab.id] = defaultVocab;
            appData.currentVocabId = defaultVocab.id;
            currentVocab = defaultVocab;
            
            // ÏÑ§Ï†ï UI Ï¥àÍ∏∞Ìôî
            restoreGlobalSettings();
            
            // UI ÏóÖÎç∞Ïù¥Ìä∏
            updateUI();
            
            // Ï†ÄÏû•
            await autoSave();
            
            // IndexedDBÎèÑ ÏôÑÏ†ÑÌûà ÏÇ≠Ï†ú
            if (db) {
                const transaction = db.transaction(['appData'], 'readwrite');
                const store = transaction.objectStore('appData');
                await store.clear();
            }
            
            // localStorageÎèÑ ÏÇ≠Ï†ú
            localStorage.removeItem('wordMasterData');
            
            // Î™®Îã¨ Îã´Í∏∞
            closeCompleteResetModal2();
            
            // ÏôÑÎ£å Î©îÏãúÏßÄ
            showFeedback('üíÄ Î™®Îì† Îç∞Ïù¥ÌÑ∞Í∞Ä ÏôÑÏ†ÑÌûà Ï¥àÍ∏∞ÌôîÎêòÏóàÏäµÎãàÎã§', 'success');
            
            // ÌéòÏù¥ÏßÄ ÏÉàÎ°úÍ≥†Ïπ® (ÏôÑÏ†ÑÌïú Ï¥àÍ∏∞ÌôîÎ•º ÏúÑÌï¥)
            setTimeout(() => {
                location.reload();
            }, 2000);
        }
        // Ïò®ÎùºÏù∏ Îã®Ïñ¥Ïû• ÌëúÏãú
        function displayOnlineVocabs(category) {
            const listElement = document.getElementById('onlineVocabList');
            listElement.innerHTML = '';
            
            let vocabsToShow = [];
            
            if (category === 'all') {
                onlineVocabs.forEach(cat => {
                    cat.vocabularies.forEach(vocab => {
                        vocabsToShow.push({ ...vocab, categoryName: cat.name, categoryIcon: cat.icon });
                    });
                });
            } else {
                const selectedCategory = onlineVocabs.find(cat => cat.id === category);
                if (selectedCategory) {
                    selectedCategory.vocabularies.forEach(vocab => {
                        vocabsToShow.push({ ...vocab, categoryName: selectedCategory.name, categoryIcon: selectedCategory.icon });
                    });
                }
            }
            
            if (vocabsToShow.length === 0) {
                listElement.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üì≠</div>
                        <div class="empty-state-text">Ìï¥Îãπ Ïπ¥ÌÖåÍ≥†Î¶¨Ïóê Îã®Ïñ¥Ïû•Ïù¥ ÏóÜÏäµÎãàÎã§</div>
                    </div>
                `;
                return;
            }
            
            vocabsToShow.forEach(vocab => {
                const item = document.createElement('div');
                item.className = 'online-vocab-item';
                
                const isDownloaded = checkIfVocabDownloaded(vocab.id);
                
                // ÎÇúÏù¥ÎèÑÏóê Îî∞Î•∏ Î∞∞ÏßÄ ÏÉâÏÉÅ
                let badgeClass = '';
                if (vocab.difficulty === 'Ï§ëÍ∏â') badgeClass = 'intermediate';
                else if (vocab.difficulty === 'Í≥†Í∏â') badgeClass = 'advanced';
                
                item.innerHTML = `
                    ${isDownloaded ? '<div class="download-status">‚úì Îã§Ïö¥Î°úÎìúÎê®</div>' : ''}
                    <div class="online-vocab-header">
                        <div class="online-vocab-info-container">
                            <div class="online-vocab-title">
                                <span>${vocab.categoryIcon || 'üìö'}</span>
                                <span>${vocab.name}</span>
                            </div>
                            <div class="online-vocab-meta">
                                <span class="online-vocab-badge ${badgeClass}">${vocab.difficulty}</span>
                                <span class="online-vocab-badge" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);">
                                    v${vocab.version}
                                </span>
                            </div>
                            <div class="online-vocab-description">${vocab.description}</div>
                            <div class="online-vocab-stats">
                                <div class="online-vocab-stat">
                                    <span>üìù</span>
                                    <span>${vocab.wordCount}Í∞ú Îã®Ïñ¥</span>
                                </div>
                                <div class="online-vocab-stat">
                                    <span>üìÅ</span>
                                    <span>${vocab.categoryName}</span>
                                </div>
                                <div class="online-vocab-stat">
                                    <span>‚≠ê</span>
                                    <span>${vocab.price || 50}Í∞ú</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <button class="online-download-btn" onclick="downloadVocab('${vocab.url}', '${vocab.name}')" ${isDownloaded && checkIfCurrentVocabHasWords(vocab.url) ? 'disabled' : ''}>
                        ${isDownloaded ? (checkIfCurrentVocabHasWords(vocab.url) ? '‚úì Ïù¥ÎØ∏ Îã§Ïö¥Î°úÎìúÎê®' : 'üîÑ Î¨¥Î£å Ïû¨Îã§Ïö¥Î°úÎìú') : `‚≠ê ${vocab.price || 50}Í∞úÎ°ú Íµ¨Îß§`}
                    </button>
                `;
                
                listElement.appendChild(item);
            });
        }

        // Ïò®ÎùºÏù∏ Îã®Ïñ¥Ïû• Í≤ÄÏÉâ
        function searchOnlineVocabs(searchTerm) {
            const items = document.querySelectorAll('.online-vocab-item');
            items.forEach(item => {
                const title = item.querySelector('.online-vocab-title').textContent.toLowerCase();
                const description = item.querySelector('.online-vocab-description').textContent.toLowerCase();
                
                if (title.includes(searchTerm.toLowerCase()) || description.includes(searchTerm.toLowerCase())) {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        // Ïπ¥ÌÖåÍ≥†Î¶¨ ÌïÑÌÑ∞ ÏàòÏ†ï
        function filterByCategory(category) {
            currentCategory = category;
            
            // ÌÉ≠ ÌôúÏÑ±Ìôî ÏÉÅÌÉú Î≥ÄÍ≤Ω (Ïï†ÎãàÎ©îÏù¥ÏÖò Ìö®Í≥º Ï∂îÍ∞Ä)
            document.querySelectorAll('.online-category-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            const activeTab = event.target.closest('.online-category-tab');
            activeTab.classList.add('active');
            
            // ÌÅ¥Î¶≠ Ìö®Í≥º
            activeTab.style.transform = 'scale(0.95)';
            setTimeout(() => {
                activeTab.style.transform = '';
            }, 100);
            
            displayOnlineVocabs(category);
        }

        // Îã§Ïö¥Î°úÎìú Î≤ÑÌäº Ïï†ÎãàÎ©îÏù¥ÏÖò Í∞úÏÑ†
        async function downloadVocab(url, vocabName) {
            const button = event.target;
            const originalText = button.innerHTML;
            
            button.disabled = true;
            button.innerHTML = '<span style="display: inline-block; animation: spin 1s linear infinite;">‚è≥</span> Îã§Ïö¥Î°úÎìú Ï§ë...';
            
            try {
                // Íµ¨Îß§ Ïó¨Î∂Ä ÌôïÏù∏
                const vocabId = url.split('/').pop().replace('.json', '');
                const isPurchased = checkIfVocabDownloaded(vocabId);

                // Ïò®ÎùºÏù∏ Îã®Ïñ¥Ïû• Î™©Î°ùÏóêÏÑú Í∞ÄÍ≤© Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞
                let vocabPrice = 50; // Í∏∞Î≥∏Í∞í
                const onlineVocab = onlineVocabs.flatMap(cat => cat.vocabularies).find(v => v.url === url);
                if (onlineVocab && onlineVocab.price) {
                    vocabPrice = onlineVocab.price;
                }
                // Ïù¥ÎØ∏ Íµ¨Îß§Ìïú Í≤ΩÏö∞ Î¨¥Î£å
                if (!isPurchased) {
                    // Ï≤òÏùå Íµ¨Îß§ÌïòÎäî Í≤ΩÏö∞Îßå Î≥Ñ Ï≤¥ÌÅ¨
                    if (appData.userStars < vocabPrice) {
                        button.disabled = false;
                        button.innerHTML = originalText;
                        showFeedback(`‚≠ê Î≥ÑÏù¥ Î∂ÄÏ°±Ìï©ÎãàÎã§! (ÌïÑÏöî: ${vocabPrice}Í∞ú, Î≥¥Ïú†: ${appData.userStars}Í∞ú)`, 'error');
                        return;
                    }
                }
                const response = await fetch(`${GITHUB_VOCAB_STORE_URL}/${url}`);
                if (!response.ok) throw new Error('Failed to download vocabulary');
                
                const vocabData = await response.json();
                
                // Ïò®ÎùºÏù∏ Îã®Ïñ¥Ïû• Îç∞Ïù¥ÌÑ∞ ÏûÑÏãú Ï†ÄÏû•
                pendingOnlineVocabData = {
                    vocabData: vocabData,
                    vocabName: vocabName,
                    vocabId: vocabId,
                    vocabPrice: vocabPrice,
                    isPurchased: isPurchased
                };
                
                // Ìï©ÏπòÍ∏∞/ÏÉàÎ°úÎßåÎì§Í∏∞ ÏÑ†ÌÉù Î™®Îã¨ ÌëúÏãú
                document.getElementById('vocabMergeMessage').textContent = 
                    `'${vocabName}'ÏùÑ(Î•º) ÌòÑÏû¨ Îã®Ïñ¥Ïû• '${currentVocab ? currentVocab.name : 'Í∏∞Î≥∏ Îã®Ïñ¥Ïû•'}'Ïóê Ìï©ÏπòÏãúÍ≤†ÏäµÎãàÍπå?`;
                document.getElementById('vocabMergeModal').style.display = 'flex';
                
                button.disabled = false;
                button.innerHTML = originalText;
                
            } catch (error) {
                console.error('Download error:', error);
                button.disabled = false;
                button.innerHTML = originalText;
                showFeedback('Îã§Ïö¥Î°úÎìú Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§', 'error');
            }
        }        
        async function processOnlineVocab(data) {
            const { vocabData, vocabName, vocabId, vocabPrice, isPurchased } = data;
            
            // ÏÉà Îã®Ïñ¥Ïû•Ïù∏ Í≤ΩÏö∞ ÌòÑÏû¨ Îã®Ïñ¥Ïû•Ïù¥ ÎπÑÏñ¥ÏûàÏúºÎØÄÎ°ú Î∞îÎ°ú Ï∂îÍ∞Ä
            if (!shouldMergeVocab && currentVocab.words.length === 0) {
                // Í∏∞Ï°¥ ÏΩîÎìúÏôÄ ÎèôÏùºÌïòÍ≤å ÏßÑÌñâ
            }
            
            let addedCount = 0;
            vocabData.words.forEach(word => {
                const wordId = `${vocabData.id}_${word.word}_${Date.now()}_${Math.random()}`;
                
                if (!currentVocab.words.find(w => w.word === word.word)) {
                    currentVocab.words.push({
                        id: wordId,
                        word: word.word,
                        pronunciation: word.pronunciation || '',
                        meaning: word.meaning,
                        example: word.example || '',
                        exampleMeaning: word.exampleMeaning || '',
                        weakness: 0,
                        correctCount: 0,
                        totalAttempts: 0,
                        consecutiveCorrect: 0,
                        lastCorrect: false,
                        source: vocabName
                    });
                    addedCount++;
                }
            });
                
            if (addedCount > 0) {
                await createChapters();
                // Ï≤òÏùå Íµ¨Îß§ÏãúÏóêÎßå Î≥Ñ Ï∞®Í∞ê Î∞è Íµ¨Îß§ Í∏∞Î°ù
                if (!isPurchased) {
                    appData.userStars -= vocabPrice;
                    document.getElementById('userStars').textContent = `‚≠ê ${appData.userStars}`;
                    
                    // Íµ¨Îß§ Í∏∞Î°ù Ï†ÄÏû•
                    if (!appData.purchasedVocabs) {
                        appData.purchasedVocabs = [];
                    }
                    appData.purchasedVocabs.push(vocabId);
                    
                    // Íµ¨Îß§ Í∏∞Î°ù UI ÏóÖÎç∞Ïù¥Ìä∏
                    document.getElementById('purchaseCount').textContent = appData.purchasedVocabs.length;
                    
                    showFeedback(`‚ú® ${vocabName} Íµ¨Îß§ ÏôÑÎ£å! (-${vocabPrice}‚≠ê) ${addedCount}Í∞ú Îã®Ïñ¥ Ï∂îÍ∞Ä`, 'success');
                } else {
                    showFeedback(`‚ú® ${vocabName} Ïû¨Îã§Ïö¥Î°úÎìú ÏôÑÎ£å! ${addedCount}Í∞ú Îã®Ïñ¥ Ï∂îÍ∞Ä`, 'success');
                }
                
                // Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû•
                autoSave();
                updateUI();
                
                // ÏÑ±Í≥µ Ïï†ÎãàÎ©îÏù¥ÏÖò
                createSuccessSparkles();
                
            } else {
                showFeedback('Ïù¥ÎØ∏ Î™®Îì† Îã®Ïñ¥Í∞Ä Ï∂îÍ∞ÄÎêòÏñ¥ ÏûàÏäµÎãàÎã§', 'warning');
            }
        }

        function confirmVocabMerge(merge) {
            shouldMergeVocab = merge;
            document.getElementById('vocabMergeModal').style.display = 'none';
            closeOnlineVocabStore();

            if (!shouldMergeVocab) {
                // ÏÉà Îã®Ïñ¥Ïû• ÏÉùÏÑ±
                const newVocabName = pendingOnlineVocabData.vocabName;
                const newVocab = new Vocabulary(newVocabName);
                appData.vocabularies[newVocab.id] = newVocab;
                appData.currentVocabId = newVocab.id;
                currentVocab = newVocab;
                
                updateUI();
                showFeedback(`üìö ÏÉà Îã®Ïñ¥Ïû• '${newVocabName}'Ïù¥(Í∞Ä) ÏÉùÏÑ±ÎêòÏóàÏäµÎãàÎã§`, 'success');
            }
            
            // Ï±ïÌÑ∞ ÏÑ§Ï†ï Î™®Îã¨ ÌëúÏãú
            document.getElementById('chapterSettingModal').style.display = 'flex';
            document.getElementById('chapterSizeInput').value = currentVocab.settings.chapterSize;
        }

        // Îã®Ïñ¥Ïû• Îã§Ïö¥Î°úÎìú Ïó¨Î∂Ä ÌôïÏù∏
        function checkIfVocabDownloaded(vocabId) {
            // Íµ¨Îß§ Í∏∞Î°ù ÌôïÏù∏
            return appData.purchasedVocabs && appData.purchasedVocabs.includes(vocabId);
        }
        // ÌòÑÏû¨ Îã®Ïñ¥Ïû•Ïóê Ìï¥Îãπ Ïò®ÎùºÏù∏ Îã®Ïñ¥Ïû•Ïùò Îã®Ïñ¥Í∞Ä ÏûàÎäîÏßÄ ÌôïÏù∏
        function checkIfCurrentVocabHasWords(url) {
            if (!currentVocab) return false;
            const vocabId = url.split('/').pop().replace('.json', '');
            return currentVocab.words.some(word => 
                word.source && word.source.includes(vocabId)
            );
        }
        // Ïò®ÎùºÏù∏ Îã®Ïñ¥Ïû• Ïä§ÌÜ†Ïñ¥ Îã´Í∏∞
        function closeOnlineVocabStore() {
            document.getElementById('onlineVocabStoreModal').style.display = 'none';
        }
        function showFeedback(message, type) {
            const feedback = document.getElementById('feedback');
            feedback.textContent = message;
            feedback.className = `feedback ${type} show`;
            
            setTimeout(() => {
                feedback.classList.remove('show');
            }, type === 'warning' ? 3000 : 2000);
        }

        // Ï†ÑÏ≤¥ÌôîÎ©¥ ÌÜ†Í∏Ä
        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(err => {
                    console.error('Ï†ÑÏ≤¥ÌôîÎ©¥ Ï†ÑÌôò Ïã§Ìå®:', err);
                });
            } else {
                document.exitFullscreen().catch(err => {
                    console.error('Ï†ÑÏ≤¥ÌôîÎ©¥ Ï¢ÖÎ£å Ïã§Ìå®:', err);
                });
            }
        }

        // Îã§ÌÅ¨Î™®Îìú ÌÜ†Í∏Ä
        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            const toggle = document.querySelector('.dark-mode-toggle');
            toggle.textContent = document.body.classList.contains('dark-mode') ? '‚òÄÔ∏è' : 'üåô';
            appData.globalSettings.darkMode = document.body.classList.contains('dark-mode');
            autoSave();
        }

        // ÌñÖÌã± ÌîºÎìúÎ∞±
        function vibrate(pattern) {
            if ('vibrate' in navigator) {
                navigator.vibrate(pattern);
            }
        }


        // ÏÑ±Í≥µ Ïãú Î∞òÏßùÏù¥ Ìè≠Î∞ú
        function createSuccessSparkles() {
            for (let i = 0; i < 20; i++) {
                setTimeout(() => {
                    const sparkle = document.createElement('div');
                    sparkle.className = 'sparkle';
                    const container = document.querySelector('.container');
                    const rect = container.getBoundingClientRect();
                    sparkle.style.left = rect.left + rect.width / 2 + 'px';
                    sparkle.style.top = rect.top + rect.height / 2 + 'px';
                    sparkle.style.setProperty('--x', (Math.random() - 0.5) * 300 + 'px');
                    sparkle.style.setProperty('--y', (Math.random() - 0.5) * 300 + 'px');
                    sparkle.style.background = ['#667eea', '#764ba2', '#f093fb', '#10b981'][Math.floor(Math.random() * 4)];
                    sparkle.style.width = sparkle.style.height = Math.random() * 8 + 4 + 'px';
                    document.body.appendChild(sparkle);
                    cleanupList.push(sparkle);
                    
                    // cleanupList ÌÅ¨Í∏∞ Ï†úÌïú (ÏµúÎåÄ 100Í∞ú)
                    if (cleanupList.length > 100) {
                        const oldElement = cleanupList.shift();
                        if (oldElement && oldElement.parentNode) {
                            oldElement.parentNode.removeChild(oldElement);
                        }
                    }
                    setTimeout(() => {
                        if (sparkle.parentNode) {
                            document.body.removeChild(sparkle);
                        }
                        const index = cleanupList.indexOf(sparkle);
                        if (index > -1) {
                            cleanupList.splice(index, 1);
                        }
                    }, 1000);
                }, i * 50);
            }
        }
    </script>
</body>
</html>